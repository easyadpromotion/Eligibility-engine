<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Master Control</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f4f7f6; display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a237e; z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* LAYOUT */
        .sidebar { width: 260px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: #3949ab; border-left: 4px solid #ffeb3b; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* TABLES */
        .table-container { overflow-x: auto; background: white; margin-top: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 13px; white-space: nowrap; }
        th { background-color: #e8eaf6; color: #1a237e; font-weight: bold; position: sticky; top: 0; }
        
        /* BUTTONS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 12px; margin-right: 5px; }
        .btn-add { background-color: #2e7d32; } 
        .btn-del { background-color: #c62828; } 
        .btn-edit { background-color: #ffa000; color: #333; } 
        .btn-reset { background-color: #ff9800; float: right; margin-right: 10px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 0; width: 900px; border-radius: 8px; height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #1a237e; color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; }
        
        .sec-title { background: #f5f5f5; padding: 10px; font-weight: bold; margin-top: 15px; border-left: 5px solid #1a237e; color: #333; }
        .sec-content { padding: 15px; border: 1px solid #eee; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .section { display: none; } .section.active { display: block; }
        
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .hidden-field { display:none; background:#fafafa; padding:10px; border:1px dashed #ccc; margin-top:5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div id="loginOverlay"><div class="login-box"><h2>üîí Admin Access</h2><input type="password" id="adminLockPass" placeholder="Enter Password"><br><br><button class="btn btn-add" style="width:100%" onclick="checkAdminLogin()">Login</button></div></div>

<div class="sidebar">
    <h2 style="margin-bottom: 30px;">üöÄ Super Admin</h2>
    <div class="nav-item active" onclick="showSection('policies')">üìú Policy Library</div>
    <div class="nav-item" onclick="showSection('users')">üë• Manage Users</div>
    <div class="nav-item" onclick="showSection('apps')">üìÇ All Applications</div>
    <div class="nav-item" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
    <div class="nav-item" style="margin-top:auto; background:#c62828;" onclick="logout()">üö™ Logout</div>
</div>

<div class="main-content">
    
    <div id="policies" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Bank Policy Engine</h2>
            <div>
                <button class="btn btn-reset" onclick="uploadDefaultPolicies()">‚Üª Load Defaults</button>
                <button class="btn btn-add" onclick="openModal('policy')">+ Create Policy</button>
            </div>
        </div>
        <div class="table-container">
            <table id="policyTable">
                <thead><tr><th>Bank Name</th><th>Product</th><th>Loan Range</th><th>Tenure</th><th>Min ABB</th><th>ROI %</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="users" class="section">
        <h2>üë• Active DSA Users</h2>
        <div style="text-align:right; margin-bottom:10px;"><button class="btn btn-add" onclick="openModal('user')">+ Add User</button></div>
        <div class="table-container"><table id="userTable"><thead><tr><th>Name</th><th>Mobile</th><th>Username</th><th>Password</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        <h2 style="margin-top:30px;">üîî Pending Requests</h2>
        <div class="table-container"><table id="requestTable"><thead><tr><th>Name</th><th>Mobile</th><th>Username</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    </div>
    
    <div id="apps" class="section">
        <div style="display:flex; justify-content:space-between;"><h2>üìÇ Applications</h2><button class="btn btn-add" style="background:#008CBA;" onclick="exportToExcel()">‚¨á Excel</button></div>
        <div class="table-container"><table id="appTable"><thead><tr><th>Date</th><th>Customer</th><th>DSA</th><th>Status</th><th>Amount</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="settings" class="section">
        <h2>Settings</h2>
        <div style="background:white;padding:30px;border-radius:8px;max-width:400px;"><label>Change Password</label><input type="text" id="newAdminPass"><br><br><button class="btn btn-add" onclick="updateAdminPass()">Update</button></div>
    </div>
</div>

<div id="policyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="policyModalTitle">Bank Policy</h3><span style="cursor:pointer; font-size:20px;" onclick="closeModal('policy')">‚úñ</span></div>
        <div class="modal-body">
            <form id="policyForm">
                <input type="hidden" id="p_id">
                
                <div class="sec-title">SECTION A - BASIC DETAILS</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Bank Name</label><input id="bankName"></div><div><label>Product Type</label><select id="prodType"><option>STBL</option><option>HTBL</option><option>OD</option><option>TERM</option><option>NBFC</option><option>UBL</option></select></div></div>
                    <div class="form-row"><div><label>Loan Min (L)</label><input type="number" id="loanMin"></div><div><label>Loan Max (L)</label><input type="number" id="loanMax"></div></div>
                    <div class="form-row"><div><label>Tenure Min (M)</label><input type="number" id="tenMin"></div><div><label>Tenure Max (M)</label><input type="number" id="tenMax"></div></div>
                    <div class="form-row"><div><label>ROI Min (%)</label><input type="number" step="0.1" id="roiMin"></div><div><label>ROI Max (%)</label><input type="number" step="0.1" id="roiMax"></div></div>
                    <div class="form-row"><div><label>PF Min (%)</label><input type="number" step="0.1" id="pfMin"></div><div><label>PF Max (%)</label><input type="number" step="0.1" id="pfMax"></div></div>
                </div>

                <div class="sec-title">SECTION B - FINANCIAL GATES</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Min Vintage (Yrs)</label><input type="number" id="minVin"></div><div><label>Min Turnover (L)</label><input type="number" id="minTurn"></div></div>
                    <div class="form-row"><div><label>Min ABB (Amt)</label><input type="number" id="abbMin"></div><div><label>Min CIBIL</label><input type="number" id="minCibil"></div></div>
                    <div class="form-row"><div><label>ITR Required?</label><select id="itrReq"><option>No</option><option>Yes</option></select></div><div><label>GST Required?</label><select id="gstReq"><option>No</option><option>Yes</option></select></div></div>
                    <label>Accepted Bank Statements:</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <label><input type="checkbox" class="bank-chk" value="SA"> SA</label>
                        <label><input type="checkbox" class="bank-chk" value="CA"> CA</label>
                        <label><input type="checkbox" class="bank-chk" value="OD"> OD</label>
                        <label><input type="checkbox" class="bank-chk" value="CC"> CC</label>
                    </div>
                </div>

                <div class="sec-title">SECTION C - APPLICANT & PROPERTY</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Min Age</label><input type="number" id="ageMin"></div><div><label>Max Age</label><input type="number" id="ageMax"></div></div>
                    <div class="form-row"><div><label>Co-Applicant Req?</label><select id="coAppReq" onchange="toggleField('coBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                    <div id="coBox" class="hidden-field"><input type="number" id="coAgeMin" placeholder="Min Age"><input type="number" id="coAgeMax" placeholder="Max Age" style="margin-top:5px;"></div></div>
                    <div class="form-row"><div><label>Own House Req?</label><select id="houseReq" onchange="toggleField('houseGeoBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                    <div id="houseGeoBox" class="hidden-field"><label>House Geo Scope</label><select id="houseGeo"><option>Local</option><option>Same State</option><option>Pan India</option></select></div></div>
                </div>

                <div class="sec-title">SECTION D - CREDIT LIMITS</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Max Unsecured Loans</label><input type="number" id="maxUnsec"></div><div><label>Max Active Loans</label><input type="number" id="maxActive"></div></div>
                    <div class="form-row"><div><label>Max Enquiries (3m)</label><input type="number" id="maxEnq"></div><div><label>Loans Taken (6m)</label><input type="number" id="loans6m"></div></div>
                </div>

               <div class="sec">E. PROGRAMS (Added Min/Max Loan)</div>
                <div id="progs"></div><button type="button" class="btn btn-add" onclick="addP()">+ Program</button>

                <div class="sec-title">SECTION F - CONDITIONS & REMARKS</div>
                <div class="sec-content">
                    <div id="condContainer"></div>
                    <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="addCond()">+ Add Condition</button>
                    <div style="margin-top:15px;"><label>Internal Remarks</label><textarea id="remarks" rows="3" style="width:100%; border:1px solid #ccc;" placeholder="Enter internal notes..."></textarea></div>
                </div>

            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-del" onclick="closeModal('policy')">Cancel</button><button class="btn btn-add" onclick="savePolicy()">Save Policy</button></div>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content" style="width:500px;height:auto;">
        <div class="modal-header"><h3>User Editor</h3><span onclick="closeModal('user')">‚úñ</span></div>
        <div class="modal-body">
            <form id="userForm"><input type="hidden" id="u_id">
                <div class="form-row" style="grid-template-columns:1fr;"><label>Name</label><input type="text" id="uName"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Mobile</label><input type="number" id="uMob"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Username</label><input type="text" id="uUser"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Password</label><input type="text" id="uPass"></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-add" onclick="saveUser()">Save User</button></div>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
        authDomain: "credir-engine-new.firebaseapp.com",
        projectId: "credir-engine-new",
        storageBucket: "credir-engine-new.firebasestorage.app",
        messagingSenderId: "249073295308",
        appId: "1:249073295308:web:e3db899190a4d2506d0769",
        measurementId: "G-YBXMM1J129"
    };

    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch(e) { console.error("FB Error", e); }

    // 2. SESSION
    if (sessionStorage.getItem('adminLoggedIn') === 'true') document.getElementById('loginOverlay').style.display = 'none';

    // 3. DEFAULTS
    const defaultPolicies = [
        { bankName:"TATA STBL", prodType:"STBL", minTurn:20, minVin:2, minCibil:700, loanMin:3, loanMax:20, tenMax:36, roiMin:18, roiMax:24, abbMin:5000, itrReq:'Yes', gstReq:'Yes' },
        { bankName:"BAJAJ OD", prodType:"OD", minTurn:50, minVin:2, minCibil:720, loanMin:5, loanMax:25, tenMax:24, roiMin:14.5, roiMax:22, abbMin:20000, itrReq:'No', gstReq:'Yes' }
    ];

    let policies=[], users=[], requests=[], apps=[];

    function loadAllData() {
        if(!db) return;
        db.collection("policies").onSnapshot(snap => { 
            policies = [];
            snap.forEach(doc => { policies.push({ id: doc.id, ...doc.data() }); });
            renderTables(); 
        });
        db.collection("dsa_users").onSnapshot(snap => { users = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderTables(); });
        db.collection("dsa_requests").onSnapshot(snap => { requests = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderTables(); });
        db.collection("applications").onSnapshot(snap => { apps = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderTables(); });
    }

    function renderTables() {
        const pT = document.querySelector('#policyTable tbody'); pT.innerHTML='';
        if (policies.length === 0) {
            pT.innerHTML = "<tr><td colspan='7'>No Policies Found. Click 'Load Defaults'.</td></tr>";
        } else {
            policies.forEach(p => {
                pT.innerHTML += `<tr><td>${p.bankName||'-'}</td><td>${p.prodType||'-'}</td><td>${p.loanMin}-${p.loanMax}</td><td>${p.tenMax}</td><td>${p.abbMin||'-'}</td><td>${p.roiMin}-${p.roiMax}</td>
                <td><button class="btn btn-edit" onclick="editPolicy('${p.id}')">Edit</button><button class="btn btn-del" onclick="delDoc('policies','${p.id}')">Del</button></td></tr>`;
            });
        }
        
        const uT = document.querySelector('#userTable tbody'); uT.innerHTML='';
        users.forEach(u => uT.innerHTML += `<tr><td>${u.name}</td><td>${u.mobile}</td><td>${u.user}</td><td>${u.pass}</td><td><button class="btn btn-del" onclick="delDoc('dsa_users','${u.id}')">Del</button></td></tr>`);
        
        const rT = document.querySelector('#requestTable tbody'); rT.innerHTML='';
        requests.forEach(r => rT.innerHTML += `<tr><td>${r.name}</td><td>${r.mobile}</td><td>${r.user}</td><td><button class="btn btn-add" onclick="approveReq('${r.id}')">Approve</button></td></tr>`);
        
        const aT = document.querySelector('#appTable tbody'); aT.innerHTML='';
        apps.forEach(a => aT.innerHTML += `<tr><td>${a.date}</td><td>${a.customer}</td><td>${a.dsaName||'-'}</td><td>${a.status}</td><td>${a.data['Req Amount']||'-'} L</td></tr>`);
    }

    // ACTIONS
    window.uploadDefaultPolicies = () => { if(confirm("Load Defaults?")) { defaultPolicies.forEach(p => db.collection("policies").add(p)); } };
    window.approveReq = (id) => { const r = requests.find(x => x.id === id); if(r) { db.collection("dsa_users").add({...r, status:"Active"}); db.collection("dsa_requests").doc(id).delete(); } };
    window.delDoc = (col, id) => { if(confirm("Delete?")) db.collection(col).doc(id).delete(); };

    window.saveUser = () => {
        const u = { name: document.getElementById('uName').value, mobile: document.getElementById('uMob').value, user: document.getElementById('uUser').value, pass: document.getElementById('uPass').value, status: "Active" };
        db.collection("dsa_users").add(u); closeModal('user');
    };

    window.savePolicy = () => {
        let bTypes = []; document.querySelectorAll('.bank-chk:checked').forEach(c => bTypes.push(c.value));
        let progs = []; document.querySelectorAll('#progContainer .dynamic-row').forEach(r => progs.push({type: r.children[0].value, val: r.children[1].value}));
        let conds = []; document.querySelectorAll('#condContainer .dynamic-row').forEach(r => { let i = r.querySelectorAll('input'); if(i[0].value) conds.push({name:i[0].value, val:i[1].value}); });

        const p = {
            bankName: document.getElementById('bankName').value, prodType: document.getElementById('prodType').value,
            loanMin: +document.getElementById('loanMin').value, loanMax: +document.getElementById('loanMax').value,
            tenMin: +document.getElementById('tenMin').value, tenMax: +document.getElementById('tenMax').value,
            roiMin: +document.getElementById('roiMin').value, roiMax: +document.getElementById('roiMax').value,
            pfMin: +document.getElementById('pfMin').value, pfMax: +document.getElementById('pfMax').value,
            
            minVin: +document.getElementById('minVin').value, minTurn: +document.getElementById('minTurn').value, 
            abbMin: +document.getElementById('abbMin').value, minCibil: +document.getElementById('minCibil').value,
            itrReq: document.getElementById('itrReq').value, gstReq: document.getElementById('gstReq').value,
            
            ageMin: +document.getElementById('ageMin').value, ageMax: +document.getElementById('ageMax').value,
            coAppReq: document.getElementById('coAppReq').value, coAgeMin: document.getElementById('coAgeMin').value, coAgeMax: document.getElementById('coAgeMax').value,
            houseReq: document.getElementById('houseReq').value, houseGeo: document.getElementById('houseGeo').value,
            
            maxUnsec: +document.getElementById('maxUnsec').value, maxActive: +document.getElementById('maxActive').value, 
            maxEnq: +document.getElementById('maxEnq').value, loans6m: +document.getElementById('loans6m').value,
            
            bankingTypes: bTypes, programs: progs, conditions: conds, remarks: document.getElementById('remarks').value
        };
        
        let idx = document.getElementById('p_id').value;
        if(idx) db.collection("policies").doc(idx).update(p); else db.collection("policies").add(p);
        closeModal('policy');
    };

    // --- FIX: SAFE EDIT & ID SETTING ---
    window.editPolicy = (id) => {
        let p = policies.find(x => x.id === id); if(!p) return;
        document.getElementById('p_id').value = id; // Crucial: Set ID!
        document.getElementById('policyModalTitle').innerText = "Edit Policy";

        // Safe fill function
        const setVal = (k, v) => { let el=document.getElementById(k); if(el) el.value = v || ''; };

        setVal('bankName', p.bankName); setVal('prodType', p.prodType); 
        setVal('itrReq', p.itrReq); setVal('gstReq', p.gstReq); setVal('coAppReq', p.coAppReq); setVal('houseReq', p.houseReq); 
        setVal('houseGeo', p.houseGeo); setVal('remarks', p.remarks);
        
        ['loanMin','loanMax','tenMin','tenMax','roiMin','roiMax','pfMin','pfMax','minVin','minTurn','abbMin','minCibil','ageMin','ageMax','coAgeMin','coAgeMax','maxUnsec','maxActive','maxEnq','loans6m'].forEach(k => setVal(k, p[k]));
        
        document.getElementById('progContainer').innerHTML='';
        if(p.programs) p.programs.forEach(pr=>addProg(pr.type, pr.val));
        
        document.getElementById('condContainer').innerHTML='';
        if(p.conditions) p.conditions.forEach(c=>addCond(c.name, c.val));
        
        document.querySelectorAll('.bank-chk').forEach(c => c.checked = (p.bankingTypes||[]).includes(c.value));
        
        toggleField('coBox', p.coAppReq==='Yes');
        toggleField('houseGeoBox', p.houseReq==='Yes');
        
        document.getElementById('policyModal').style.display='flex';
    };

    window.showSection=(id)=>{document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');};
    window.openModal=(t)=>{
        if(t==='policy') { 
            document.getElementById('policyForm').reset(); 
            document.getElementById('p_id').value=''; 
            document.getElementById('policyModalTitle').innerText = "New Policy";
            document.getElementById('progContainer').innerHTML=''; 
            document.getElementById('condContainer').innerHTML=''; 
        } else { document.getElementById('userForm').reset(); document.getElementById('u_id').value=''; }
        document.getElementById(t+'Modal').style.display='flex';
    };
    window.closeModal=(t)=>document.getElementById(t+'Modal').style.display='none';
    window.toggleField=(id,s)=>document.getElementById(id).style.display=s?'block':'none';
    
    window.addProg=(t='ABB',v='')=>document.getElementById('progContainer').insertAdjacentHTML('beforeend',`<div class="dynamic-row"><select><option ${t==='ABB'?'selected':''}>ABB</option><option ${t==='GST'?'selected':''}>GST</option><option ${t==='ITR'?'selected':''}>ITR</option><option ${t==='DSCR'?'selected':''}>DSCR</option></select><input type="number" placeholder="Value" value="${v}"><button class="btn btn-del" type="button" onclick="this.parentElement.remove()">X</button></div>`);
    window.addCond=(n='', v='')=>document.getElementById('condContainer').insertAdjacentHTML('beforeend',`<div class="dynamic-row"><input type="text" placeholder="Name" value="${n}"><input type="text" placeholder="Value" value="${v}"><button class="btn btn-del" type="button" onclick="this.parentElement.remove()">X</button></div>`);

    let savedAdminPass = localStorage.getItem('admin_pass') || 'admin123';
    window.checkAdminLogin = () => { if(document.getElementById('adminLockPass').value === savedAdminPass) { sessionStorage.setItem('adminLoggedIn','true'); document.getElementById('loginOverlay').style.display='none'; } else alert("Wrong"); };
    window.updateAdminPass = () => { const p = document.getElementById('newAdminPass').value; if(p) { localStorage.setItem('admin_pass', p); savedAdminPass = p; alert("Updated"); } };
    window.logout = () => { sessionStorage.removeItem('adminLoggedIn'); location.reload(); };

    loadAllData();
</script>
</body>
</html>

