<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Master Policy</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f4f7f6; display: flex; height: 100vh; }
        .sidebar { width: 260px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .nav-item:hover { background-color: #3949ab; }
        .nav-item.active { background-color: #3949ab; border-left: 4px solid #ffeb3b; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 13px; }
        th { background-color: #f5f5f5; }
        
        /* BUTTONS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 12px; margin-right: 5px; }
        .btn-add { background-color: #2e7d32; }
        .btn-reset { background-color: #ff9800; float: right; margin-right: 10px; }
        .btn-edit { background-color: #ffa000; color: #333; }
        .btn-del { background-color: #d32f2f; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 0; width: 900px; border-radius: 8px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #1a237e; color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; background: #fff; }
        
        /* ACCORDION */
        .sec-title { background: #eee; padding: 10px; font-weight: bold; margin-top: 15px; border-left: 5px solid #1a237e; cursor: pointer; }
        .sec-content { padding: 15px; border: 1px solid #eee; display: block; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .form-full { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; color: #333; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .hidden-field { display: none; background: #f9f9f9; padding: 10px; border: 1px dashed #ccc; margin-top: 5px; }
        
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; background: #f0f0f0; padding: 5px; border-radius: 4px; }
        .dynamic-row input, .dynamic-row select { flex: 1; }
        .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 12px; background: #e8eaf6; padding: 5px 10px; border-radius: 15px; }
        .checkbox-item input { width: auto; }

        /* VIEW SWITCHING */
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Super Admin</h2>
    <div class="nav-item active" onclick="showSection('policies')">üìú Policy Library</div>
    <div class="nav-item" onclick="showSection('users')">üë• Manage Users</div>
    <div class="nav-item" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
</div>

<div class="main-content">
    
    <div id="policies" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Bank Policy Engine</h2>
            <div>
                <button class="btn btn-reset" onclick="resetDefaults()">‚Üª Reset / Load Defaults</button>
                <button class="btn btn-add" onclick="openModal('policy')">+ Create Policy</button>
            </div>
        </div>
        <table id="policyTable">
            <thead><tr><th>Bank Name</th><th>Product</th><th>Min Loan</th><th>ROI Range</th><th>Actions</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="users" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Manage DSA Users</h2>
            <button class="btn btn-add" onclick="openModal('user')">+ Create User</button>
        </div>
        <table id="userTable">
            <thead><tr><th>DSA Name</th><th>Mobile</th><th>Username</th><th>Password</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="settings" class="section">
        <h2>Admin Settings</h2>
        <div style="background:white; padding:20px; max-width:400px; border-radius:8px;">
            <label>Admin Username</label><input type="text" id="adminUser" value="admin">
            <br><br>
            <label>Admin Password</label><input type="text" id="adminPass" value="admin123">
            <br><br>
            <button class="btn btn-add" onclick="alert('Credentials Updated')">Update</button>
        </div>
    </div>

</div>

<div id="policyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Add / Edit Policy</h3><span style="cursor:pointer; font-size:20px;" onclick="closeModal('policy')">‚úñ</span></div>
        <div class="modal-body">
            <form id="policyForm">
                <input type="hidden" id="p_id">
                
                <div class="sec-title">üîπ SECTION A ‚Äì BASIC PRODUCT DETAILS</div>
                <div class="sec-content">
                    <div class="form-full"><label>Bank Name</label><input type="text" id="bankName"></div>
                    <div class="form-row">
                        <div><label>Product Type</label><select id="prodType"><option>STBL</option><option>HTBL</option><option>OD</option><option>TERM</option><option>NBFC</option><option>UBL</option><option>UBL+</option></select></div>
                    </div>
                    <div class="form-row"><div><label>Loan Min (Lakhs)</label><input type="number" id="loanMin"></div><div><label>Loan Max (Lakhs)</label><input type="number" id="loanMax"></div></div>
                    <div class="form-row"><div><label>Tenure Min (Months)</label><input type="number" id="tenMin"></div><div><label>Tenure Max (Months)</label><input type="number" id="tenMax"></div></div>
                    <div class="form-row"><div><label>ROI Min (%)</label><input type="number" step="0.1" id="roiMin"></div><div><label>ROI Max (%)</label><input type="number" step="0.1" id="roiMax"></div></div>
                    <div class="form-row"><div><label>PF Min (%)</label><input type="number" step="0.1" id="pfMin"></div><div><label>PF Max (%)</label><input type="number" step="0.1" id="pfMax"></div></div>
                </div>

                <div class="sec-title">üîπ SECTION B ‚Äì APPLICANT</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Age Min</label><input type="number" id="ageMin"></div><div><label>Age Max</label><input type="number" id="ageMax"></div></div>
                    <div class="form-row">
                        <label>Co-Applicant Mandatory?</label>
                        <select id="coAppReq" onchange="toggleField('coBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                    </div>
                    <div id="coBox" class="hidden-field">
                        <div class="form-row"><div><label>Co-App Age Min</label><input type="number" id="coAgeMin"></div><div><label>Co-App Age Max</label><input type="number" id="coAgeMax"></div></div>
                    </div>
                    <div class="form-row" style="margin-top:10px;">
                        <label>Own House Mandatory?</label>
                        <select id="houseReq" onchange="toggleField('houseBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                    </div>
                    <div id="houseBox" class="hidden-field">
                        <div class="form-row"><div><label>Geo Limit</label><select id="houseGeo"><option>Local</option><option>Anywhere India</option></select></div><div><label>Pincodes</label><input type="text" id="housePins"></div></div>
                    </div>
                </div>

                <div class="sec-title">üîπ SECTION C ‚Äì BUSINESS</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Vintage Min (Yrs)</label><input type="number" id="minVin"></div><div><label>Turnover Min (Lakhs)</label><input type="number" id="minTurn"></div></div>
                    <div class="form-full"><label>ABB Min (Rupees)</label><input type="number" id="abbMin"></div>
                    
                    <div class="form-row">
                        <div><label>ITR Required?</label><select id="itrReq" onchange="toggleField('itrBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                        <div id="itrBox" class="hidden-field"><label>Min ITR Turnover</label><input type="number" id="itrVal"></div>
                    </div>
                    <div class="form-row">
                        <div><label>GST Required?</label><select id="gstReq" onchange="toggleField('gstBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                        <div id="gstBox" class="hidden-field"><label>Min GST Turnover</label><input type="number" id="gstVal"></div>
                    </div>
                    
                    <label>Banking Types Accepted:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" class="bank-chk" value="SA"> SA</label>
                        <label class="checkbox-item"><input type="checkbox" class="bank-chk" value="CA"> CA</label>
                        <label class="checkbox-item"><input type="checkbox" class="bank-chk" value="OD"> OD</label>
                        <label class="checkbox-item"><input type="checkbox" class="bank-chk" value="CC"> CC</label>
                    </div>
                </div>

                <div class="sec-title">üîπ SECTION D ‚Äì CREDIT</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>CIBIL Min</label><input type="number" id="minCibil"></div><div><label>CIBIL Max</label><input type="number" id="maxCibil"></div></div>
                    <div class="form-row"><div><label>Max Active Loans</label><input type="number" id="actLoans"></div><div><label>Max Unsecured (Empty=Unlimited)</label><input type="number" id="maxUnsec"></div></div>
                    <div class="form-row"><div><label>Loans (Last 6m)</label><input type="number" id="loans6m"></div><div><label>Enquiries (3m)</label><input type="number" id="enq3m"></div></div>
                </div>

                <div class="sec-title">üîπ SECTION E & F ‚Äì PROGRAMS & RULES</div>
                <div class="sec-content">
                    <div id="progContainer"></div>
                    <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="addProg()">+ Add Program</button>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-del" onclick="closeModal('policy')">Cancel</button>
            <button class="btn btn-add" onclick="savePolicy()">üíæ Save Policy</button>
        </div>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content" style="width:500px; height:auto;">
        <div class="modal-header"><h3>Add User</h3><span style="cursor:pointer; font-size:20px;" onclick="closeModal('user')">‚úñ</span></div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="u_id">
                <div class="form-full"><label>DSA Name</label><input type="text" id="uName" required></div>
                <div class="form-full"><label>Mobile</label><input type="number" id="uMob" required></div>
                <div class="form-full"><label>Username</label><input type="text" id="uUser" required></div>
                <div class="form-full"><label>Password</label><input type="text" id="uPass" required></div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-del" onclick="closeModal('user')">Cancel</button>
            <button class="btn btn-add" onclick="saveUser()">üíæ Save User</button>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA INITIALIZATION & RECOVERY ---
    const defaultPolicies = [
        { id:1, bankName:"TATA CAPITAL STBL", prodType:"STBL", minTurn:20, minVin:2, minCibil:700, maxUnsec:5, roiMin:18, roiMax:24, loanMin:1, loanMax:50, tenMin:12, tenMax:36 },
        { id:2, bankName:"ADITYA BIRLA STBL", prodType:"STBL", minTurn:25, minVin:2, minCibil:700, maxUnsec:5, roiMin:17.5, roiMax:22, loanMin:1, loanMax:40, tenMin:12, tenMax:36 },
        { id:3, bankName:"BAJAJ FINANCE TERM", prodType:"TERM", minTurn:40, minVin:3, minCibil:700, maxUnsec:5, roiMin:16.5, roiMax:21, loanMin:5, loanMax:50, tenMin:12, tenMax:48 },
        { id:4, bankName:"PIRAMAL CAPITAL UBL", prodType:"UBL", minTurn:30, minVin:3, minCibil:700, maxUnsec:"", roiMin:19, roiMax:26, loanMin:1, loanMax:30, tenMin:12, tenMax:36 }, 
        { id:5, bankName:"PIRAMAL CAPITAL UBL+", prodType:"UBL+", minTurn:100, minVin:4, minCibil:700, maxUnsec:5, roiMin:15, roiMax:20, loanMin:30, loanMax:100, tenMin:12, tenMax:48 },
        { id:6, bankName:"TATA CAPITAL HTBL", prodType:"HTBL", minTurn:200, minVin:4, minCibil:700, maxUnsec:5, roiMin:14, roiMax:18, loanMin:50, loanMax:500, tenMin:12, tenMax:60 },
        { id:7, bankName:"ADITYA BIRLA BIG TICKET", prodType:"HTBL", minTurn:250, minVin:4, minCibil:700, maxUnsec:5, roiMin:13.5, roiMax:18, loanMin:50, loanMax:500, tenMin:12, tenMax:60 },
        { id:8, bankName:"ADITYA BIRLA DROP OD", prodType:"OD", minTurn:100, minVin:3, minCibil:700, maxUnsec:5, roiMin:12, roiMax:16, loanMin:10, loanMax:50, tenMin:12, tenMax:12 },
        { id:9, bankName:"TATA CAPITAL DROP OD", prodType:"OD", minTurn:100, minVin:3, minCibil:700, maxUnsec:5, roiMin:12.5, roiMax:16, loanMin:10, loanMax:50, tenMin:12, tenMax:12 },
        { id:10, bankName:"BAJAJ FINANCE FLEXI OD", prodType:"OD", minTurn:50, minVin:2, minCibil:700, maxUnsec:5, roiMin:14.5, roiMax:22, loanMin:5, loanMax:25, tenMin:12, tenMax:24 },
        { id:11, bankName:"CLIX CAPITAL", prodType:"NBFC", minTurn:15, minVin:2, minCibil:700, maxUnsec:5, roiMin:21, roiMax:28, loanMin:1, loanMax:20, tenMin:12, tenMax:30 }
    ];

    const defaultUsers = [
        { name: "Rahul Kumar", mobile: "9876543210", user: "rahul_dsa", pass: "Pass@123", status: "Active" },
        { name: "Sneha Agencies", mobile: "9988776655", user: "sneha_fin", pass: "Money#2025", status: "Active" }
    ];

    // Attempt to recover old data if new key is empty
    let policies = JSON.parse(localStorage.getItem('credit_engine_db'));
    if(!policies) {
        // Fallback checks
        policies = JSON.parse(localStorage.getItem('admin_policies_master')) || defaultPolicies;
    }

    let users = JSON.parse(localStorage.getItem('credit_users_db'));
    if(!users) {
        // Fallback checks
        users = JSON.parse(localStorage.getItem('admin_users_master')) || JSON.parse(localStorage.getItem('admin_users_final')) || defaultUsers;
    }

    // --- UI FUNCTIONS ---
    function showSection(id) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toggleField(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
    
    function openModal(type) { 
        if(type==='policy') {
            document.getElementById('policyForm').reset(); document.getElementById('p_id').value=''; document.getElementById('policyModal').style.display='flex'; 
        } else {
            document.getElementById('userForm').reset(); document.getElementById('u_id').value=''; document.getElementById('userModal').style.display='flex';
        }
    }
    
    function closeModal(type) { document.getElementById(type==='policy'?'policyModal':'userModal').style.display='none'; }

    // --- DYNAMIC ROWS ---
    function addProg(d={}) {
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        div.innerHTML = `<select class="prog-type"><option>ABB</option><option>GST</option><option>ITR</option></select><input type="number" class="prog-min" placeholder="Min"><button class="btn btn-del" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('progContainer').appendChild(div);
    }

    // --- SAVE LOGIC ---
    function savePolicy() {
        let idx = document.getElementById('p_id').value;
        let p = {
            bankName: document.getElementById('bankName').value,
            prodType: document.getElementById('prodType').value,
            loanMin: +document.getElementById('loanMin').value, loanMax: +document.getElementById('loanMax').value,
            tenMin: +document.getElementById('tenMin').value, tenMax: +document.getElementById('tenMax').value,
            roiMin: +document.getElementById('roiMin').value, roiMax: +document.getElementById('roiMax').value,
            pfMin: +document.getElementById('pfMin').value, pfMax: +document.getElementById('pfMax').value,
            ageMin: +document.getElementById('ageMin').value, ageMax: +document.getElementById('ageMax').value,
            minVin: +document.getElementById('minVin').value, minTurn: +document.getElementById('minTurn').value,
            abbMin: +document.getElementById('abbMin').value,
            minCibil: +document.getElementById('minCibil').value, maxUnsec: document.getElementById('maxUnsec').value
        };
        if(idx !== '') policies[idx] = p; else policies.push(p);
        closeModal('policy'); renderTable();
    }

    function saveUser() {
        let idx = document.getElementById('u_id').value;
        let u = {
            name: document.getElementById('uName').value,
            mobile: document.getElementById('uMob').value,
            user: document.getElementById('uUser').value,
            pass: document.getElementById('uPass').value,
            status: "Active"
        };
        if(idx !== '') users[idx] = u; else users.push(u);
        closeModal('user'); renderTable();
    }

    function editPolicy(i) {
        openModal('policy');
        let p = policies[i];
        document.getElementById('p_id').value = i;
        document.getElementById('bankName').value = p.bankName;
        document.getElementById('prodType').value = p.prodType;
        document.getElementById('loanMin').value = p.loanMin; document.getElementById('loanMax').value = p.loanMax;
        document.getElementById('tenMin').value = p.tenMin; document.getElementById('tenMax').value = p.tenMax;
        document.getElementById('roiMin').value = p.roiMin; document.getElementById('roiMax').value = p.roiMax;
        document.getElementById('pfMin').value = p.pfMin||''; document.getElementById('pfMax').value = p.pfMax||'';
        document.getElementById('ageMin').value = p.ageMin||''; document.getElementById('ageMax').value = p.ageMax||'';
        document.getElementById('minVin').value = p.minVin; document.getElementById('minTurn').value = p.minTurn;
        document.getElementById('abbMin').value = p.abbMin||'';
        document.getElementById('minCibil').value = p.minCibil; document.getElementById('maxUnsec').value = p.maxUnsec;
    }

    function editUser(i) {
        openModal('user');
        let u = users[i];
        document.getElementById('u_id').value = i;
        document.getElementById('uName').value = u.name;
        document.getElementById('uMob').value = u.mobile;
        document.getElementById('uUser').value = u.user;
        document.getElementById('uPass').value = u.pass;
    }

    function delPolicy(i) { if(confirm('Delete Policy?')) { policies.splice(i,1); renderTable(); } }
    function delUser(i) { if(confirm('Delete User?')) { users.splice(i,1); renderTable(); } }

    function resetDefaults() {
        if(confirm("Reset all 11 policies?")) {
            policies = JSON.parse(JSON.stringify(defaults));
            renderTable();
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#policyTable tbody');
        tbody.innerHTML = '';
        policies.forEach((p, i) => {
            tbody.innerHTML += `<tr><td>${p.bankName}</td><td>${p.prodType}</td><td>${p.loanMin}-${p.loanMax}L</td><td>${p.roiMin}-${p.roiMax}%</td>
            <td><button class="btn btn-edit" onclick="editPolicy(${i})">Edit</button><button class="btn btn-del" onclick="delPolicy(${i})">Del</button></td></tr>`;
        });
        localStorage.setItem('credit_engine_db', JSON.stringify(policies));

        const ubody = document.querySelector('#userTable tbody');
        ubody.innerHTML = '';
        users.forEach((u, i) => {
            ubody.innerHTML += `<tr><td>${u.name}</td><td>${u.mobile}</td><td>${u.user}</td><td>${u.pass}</td><td style="color:green;font-weight:bold">${u.status}</td><td><button class="btn btn-edit" onclick="editUser(${i})">Edit</button> <button class="btn btn-del" onclick="delUser(${i})">Del</button></td></tr>`;
        });
        localStorage.setItem('credit_users_db', JSON.stringify(users));
    }

    renderTable();
</script>
</body>
</html>
