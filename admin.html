<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Master Control</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* STYLES */
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f4f7f6; display: flex; height: 100vh; overflow: hidden; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a237e; z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; }
        .sidebar { width: 260px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; }
        .nav-item:hover, .nav-item.active { background-color: #3949ab; border-left: 4px solid #ffeb3b; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* TABLE */
        .table-container { overflow-x: auto; background: white; margin-top: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-size: 13px; white-space: nowrap; }
        th { background-color: #e8eaf6; color: #1a237e; font-weight: bold; position: sticky; top: 0; }
        
        /* BUTTONS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 12px; margin-right: 5px; }
        .btn-add { background-color: #2e7d32; } 
        .btn-del { background-color: #c62828; } 
        .btn-edit { background-color: #ffa000; color: #333; } 
        .btn-reset { background-color: #ff9800; float: right; margin-right: 10px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 0; width: 900px; border-radius: 8px; height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #1a237e; color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #ddd; text-align: right; }
        
        /* FORM ELEMENTS */
        .sec-title { background: #f5f5f5; padding: 10px; font-weight: bold; margin-top: 20px; border-left: 5px solid #1a237e; color: #333; }
        .sec-content { padding: 15px; border: 1px solid #eee; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .section { display: none; } .section.active { display: block; }
        
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .hidden-field { display:none; background:#fafafa; padding:10px; border:1px dashed #ccc; margin-top:5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div id="loginOverlay"><div class="login-box"><h2>üîí Admin Access</h2><input type="password" id="adminLockPass" placeholder="Enter Password"><br><br><button class="btn btn-add" style="width:100%" onclick="checkAdminLogin()">Login</button></div></div>

<div class="sidebar">
    <h2 style="margin-bottom: 30px;">üöÄ Super Admin</h2>
    <div class="nav-item active" onclick="showSection('policies')">üìú Policy Library</div>
    <div class="nav-item" onclick="showSection('users')">üë• Manage Users</div>
    <div class="nav-item" onclick="showSection('apps')">üìÇ All Applications</div>
    <div class="nav-item" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
    <div class="nav-item" style="margin-top:auto; background:#c62828;" onclick="logout()">üö™ Logout</div>
</div>

<div class="main-content">
    
    <div id="policies" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Bank Policy Engine</h2>
            <div>
                <button class="btn btn-reset" onclick="uploadDefaultPolicies()">‚Üª Load Defaults</button>
                <button class="btn btn-add" onclick="openModal('policy')">+ Create Policy</button>
            </div>
        </div>
        <div class="table-container">
            <table id="policyTable">
                <thead><tr><th>Bank Name</th><th>Product</th><th>Loan Range</th><th>Tenure</th><th>Min ABB</th><th>ROI %</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="users" class="section">
        <h2>üë• Active DSA Users</h2>
        <div style="text-align:right; margin-bottom:10px;"><button class="btn btn-add" onclick="openModal('user')">+ Add User</button></div>
        <div class="table-container"><table id="userTable"><thead><tr><th>Name</th><th>Mobile</th><th>Username</th><th>Password</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        <h2 style="margin-top:30px;">üîî Pending Requests</h2>
        <div class="table-container"><table id="requestTable"><thead><tr><th>Name</th><th>Mobile</th><th>Username</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    </div>
    
    <div id="apps" class="section">
        <div style="display:flex; justify-content:space-between;">
            <h2>üìÇ Applications</h2>
            <button class="btn btn-add" style="background:#008CBA;" onclick="exportToExcel()">‚¨á Excel</button>
        </div>
        
        <div class="table-container" style="max-height: 75vh;">
            <table id="appTable" style="min-width: 3500px;"> 
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer Name</th>
                        <th>Contact Number</th>
                        <th>Vintage</th>
                        <th>Turnover</th>
                        <th>Entity type</th>
                        <th>Sector</th>
                        <th>Business Premises</th>
                        <th>ABB</th>
                        <th>Bank Statement type</th>
                        <th>GST Reg</th>
                        <th>ITR Filed</th>
                        <th>Cibil</th>
                        <th>Active Loans</th>
                        <th>Monthly EMI</th>
                        <th>Unsecured Loans</th>
                        <th>Loans Taken (6Months)</th>
                        <th>Loans Closing(Next 6Months)</th>
                        <th>Reduced EMI(Next 6 Months)</th>
                        <th>Enquiries(3 Months)</th>
                        <th>Applicant Age</th>
                        <th>Gender</th>
                        <th>Co-Applicant?</th>
                        <th>Co-Applicant Age</th>
                        <th>Own House?</th>
                        <th>Own House Pincode</th>
                        <th>Required Loan Amount(lakhs)</th>
                        <th>Purpose</th>
                        <th>DSA Name</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div id="settings" class="section">
        <h2>Settings</h2>
        <div style="background:white;padding:30px;border-radius:8px;max-width:400px;"><label>Change Password</label><input type="text" id="newAdminPass"><br><br><button class="btn btn-add" onclick="updateAdminPass()">Update</button></div>
    </div>
</div>

<div id="policyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="policyModalTitle">Bank New Policy</h3><span style="cursor:pointer; font-size:20px;" onclick="closeModal('policy')">‚úñ</span></div>
        <div class="modal-body">
            <form id="policyForm">
                <input type="hidden" id="p_id">
                
                <div class="sec-title">SECTION A - BASIC DETAILS</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Bank Name</label><input id="bankName"></div><div><label>Product Type</label><select id="prodType"><option>STBL</option><option>HTBL</option><option>OD</option><option>TERM</option><option>NBFC</option><option>UBL</option></select></div></div>
                    <div class="form-row"><div><label>Loan Min (L)</label><input type="number" id="loanMin"></div><div><label>Loan Max (L)</label><input type="number" id="loanMax"></div></div>
                    <div class="form-row"><div><label>Tenure Min (M)</label><input type="number" id="tenMin"></div><div><label>Tenure Max (M)</label><input type="number" id="tenMax"></div></div>
                    <div class="form-row"><div><label>ROI Min (%)</label><input type="number" step="0.1" id="roiMin"></div><div><label>ROI Max (%)</label><input type="number" step="0.1" id="roiMax"></div></div>
                    <div class="form-row"><div><label>PF Min (%)</label><input type="number" step="0.1" id="pfMin"></div><div><label>PF Max (%)</label><input type="number" step="0.1" id="pfMax"></div></div>
                </div>

                <div class="sec-title">SECTION B - FINANCIAL GATES</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Min Vintage (Yrs)</label><input type="number" id="minVin"></div><div><label>Min Turnover (L)</label><input type="number" id="minTurn"></div></div>
                    <div class="form-row"><div><label>Min ABB (Amt)</label><input type="number" id="abbMin"></div><div><label>Min CIBIL</label><input type="number" id="minCibil"></div></div>
                    <div class="form-row"><div><label>ITR Required?</label><select id="itrReq"><option>No</option><option>Yes</option></select></div><div><label>GST Required?</label><select id="gstReq"><option>No</option><option>Yes</option></select></div></div>
                    <label>Accepted Bank Statements:</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <label><input type="checkbox" class="bank-chk" value="SA"> SA</label>
                        <label><input type="checkbox" class="bank-chk" value="CA"> CA</label>
                        <label><input type="checkbox" class="bank-chk" value="OD"> OD</label>
                        <label><input type="checkbox" class="bank-chk" value="CC"> CC</label>
                    </div>
                </div>

                <div class="sec-title">SECTION C - APPLICANT & PROPERTY</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Min Age</label><input type="number" id="ageMin"></div><div><label>Max Age</label><input type="number" id="ageMax"></div></div>
                    <div class="form-row"><div><label>Co-Applicant Req?</label><select id="coAppReq" onchange="toggleField('coBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                    <div id="coBox" class="hidden-field"><input type="number" id="coAgeMin" placeholder="Min Age"><input type="number" id="coAgeMax" placeholder="Max Age" style="margin-top:5px;"></div></div>
                    <div class="form-row"><div><label>Own House Req?</label><select id="houseReq" onchange="toggleField('houseGeoBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                    <div id="houseGeoBox" class="hidden-field"><label>House Geo Scope</label><select id="houseGeo"><option>Local</option><option>Same State</option><option>Pan India</option></select></div></div>
                </div>

                <div class="sec-title">SECTION D - CREDIT LIMITS</div>
                <div class="sec-content">
                    <div class="form-row"><div><label>Max Unsecured Loans</label><input type="number" id="maxUnsec"></div><div><label>Max Active Loans</label><input type="number" id="maxActive"></div></div>
                    <div class="form-row"><div><label>Max Enquiries (3m)</label><input type="number" id="maxEnq"></div><div><label>Loans Taken (6m)</label><input type="number" id="loans6m"></div></div>
                </div>

                <div class="sec-title">SECTION E - PROGRAMS</div>
                <div class="sec-content">
                    <div id="progContainer"></div>
                    <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="addProg()">+ Add Program</button>
                </div>

                <div class="sec-title">SECTION F - GEOGRAPHY, CONDITIONS & REMARKS</div>
                <div class="sec-content">
                    <div class="form-row">
                        <div><label>Geo Limit (in km's)</label><input type="number" id="geoLimit"></div>
                        <div>
                            <label>Pincode Based?</label>
                            <select id="pinBased" onchange="toggleField('pinOptionBox',this.value==='Yes')">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                    </div>

                    <div id="pinOptionBox" class="hidden-field">
                        <label>Pincode Scope</label>
                        <select id="pinScope">
                            <option>Pan India</option>
                            <option>Specific List</option>
                        </select>
                    </div>

                    <div id="condContainer" style="margin-top:15px;"></div>
                    <button type="button" class="btn btn-add" style="margin-top:10px;" onclick="addCond()">+ Add Condition</button>

                    <div style="margin-top:15px;">
                        <label>Internal Remarks</label>
                        <textarea id="remarks" rows="3" style="width:100%; border:1px solid #ccc;" placeholder="Enter internal notes..."></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-del" onclick="closeModal('policy')">Cancel</button><button class="btn btn-add" onclick="savePolicy()">Save Policy</button></div>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content" style="width:500px;height:auto;">
        <div class="modal-header"><h3>User Editor</h3><span onclick="closeModal('user')">‚úñ</span></div>
        <div class="modal-body">
            <form id="userForm"><input type="hidden" id="u_id">
                <div class="form-row" style="grid-template-columns:1fr;"><label>Name</label><input type="text" id="uName"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Mobile</label><input type="number" id="uMob"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Username</label><input type="text" id="uUser"></div>
                <div class="form-row" style="grid-template-columns:1fr;"><label>Password</label><input type="text" id="uPass"></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-add" onclick="saveUser()">Save User</button></div>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
        authDomain: "credir-engine-new.firebaseapp.com",
        projectId: "credir-engine-new",
        storageBucket: "credir-engine-new.firebasestorage.app",
        messagingSenderId: "249073295308",
        appId: "1:249073295308:web:e3db899190a4d2506d0769",
        measurementId: "G-YBXMM1J129"
    };

    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch(e) { console.error("FB Error", e); }

    // 2. SESSION
    if (sessionStorage.getItem('adminLoggedIn') === 'true') document.getElementById('loginOverlay').style.display = 'none';

    // 3. DEFAULTS
    const defaultPolicies = [
        { bankName:"TATA STBL", prodType:"STBL", minTurn:20, minVin:2, minCibil:700, loanMin:3, loanMax:20, tenMax:36, roiMin:18, roiMax:24, abbMin:5000, itrReq:'Yes', gstReq:'Yes' },
        { bankName:"BAJAJ OD", prodType:"OD", minTurn:50, minVin:2, minCibil:720, loanMin:5, loanMax:25, tenMax:24, roiMin:14.5, roiMax:22, abbMin:20000, itrReq:'No', gstReq:'Yes' }
    ];

    let policies=[], users=[], requests=[], apps=[];

   // --- 1. DATE HELPER FUNCTIONS ---
    // Fixes the mixed date formats (DD/MM vs MM/DD)
    function parseDate(dateStr) {
        if (!dateStr) return new Date(0); 
        if (typeof dateStr !== 'string') return new Date(dateStr);

        let parts = dateStr.split(/[/-]/); // Split by / or -
        if (parts.length === 3) {
            let p1 = parseInt(parts[0]); // Day or Month?
            let p2 = parseInt(parts[1]);
            let p3 = parseInt(parts[2]); // Year

            // If first part > 12, it is Day (DD/MM/YYYY)
            if (p1 > 12) return new Date(p3, p2 - 1, p1);
            
            // If first part is Year (YYYY-MM-DD)
            if (p1 > 2000) return new Date(p1, p2 - 1, p3);
            
            // If ambiguous (e.g. 12/05/2025), default JS handling
        }
        return new Date(dateStr);
    }

    // Standardizes display to DD/MM/YYYY
    function formatDisplayDate(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) return '-';
        let d = dateObj.getDate().toString().padStart(2, '0');
        let m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        let y = dateObj.getFullYear();
        return `${d}/${m}/${y}`;
    }

    // --- 2. UPDATED LOAD DATA (With Sorting) ---
    function loadAllData() {
        if(!db) return;
        
        db.collection("policies").onSnapshot(snap => { 
            policies = [];
            snap.forEach(doc => { policies.push({ id: doc.id, ...doc.data() }); });
            renderTables(); 
        });
        
        db.collection("dsa_users").onSnapshot(snap => { users = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderTables(); });
        db.collection("dsa_requests").onSnapshot(snap => { requests = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderTables(); });
        
        db.collection("applications").onSnapshot(snap => { 
            apps = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); 
            
            // SORT: Newest Date First
            apps.sort((a, b) => {
                let dateA = parseDate(a.date || a.data?.date);
                let dateB = parseDate(b.date || b.data?.date);
                return dateB - dateA; 
            });

            renderTables(); 
        });
    }

    // --- 3. UPDATED RENDER TABLES (With Date Formatting) ---
    function renderTables() {
        // Policy Table
        const pT = document.querySelector('#policyTable tbody'); pT.innerHTML='';
        if (policies.length === 0) {
            pT.innerHTML = "<tr><td colspan='7'>No Policies Found. Click 'Load Defaults'.</td></tr>";
        } else {
            policies.forEach(p => {
                pT.innerHTML += `<tr><td>${p.bankName||'-'}</td><td>${p.prodType||'-'}</td><td>${p.loanMin}-${p.loanMax}</td><td>${p.tenMax}</td><td>${p.abbMin||'-'}</td><td>${p.roiMin}-${p.roiMax}</td>
                <td><button class="btn btn-edit" onclick="editPolicy('${p.id}')">Edit</button><button class="btn btn-del" onclick="delDoc('policies','${p.id}')">Del</button></td></tr>`;
            });
        }
        
        // User Table
        const uT = document.querySelector('#userTable tbody'); uT.innerHTML='';
        users.forEach(u => uT.innerHTML += `<tr><td>${u.name}</td><td>${u.mobile}</td><td>${u.user}</td><td>${u.pass}</td><td><button class="btn btn-del" onclick="delDoc('dsa_users','${u.id}')">Del</button></td></tr>`);
        
        // Request Table
        const rT = document.querySelector('#requestTable tbody'); rT.innerHTML='';
        requests.forEach(r => rT.innerHTML += `<tr><td>${r.name}</td><td>${r.mobile}</td><td>${r.user}</td><td><button class="btn btn-add" onclick="approveReq('${r.id}')">Approve</button></td></tr>`);
        
        // Application Table (Fixed Dates & Columns)
        const aT = document.querySelector('#appTable tbody'); 
        aT.innerHTML = '';
        apps.forEach(a => {
            let d = a.data || {}; 
            let dateObj = parseDate(a.date || d.date);
            let displayDate = formatDisplayDate(dateObj);

            aT.innerHTML += `
                <tr>
                    <td>${displayDate}</td>
                    <td>${a.customer || d.customer || '-'}</td>
                    <td>${a.mobile || d.mobile || '-'}</td>
                    <td>${d.vintage || '-'}</td>
                    <td>${d.turnover || '-'}</td>
                    <td>${d.entityType || '-'}</td>
                    <td>${d.sector || '-'}</td>
                    <td>${d.busPremises || '-'}</td>
                    <td>${d.abb || '-'}</td>
                    <td>${d.bankStmtType || '-'}</td>
                    <td>${d.gstReg || '-'}</td>
                    <td>${d.itrFiled || '-'}</td>
                    <td>${d.cibil || '-'}</td>
                    <td>${d.activeLoans || '-'}</td>
                    <td>${d.monthlyEmi || '-'}</td>
                    <td>${d.unsecLoans || '-'}</td>
                    <td>${d.loansTaken6m || '-'}</td>
                    <td>${d.loansClosing6m || '-'}</td>
                    <td>${d.reducedEmi6m || '-'}</td>
                    <td>${d.enquiries3m || '-'}</td>
                    <td>${d.age || '-'}</td>
                    <td>${d.gender || '-'}</td>
                    <td>${d.coApp || '-'}</td>
                    <td>${d.coAppAge || '-'}</td>
                    <td>${d.ownHouse || '-'}</td>
                    <td>${d.pincode || '-'}</td>
                    <td>${d.reqAmount || '-'}</td>
                    <td>${d.purpose || '-'}</td>
                    <td>${a.dsaName || d.dsaName || '-'}</td>
                </tr>`;
        });
    }
    // ACTIONS
    window.uploadDefaultPolicies = () => { if(confirm("Load Defaults?")) { defaultPolicies.forEach(p => db.collection("policies").add(p)); } };
    window.approveReq = (id) => { const r = requests.find(x => x.id === id); if(r) { db.collection("dsa_users").add({...r, status:"Active"}); db.collection("dsa_requests").doc(id).delete(); } };
    window.delDoc = (col, id) => { if(confirm("Delete?")) db.collection(col).doc(id).delete(); };

    window.saveUser = () => {
        const u = { name: document.getElementById('uName').value, mobile: document.getElementById('uMob').value, user: document.getElementById('uUser').value, pass: document.getElementById('uPass').value, status: "Active" };
        db.collection("dsa_users").add(u); closeModal('user');
    };

    window.savePolicy = () => {
        let bTypes = []; document.querySelectorAll('.bank-chk:checked').forEach(c => bTypes.push(c.value));
        // FIX: SAVING MIN/MAX per Program
        let progs = []; 
        document.querySelectorAll('#progContainer .dynamic-row').forEach(r => {
            let sel = r.querySelector('select').value;
            let inps = r.querySelectorAll('input');
            // 0: Val, 1: Min, 2: Max
            progs.push({type: sel, val: inps[0].value, min: inps[1].value, max: inps[2].value});
        });
        let conds = []; document.querySelectorAll('#condContainer .dynamic-row').forEach(r => { let i = r.querySelectorAll('input'); if(i[0].value) conds.push({name:i[0].value, val:i[1].value}); });

        const p = {
            bankName: document.getElementById('bankName').value, prodType: document.getElementById('prodType').value,
            loanMin: +document.getElementById('loanMin').value, loanMax: +document.getElementById('loanMax').value,
            tenMin: +document.getElementById('tenMin').value, tenMax: +document.getElementById('tenMax').value,
            roiMin: +document.getElementById('roiMin').value, roiMax: +document.getElementById('roiMax').value,
            pfMin: +document.getElementById('pfMin').value, pfMax: +document.getElementById('pfMax').value,
            
            minVin: +document.getElementById('minVin').value, minTurn: +document.getElementById('minTurn').value, 
            abbMin: +document.getElementById('abbMin').value, minCibil: +document.getElementById('minCibil').value,
            itrReq: document.getElementById('itrReq').value, gstReq: document.getElementById('gstReq').value,
            
            ageMin: +document.getElementById('ageMin').value, ageMax: +document.getElementById('ageMax').value,
            coAppReq: document.getElementById('coAppReq').value, coAgeMin: document.getElementById('coAgeMin').value, coAgeMax: document.getElementById('coAgeMax').value,
            houseReq: document.getElementById('houseReq').value, houseGeo: document.getElementById('houseGeo').value,
            
            maxUnsec: +document.getElementById('maxUnsec').value, maxActive: +document.getElementById('maxActive').value, 
            maxEnq: +document.getElementById('maxEnq').value, loans6m: +document.getElementById('loans6m').value,
            
            bankingTypes: bTypes, programs: progs, conditions: conds, 
            remarks: document.getElementById('remarks').value,
            geoLimit: document.getElementById('geoLimit').value,
            pinBased: document.getElementById('pinBased').value,
            pinScope: document.getElementById('pinScope').value
        };
        
        let idx = document.getElementById('p_id').value;
        if(idx) db.collection("policies").doc(idx).update(p); else db.collection("policies").add(p);
        closeModal('policy');
    };

    window.editPolicy = (id) => {
        let p = policies.find(x => x.id === id); if(!p) return;
        document.getElementById('p_id').value = id;
        document.getElementById('policyModalTitle').innerText = "Edit Policy";
        
        const setVal = (k, v) => { let el=document.getElementById(k); if(el) el.value = v || ''; };

        setVal('bankName', p.bankName); setVal('prodType', p.prodType); 
        setVal('itrReq', p.itrReq); setVal('gstReq', p.gstReq); setVal('coAppReq', p.coAppReq); setVal('houseReq', p.houseReq); 
        setVal('houseGeo', p.houseGeo); setVal('remarks', p.remarks);
        setVal('geoLimit', p.geoLimit);
        setVal('pinBased', p.pinBased);
        setVal('pinScope', p.pinScope);

        // Trigger the hidden box visibility
        toggleField('pinOptionBox', p.pinBased === 'Yes');
        
        ['loanMin','loanMax','tenMin','tenMax','roiMin','roiMax','pfMin','pfMax','minVin','minTurn','abbMin','minCibil','ageMin','ageMax','coAgeMin','coAgeMax','maxUnsec','maxActive','maxEnq','loans6m'].forEach(k => setVal(k, p[k]));
        
        // Populate Programs with Min/Max
        document.getElementById('progContainer').innerHTML='';
        if(p.programs && Array.isArray(p.programs)) {
            p.programs.forEach(pr => addProg(pr.type, pr.val, pr.min, pr.max));
        }
        
        document.getElementById('condContainer').innerHTML='';
        if(p.conditions && Array.isArray(p.conditions)) {
            p.conditions.forEach(c => addCond(c.name, c.val));
        }
        
        document.querySelectorAll('.bank-chk').forEach(c => c.checked = (p.bankingTypes||[]).includes(c.value));
        
        toggleField('coBox', p.coAppReq==='Yes');
        toggleField('houseGeoBox', p.houseReq==='Yes');
        
        document.getElementById('policyModal').style.display='flex';
    };

    window.showSection=(id)=>{document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');};
    window.openModal=(t)=>{
        if(t==='policy') { 
            document.getElementById('policyForm').reset(); 
            document.getElementById('p_id').value=''; 
            document.getElementById('policyModalTitle').innerText = "New Policy";
            document.getElementById('progContainer').innerHTML=''; 
            document.getElementById('condContainer').innerHTML=''; 
        } else { document.getElementById('userForm').reset(); document.getElementById('u_id').value=''; }
        document.getElementById(t+'Modal').style.display='flex';
    };
    window.closeModal=(t)=>document.getElementById(t+'Modal').style.display='none';
    window.toggleField=(id,s)=>document.getElementById(id).style.display=s?'block':'none';
    
    // UPDATED: ADD PROGRAM (With Min/Max Loan)
    window.addProg=(t='ABB',v='',min='',max='')=>document.getElementById('progContainer').insertAdjacentHTML('beforeend',`
        <div class="dynamic-row" style="align-items:center;">
            <select style="width:25%"><option ${t==='ABB'?'selected':''}>ABB</option><option ${t==='GST'?'selected':''}>GST</option><option ${t==='ITR'?'selected':''}>ITR</option><option ${t==='DSCR'?'selected':''}>DSCR</option></select>
            <input type="number" placeholder="Multiplier/Val" value="${v}" style="width:20%">
            <input type="number" placeholder="Min Loan (L)" value="${min}" style="width:20%">
            <input type="number" placeholder="Max Loan (L)" value="${max}" style="width:20%">
            <button class="btn btn-del" type="button" onclick="this.parentElement.remove()">X</button>
        </div>`);
        
    window.addCond=(n='', v='')=>document.getElementById('condContainer').insertAdjacentHTML('beforeend',`<div class="dynamic-row"><input type="text" placeholder="Name" value="${n}"><input type="text" placeholder="Value" value="${v}"><button class="btn btn-del" type="button" onclick="this.parentElement.remove()">X</button></div>`);

    let savedAdminPass = localStorage.getItem('admin_pass') || 'admin123';
    window.checkAdminLogin = () => { if(document.getElementById('adminLockPass').value === savedAdminPass) { sessionStorage.setItem('adminLoggedIn','true'); document.getElementById('loginOverlay').style.display='none'; } else alert("Wrong"); };
    window.updateAdminPass = () => { const p = document.getElementById('newAdminPass').value; if(p) { localStorage.setItem('admin_pass', p); savedAdminPass = p; alert("Updated"); } };
    window.logout = () => { sessionStorage.removeItem('adminLoggedIn'); location.reload(); };
    
    // --- UPDATED EXPORT TO EXCEL ---
    window.exportToExcel = () => {
        // 1. Define Headers
        let headers = [
            "Date", "Customer Name", "Contact Number", "Vintage", "Turnover", 
            "Entity type", "Sector", "Business Premises", "ABB", "Bank Statement type", 
            "GST Reg", "ITR Filed", "Cibil", "Active Loans", "Monthly EMI", 
            "Unsecured Loans", "Loans Taken (6Months)", "Loans Closing(Next 6Months)", 
            "Reduced EMI(Next 6 Months)", "Enquiries(3 Months)", "Applicant Age", 
            "Gender", "Co-Applicant?", "Co-Applicant Age", "Own House?", 
            "Own House Pincode", "Required Loan Amount(lakhs)", "Purpose", "DSA Name"
        ];

        // 2. Start CSV Content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += headers.join(",") + "\n";

        // 3. Loop through Data
        apps.forEach(a => {
            let d = a.data || {};
            let row = [
                a.date,
                a.customer,
                a.mobile || d.mobile,
                d.vintage,
                d.turnover,
                d.entityType,
                d.sector,
                d.busPremises,
                d.abb,
                d.bankStmtType,
                d.gstReg,
                d.itrFiled,
                d.cibil,
                d.activeLoans,
                d.monthlyEmi,
                d.unsecLoans,
                d.loansTaken6m,
                d.loansClosing6m,
                d.reducedEmi6m,
                d.enquiries3m,
                d.age,
                d.gender,
                d.coApp,
                d.coAppAge,
                d.ownHouse,
                d.pincode,
                d.reqAmount,
                d.purpose,
                a.dsaName
            ];

            // Clean data: replace undefined with empty string and remove commas inside text
            let cleanRow = row.map(item => {
                if (item === undefined || item === null) return "";
                return `"${String(item).replace(/"/g, '""')}"`;
            });

            csvContent += cleanRow.join(",") + "\n";
        });

        // 4. Trigger Download
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Loan_Applications.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    loadAllData();
</script>
</body>
</html>

