<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin (Cloud)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; height: 100vh; }
        #adminLoginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #004a99; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing:border-box; }
        .login-box button { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        #adminDashboard { display: none; width: 100%; height: 100%; display: flex; }
        .sidebar { width: 260px; background: #1a237e; color: white; display: flex; flex-direction: column; padding: 20px; }
        .nav-item { padding: 15px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; color: rgba(255,255,255,0.8); }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); color: white; font-weight: bold; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-active { background: #e8f5e9; color: #2e7d32; }
        .status-inactive { background: #eeeeee; color: #757575; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-right: 5px; }
        .btn-green { background: #28a745; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-orange { background: #ff9800; color: white; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .program-container { border: 1px dashed #1a237e; padding: 15px; margin-bottom: 10px; border-radius: 6px; background: #fff; }
        .custom-field-row { background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="adminLoginOverlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:#d32f2f">üõ°Ô∏è Admin Access</h2>
            <input type="text" id="adminUser" placeholder="Username">
            <input type="password" id="adminPass" placeholder="Password">
            <button id="btnAdminLogin">Unlock Dashboard</button>
            <p id="loginError" style="color:red; font-size:13px; margin-top:10px"></p>
        </div>
    </div>

    <div id="adminDashboard">
        <div class="sidebar">
            <h2>Super Admin</h2>
            <div class="nav-item active" id="tabUsers">üë• Manage Users</div>
            <div class="nav-item" id="tabPolicies">üè¶ Policy Library</div>
            <div class="nav-item" id="tabCreate">‚ûï Create Policy</div>
            <div class="nav-item" id="tabSettings">‚öôÔ∏è Settings</div>
            <div class="nav-item" style="margin-top:auto; background:#d32f2f; text-align:center" id="btnLogout">üîí Logout</div>
        </div>

        <div class="main-content">
            <div id="dsaTab">
                <h1 style="color:#1a237e">DSA User Management (Cloud)</h1>
                <div class="card"><div id="userTableContainer">Loading from Cloud...</div></div>
            </div>
            <div id="policyTab" class="hidden">
                <h1 style="color:#1a237e">Bank Policy Library (Cloud)</h1>
                <div class="card"><div id="policyTableContainer">Loading from Cloud...</div></div>
            </div>
            <div id="editorTab" class="hidden">
                <h1 style="color:#1a237e" id="editorTitle">Create New Policy</h1>
                <div class="card">
                    <input type="hidden" id="editId">
                    <label>Bank Name</label><input type="text" id="bankName" placeholder="e.g. HDFC Bank">
                    <h3>A. Basics</h3>
                    <div class="grid-row"><div><label>Product</label><select id="prodType"><option>Small Ticket</option><option>Big Ticket</option></select></div><div><label>Type</label><select id="loanType"><option>Term Loan</option><option>OD</option></select></div></div>
                    <div class="grid-row"><div><label>Loan Min</label><input type="number" id="loanMin"></div><div><label>Loan Max</label><input type="number" id="loanMax"></div></div>
                    <div class="grid-row"><div><label>Tenure Min</label><input type="number" id="tenureMin"></div><div><label>Tenure Max</label><input type="number" id="tenureMax"></div></div>
                    <div class="grid-row"><div><label>ROI Min</label><input type="number" id="roiMin"></div><div><label>ROI Max</label><input type="number" id="roiMax"></div></div>
                    <div class="grid-row"><div><label>PF Min</label><input type="number" id="pfMin"></div><div><label>PF Max</label><input type="number" id="pfMax"></div></div>
                    <div class="grid-row"><div><label>Geo Limit</label><input type="number" id="geoLimit"></div></div>
                    <h3>B. Applicant</h3>
                    <div class="grid-row"><div><label>Age Min</label><input type="number" id="ageMin"></div><div><label>Age Max</label><input type="number" id="ageMax"></div></div>
                    <div class="grid-row"><div><label>Co-App Mandatory?</label><select id="coAppStatus"><option value="No">No</option><option value="Yes">Yes</option></select></div></div>
                    <div class="grid-row"><div><label>Own House?</label><select id="houseStatus"><option value="Not Need">Not Need</option><option value="Need">Need</option></select></div></div>
                    <h3>C. Business</h3>
                    <div class="grid-row"><div><label>Vintage</label><input type="number" id="vintage"></div><div><label>Turnover Min</label><input type="number" id="turnoverMin"></div></div>
                    <div class="grid-row"><div><label>ABB Min</label><input type="number" id="abbMin"></div><div><label>Banking</label><select id="bankingType"><option>All (SA+CA+OD/CC)</option><option>SA Only</option><option>CA Only</option><option>OD/CC Only</option><option>SA + CA</option></select></div></div>
                    <div class="grid-row"><div><label>ITR Required?</label><select id="itrStatus"><option value="No">No</option><option value="Yes">Yes</option></select></div><div><label>ITR Min</label><input type="number" id="itrTurnover"></div></div>
                    <div class="grid-row"><div><label>GST Required?</label><select id="gstStatus"><option value="No">No</option><option value="Yes">Yes</option></select></div><div><label>GST Min</label><input type="number" id="gstTurnover"></div></div>
                    <h3>D. Credit</h3>
                    <div class="grid-row"><div><label>CIBIL Min</label><input type="number" id="cibilMin"></div><div><label>CIBIL Max</label><input type="number" id="cibilMax"></div></div>
                    <div class="grid-row"><div><label>Max Active Loans</label><input type="number" id="activeMax"></div><div><label>Max Enquiries</label><input type="number" id="enq6m"></div></div>
                    <h3>E. Programs</h3>
                    <div id="programsWrapper"></div><br><button class="btn btn-blue" id="btnAddProgT">Turnover</button> <button class="btn btn-blue" id="btnAddProgG">GST</button> <button class="btn btn-blue" id="btnAddProgB">ABB</button>
                    <h3>F. Remarks</h3>
                    <div id="customFieldsWrapper"></div><button class="btn btn-green" id="btnAddCust">Custom Field</button>
                    <textarea id="remarks" rows="3"></textarea>
                    <button class="btn" style="background:#1a237e;color:white;width:100%;padding:15px;margin-top:20px" id="btnSavePolicy">üíæ Save to Cloud</button>
                </div>
            </div>
            <div id="settingsTab" class="hidden">
                <h1 style="color:#1a237e">‚öôÔ∏è Admin Settings</h1>
                <div class="card">
                    <h3>Change Credentials</h3>
                    <input type="text" id="newAdminUser" placeholder="New Username">
                    <input type="password" id="newAdminPass" placeholder="New Password">
                    <button class="btn" style="background:#28a745; color:white; padding:10px 20px" id="btnUpdateCreds">‚úÖ Update</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // YOUR SPECIFIC KEYS
  const firebaseConfig = {
    apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
    authDomain: "credir-engine-new.firebaseapp.com",
    projectId: "credir-engine-new",
    storageBucket: "credir-engine-new.firebasestorage.app",
    messagingSenderId: "249073295308",
    appId: "1:249073295308:web:e3db899190a4d2506d0769",
    measurementId: "G-YBXMM1J129"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- SECURITY ---
  const getCreds = () => JSON.parse(localStorage.getItem('adminCreds')) || { user: 'admin', pass: 'admin123' };
  
  document.getElementById('btnAdminLogin').onclick = () => {
    if(document.getElementById('adminUser').value === getCreds().user && document.getElementById('adminPass').value === getCreds().pass) {
       document.getElementById("adminLoginOverlay").style.display = "none";
       document.getElementById("adminDashboard").style.display = "flex";
       loadUsers();
    } else { document.getElementById("loginError").innerText = "‚ùå Incorrect"; }
  };
  
  document.getElementById('btnLogout').onclick = () => location.reload();
  document.getElementById('btnUpdateCreds').onclick = () => {
     localStorage.setItem('adminCreds', JSON.stringify({ user: document.getElementById('newAdminUser').value, pass: document.getElementById('newAdminPass').value }));
     alert("Updated! Login again."); location.reload();
  };

  // --- NAVIGATION ---
  const tabs = { users: 'dsaTab', policies: 'policyTab', create: 'editorTab', settings: 'settingsTab' };
  const show = (t) => { Object.values(tabs).forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(t).classList.remove('hidden'); };
  document.getElementById('tabUsers').onclick = () => { show(tabs.users); loadUsers(); };
  document.getElementById('tabPolicies').onclick = () => { show(tabs.policies); loadPolicies(); };
  document.getElementById('tabCreate').onclick = () => { show(tabs.create); resetForm(); };
  document.getElementById('tabSettings').onclick = () => show(tabs.settings);

  // --- DATA LOADING ---
  async function loadUsers() {
    const el = document.getElementById('userTableContainer'); el.innerHTML = "Loading...";
    const snap = await getDocs(collection(db, "users"));
    if(snap.empty) { el.innerHTML = "No users."; return; }
    let h = `<table><tr><th>User</th><th>Status</th><th>Action</th></tr>`;
    snap.forEach(d => {
       const u = d.data(); const id = d.id;
       h += `<tr><td>${u.username}</td><td>${u.status}</td><td>
       ${u.status==='Pending' ? `<button class='btn btn-green' onclick="window.updUser('${id}','Active')">Approve</button>` : ''}
       <button class='btn btn-red' onclick="window.delUser('${id}')">Del</button></td></tr>`;
    });
    el.innerHTML = h + "</table>";
  }

  async function loadPolicies() {
    const el = document.getElementById('policyTableContainer'); el.innerHTML = "Loading...";
    const snap = await getDocs(collection(db, "policies"));
    if(snap.empty) { el.innerHTML = "No policies."; return; }
    let h = `<table><tr><th>Bank</th><th>Status</th><th>Action</th></tr>`;
    snap.forEach(d => {
       const p = d.data(); const id = d.id;
       h += `<tr><td>${p.bankName}</td><td>${p.isActive ? 'ACTIVE' : 'INACTIVE'}</td><td>
       <button class='btn ${p.isActive?'btn-orange':'btn-green'}' onclick="window.togPol('${id}',${!p.isActive})">${p.isActive?'Deactivate':'Activate'}</button>
       <button class='btn btn-red' onclick="window.delPol('${id}')">Del</button></td></tr>`;
    });
    el.innerHTML = h + "</table>";
  }

  // --- SAVE POLICY ---
  document.getElementById('btnAddProgT').onclick = () => addProgHTML('Turnover Method');
  document.getElementById('btnAddProgG').onclick = () => addProgHTML('GST Method');
  document.getElementById('btnAddProgB').onclick = () => addProgHTML('Banking Method');
  document.getElementById('btnAddCust').onclick = () => { document.getElementById('customFieldsWrapper').insertAdjacentHTML('beforeend', `<div class="grid-row custom-field-row"><input class="c-l" placeholder="Label"><input class="c-v" placeholder="Value"><button style="color:red" onclick="this.parentElement.remove()">X</button></div>`); };

  function addProgHTML(type) { document.getElementById('programsWrapper').insertAdjacentHTML('beforeend', `<div class="program-container" data-type="${type}"><b>${type}</b><div class="grid-row"><input class="p-min" placeholder="Min"><input class="p-max" placeholder="Max"></div><button onclick="this.parentElement.remove()">X</button></div>`); }

  document.getElementById('btnSavePolicy').onclick = async () => {
     const val = (id) => document.getElementById(id).value;
     const num = (id) => parseFloat(val(id)) || 0;
     const data = {
        bankName: val('bankName'), isActive: true,
        prodType: val('prodType'), loanType: val('loanType'),
        loanMin: num('loanMin'), loanMax: num('loanMax'), tenureMin: num('tenureMin'), tenureMax: num('tenureMax'),
        roiMin: num('roiMin'), roiMax: num('roiMax'), pfMin: num('pfMin'), pfMax: num('pfMax'), geoLimit: num('geoLimit'),
        ageMin: num('ageMin'), ageMax: num('ageMax'),
        coAppRequired: val('coAppStatus'), houseRequired: val('houseStatus'),
        vintage: num('vintage'), turnoverMin: num('turnoverMin'), abbMin: num('abbMin'), bankingType: val('bankingType'),
        itrRequired: val('itrStatus'), itrTurnover: num('itrTurnover'), gstRequired: val('gstStatus'), gstTurnover: num('gstTurnover'),
        cibilMin: num('cibilMin'), cibilMax: num('cibilMax'), activeMax: num('activeMax'), enq6m: num('enq6m'), remarks: val('remarks'),
        programs: []
     };
     document.querySelectorAll('.program-container').forEach(d => data.programs.push({type: d.dataset.type, minLoan: parseFloat(d.querySelector('.p-min').value)||0, maxLoan: parseFloat(d.querySelector('.p-max').value)||0}));
     
     await addDoc(collection(db, "policies"), data);
     alert("Saved to Cloud!"); show(tabs.policies); loadPolicies();
  };

  function resetForm() { document.querySelectorAll('input, textarea').forEach(e=>e.value=''); document.getElementById('programsWrapper').innerHTML=''; }

  // --- WINDOW FUNCTIONS (For onclicks) ---
  window.updUser = async (id, s) => { await updateDoc(doc(db, "users", id), {status: s}); loadUsers(); };
  window.delUser = async (id) => { if(confirm("Del?")) await deleteDoc(doc(db, "users", id)); loadUsers(); };
  window.togPol = async (id, s) => { await updateDoc(doc(db, "policies", id), {isActive: s}); loadPolicies(); };
  window.delPol = async (id) => { if(confirm("Del?")) await deleteDoc(doc(db, "policies", id)); loadPolicies(); };

</script>
</body>
</html>
