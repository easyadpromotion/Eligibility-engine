<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Loan Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; margin: 0; display: flex; height: 100vh; color: #333; }
        .sidebar { width: 260px; background: #1a237e; color: white; padding: 25px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* CARDS */
        .section-card { background: white; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; overflow: hidden; }
        .section-header { padding: 15px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; color: #1a237e; border-bottom: 1px solid #f0f0f0; }
        .section-body { padding: 25px; display: none; } .section-body.open { display: block; }

        /* INPUTS */
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* RESULTS */
        .check-btn { background: #1a237e; color: white; width: 100%; padding: 16px; font-size: 18px; margin-top: 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .bank-result-card { background: white; margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 6px solid #ccc; }
        .bank-result-header { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items:center; }
        .bank-result-body { padding: 15px; border-top: 1px solid #eee; background: #fafafa; }
        
        .status-eligible { border-left-color: #28a745; } .status-eligible .bank-result-header { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { border-left-color: #dc3545; } .status-rejected .bank-result-header { background: #ffebee; color: #c62828; }
        
        .offer-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .pdf-btn { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .bank-options { display: flex; gap: 10px; } .bank-opt { padding: 8px 15px; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; background: #f9f9f9; font-size: 13px; } .bank-opt.selected { background: #1a237e; color: white; border-color: #1a237e; }
        .hidden { display: none; }
        
        /* PDF TEMPLATE */
        #letterTemplate { display: none; padding: 40px; font-family: serif; background: white; color: black; line-height: 1.6; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:15px">üöÄ Credit Engine</h2>
        <div style="padding:12px; cursor:pointer" onclick="location.reload()">üìù New Application</div>
        <div style="padding:12px; cursor:pointer; margin-top:auto; background:#c62828; text-align:center; font-weight:bold" id="btnLogout">üö™ Logout</div>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h1 style="margin:0; color:#1a237e">Eligibility Calculator</h1>
            <div id="statusBadge" style="background:#e8f5e9; color:#2e7d32; padding:8px 15px; border-radius:20px; font-weight:bold; border:1px solid #c8e6c9">Connecting...</div>
        </div>

        <div class="section-card">
            <div class="section-header" onclick="toggle('sec1')"><span>1. Business Details</span> <span>‚ñº</span></div>
            <div id="sec1" class="section-body open">
                <div class="grid-row">
                    <div><label>Business Name</label><input type="text" id="custName"></div>
                    <div><label>Vintage (Years)</label><input type="number" id="vintage"></div>
                </div>
                <div class="grid-row">
                    <div><label>Annual Turnover (Lakhs)</label><input type="number" id="turnover"></div>
                    <div><label>Entity Type</label><select id="entityType"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option><option>Ltd</option><option>LLP</option></select></div>
                </div>
                <div class="grid-row">
                    <div><label>Business Sector (Margin)</label>
                        <select id="bizSector">
                            <option value="Trading">Trading (7% Margin)</option>
                            <option value="Manufacturing">Manufacturing (9% Margin)</option>
                            <option value="Service">Service (11% Margin)</option>
                        </select>
                    </div>
                    <div><label>Premises Type</label><select><option>Rented</option><option>Leased</option><option>Owned</option></select></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header" onclick="toggle('sec2')"><span>2. Banking & Docs</span> <span>‚ñº</span></div>
            <div id="sec2" class="section-body">
                <div class="grid-row">
                    <div><label>ABB (Average Bank Balance ‚Çπ)</label><input type="number" id="abb"></div>
                    <div><label>Bank Facilities</label>
                        <div class="bank-options">
                            <div class="bank-opt" onclick="togBank(this)">SA</div><div class="bank-opt" onclick="togBank(this)">CA</div><div class="bank-opt" onclick="togBank(this)">OD</div><div class="bank-opt" onclick="togBank(this)">CC</div>
                        </div>
                    </div>
                </div>
                <div class="grid-row">
                    <div><label>GST Registered?</label><select id="gstStatus" onchange="togVis('gstStatus','gstField')"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                    <div id="gstField" class="hidden"><label>GST Turnover (Lakhs)</label><input type="number" id="gstTurnover"></div>
                </div>
                <div class="grid-row">
                    <div><label>ITR Filed?</label><select id="itrStatus" onchange="togVis('itrStatus','itrField')"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                    <div id="itrField" class="hidden"><label>ITR Income (Lakhs)</label><input type="number" id="itrIncome"></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header" onclick="toggle('sec3')"><span>3. Credit Profile</span> <span>‚ñº</span></div>
            <div id="sec3" class="section-body">
                <div class="grid-row">
                    <div><label>CIBIL Score</label><input type="number" id="cibil"></div>
                    <div><label>Total Active Loans</label><input type="number" id="activeLoans"></div>
                </div>
                <div class="grid-row">
                    <div><label>Current Monthly EMI (‚Çπ)</label><input type="number" id="currentEmi"></div>
                    <div><label>Unsecured Loans Count</label><input type="number" id="unsecLoans"></div>
                </div>
                <div class="grid-row">
                    <div><label>Loans Closing (Next 6m)</label><input type="number" id="closingLoans"></div>
                    <div><label>EMI of Closing Loans (Next 6m)</label><input type="number" id="reducedEmi"></div>
                </div>
                <div class="grid-row">
                    <div><label>Enquiries (Last 3m)</label><input type="number" id="enquiries"></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header" onclick="toggle('sec4')"><span>4. Applicant</span> <span>‚ñº</span></div>
            <div id="sec4" class="section-body">
                <div class="grid-row">
                    <div><label>Applicant Age</label><input type="number" id="age"></div>
                    <div><label>Gender</label><select><option>Male</option><option>Female</option></select></div>
                </div>
                <div class="grid-row">
                    <div><label>Co-Applicant?</label><select id="coAppStatus" onchange="togVis('coAppStatus','coAppField')"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                    <div id="coAppField" class="hidden"><label>Co-Applicant Age</label><input type="number" id="coAppAge"></div>
                </div>
                <div class="grid-row">
                    <div><label>Own House?</label><select id="houseStatus" onchange="togVis('houseStatus','houseField')"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                    <div id="houseField" class="hidden"><label>House Pincode</label><input type="number"></div>
                </div>
            </div>
        </div>

        <button class="check-btn" id="btnCheck">‚ö° Check Eligibility (All Banks)</button>
        <div id="resultsArea"></div>
    </div>

    <div id="letterTemplate">
        <center><h2>IN-PRINCIPLE SANCTION</h2></center><hr>
        <p><b>Date:</b> <span id="pdfDate"></span></p>
        <p><b>To:</b> <span id="pdfCust"></span></p>
        <p><b>Bank:</b> <span id="pdfBank"></span></p>
        <div style="border:2px solid #000; padding:20px; margin:20px 0; background:#f9f9f9;">
            <h3 style="margin-top:0">‚úÖ Approved Amount: ‚Çπ<span id="pdfAmt"></span> Lakhs</h3>
            <p><b>Program:</b> <span id="pdfProg"></span></p>
            <p><b>Tenure:</b> <span id="pdfTenure"></span> Months</p>
        </div>
        <p><i>*This is a system generated estimate based on basic parameters. Final approval subject to credit verification.</i></p>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // --- CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
    authDomain: "credir-engine-new.firebaseapp.com",
    projectId: "credir-engine-new",
    storageBucket: "credir-engine-new.firebasestorage.app",
    messagingSenderId: "249073295308",
    appId: "1:249073295308:web:e3db899190a4d2506d0769",
    measurementId: "G-YBXMM1J129"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  if(!sessionStorage.getItem('currentUser')) window.location.href="index.html";
  document.getElementById('btnLogout').onclick = () => { sessionStorage.clear(); window.location.href="index.html"; };

  // --- UI UTILS ---
  window.toggle = (id) => { const el=document.getElementById(id); el.style.display=(el.style.display==='block')?'none':'block'; };
  window.togVis = (s,t) => { document.getElementById(t).style.display=(document.getElementById(s).value==='Yes')?'block':'none'; };
  window.togBank = (el) => { el.classList.toggle('selected'); };

  // --- FINANCIAL FORMULA (PV) ---
  function calculateLoanPV(ratePerMonth, tenureMonths, monthlyCapacity) {
    if(ratePerMonth <= 0) return 0;
    // PV = Pmt * (1 - (1 + r)^-n) / r
    return monthlyCapacity * (1 - Math.pow(1 + ratePerMonth, -tenureMonths)) / ratePerMonth;
  }

  // --- FETCH DATA ---
  let activePolicies = [];
  (async function() {
      try {
        const q = query(collection(db, "policies"), where("isActive", "==", true));
        const snap = await getDocs(q);
        snap.forEach(d => activePolicies.push(d.data()));
        document.getElementById('statusBadge').innerText = `${activePolicies.length} Banks Connected`;
      } catch(e) { console.error(e); document.getElementById('statusBadge').innerText = "Offline"; }
  })();

  // --- MAIN LOGIC ENGINE ---
  document.getElementById('btnCheck').onclick = () => {
    if(activePolicies.length === 0) { alert("No Policies found in Cloud."); return; }

    // 1. GATHER INPUTS
    const d = {
        name: document.getElementById('custName').value || 'Customer',
        sector: document.getElementById('bizSector').value,
        turnover: parseFloat(document.getElementById('turnover').value)||0,
        abb: parseFloat(document.getElementById('abb').value)||0,
        
        cibil: parseFloat(document.getElementById('cibil').value)||0,
        activeLoans: parseFloat(document.getElementById('activeLoans').value)||0,
        unsecLoans: parseFloat(document.getElementById('unsecLoans').value)||0,
        enquiries: parseFloat(document.getElementById('enquiries').value)||0,
        vintage: parseFloat(document.getElementById('vintage').value)||0,
        age: parseFloat(document.getElementById('age').value)||0,
        
        // Obligations
        currentEmi: parseFloat(document.getElementById('currentEmi').value)||0,
        reducedEmi: parseFloat(document.getElementById('reducedEmi').value)||0,

        // Statuses
        gstStatus: document.getElementById('gstStatus').value,
        itrStatus: document.getElementById('itrStatus').value,
        coAppStatus: document.getElementById('coAppStatus').value,
        houseStatus: document.getElementById('houseStatus').value
    };

    // 2. CALCULATE FINANCIALS (NET INCOME)
    let margin = 0.11; // Default Service
    if(d.sector === 'Trading') margin = 0.07;
    if(d.sector === 'Manufacturing') margin = 0.09;

    let monthlyProfit = (d.turnover * 100000 * margin) / 12; // Turnover to Rupees
    let netObligation = Math.max(0, d.currentEmi - d.reducedEmi);
    let disposableIncome = Math.max(0, monthlyProfit - netObligation);

    const resArea = document.getElementById('resultsArea'); 
    resArea.innerHTML = "";

    // 3. LOOP THROUGH EVERY POLICY
    activePolicies.forEach(p => {
        let reasons = [];
        let offers = [];

        // --- STEP A: PARAMETER GATEKEEPER (REJECTION LOGIC) ---
        // If any of these fail, we STOP for this bank.
        
        if(d.cibil < p.cibilMin) reasons.push(`CIBIL Low (${d.cibil} < ${p.cibilMin})`);
        if(d.vintage < p.vintage) reasons.push(`Vintage Low (${d.vintage} < ${p.vintage})`);
        if(d.turnover < p.turnoverMin) reasons.push(`Turnover Low (${d.turnover} < ${p.turnoverMin})`);
        if(d.activeLoans > p.activeMax) reasons.push(`Excess Active Loans (${d.activeLoans})`);
        if(d.enquiries > p.enq6m) reasons.push(`Excess Enquiries (${d.enquiries})`);
        if(d.age < p.ageMin || d.age > p.ageMax) reasons.push(`Age Mismatch`);

        // Hard Stops
        if(p.gstRequired === 'Yes' && d.gstStatus === 'No') reasons.push("GST Required");
        if(p.itrRequired === 'Yes' && d.itrStatus === 'No') reasons.push("ITR Required");
        if(p.coAppRequired === 'Yes' && d.coAppStatus === 'No') reasons.push("Co-App Required");
        if(p.houseRequired === 'Need' && d.houseStatus === 'No') reasons.push("Own House Required");

        // --- STEP B: FINANCIAL FORMULAS (ONLY IF PASSED GATEKEEPER) ---
        if(reasons.length === 0 && p.programs) {
            
            // Get ROI and Tenure from Policy
            let annualRoi = p.roiMin || 18; 
            let monthlyRate = (annualRoi / 100) / 12;
            let tenure = p.tenureMax || 36;

            p.programs.forEach(prog => {
                let loanAmt = 0;

                // 1. ABB PROGRAM (Using PV Formula on ABB Balance)
                // Assuming ABB is net capacity for EMI
                if(prog.type.includes('Banking') || prog.type.includes('ABB')) {
                    loanAmt = calculateLoanPV(monthlyRate, tenure, d.abb); 
                }

                // 2. DSCR / TURNOVER PROGRAM (Using PV Formula on Net Disposable Income)
                else if(prog.type.includes('Turnover') || prog.type.includes('GST')) {
                    loanAmt = calculateLoanPV(monthlyRate, tenure, disposableIncome);
                }

                // Convert to Lakhs & Apply Limits
                let finalLakhs = loanAmt / 100000;
                let cap = Math.min(p.loanMax, prog.maxLoan || 999);
                finalLakhs = Math.min(finalLakhs, cap);

                // Add to offers if > Min Loan
                if(finalLakhs >= p.loanMin && finalLakhs > 0) {
                    offers.push({ type: prog.type, amt: finalLakhs.toFixed(2), tenure: tenure });
                }
            });

            if(offers.length === 0) reasons.push("Eligibility Zero (Low Income/ABB)");
        }

        // --- STEP C: DISPLAY RESULT ---
        let html = `<div class="bank-result-card ${offers.length>0?'status-eligible':'status-rejected'}">
            <div class="bank-result-header">
                <span>${offers.length>0?'‚úÖ':'‚ùå'} ${p.bankName}</span>
                ${offers.length>0 ? `<button class="pdf-btn" onclick="window.printPDF('${p.bankName}','${offers[0].amt}','${offers[0].type}','${offers[0].tenure}')">üìÑ PDF</button>`:''}
            </div>
            <div class="bank-result-body">`;
        
        if(offers.length > 0) {
            offers.forEach(o => {
                html += `<div class="offer-row"><span><b>${o.type}</b></span> <span>‚Çπ${o.amt} Lakhs</span></div>`;
            });
        } else {
            // Show the exact rejection reasons
            html += `<div style="color:#c62828; font-size:13px"><b>Declined:</b> ${reasons.join(', ')}</div>`;
        }
        html += `</div></div>`;
        resArea.insertAdjacentHTML('beforeend', html);
    });
  };

  // --- PDF GENERATOR ---
  window.printPDF = (bank, amt, prog, tenure) => {
    document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    document.getElementById('pdfBank').innerText
