<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Engine Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body{margin:0;font-family:'Roboto',sans-serif;background:#f0f2f5;display:flex;height:100vh}
        .sidebar{width:260px;background:#1a237e;color:#fff;padding:25px;display:flex;flex-direction:column;box-shadow:4px 0 15px rgba(0,0,0,0.1)}
        .nav-item{padding:14px;margin-bottom:10px;cursor:pointer;border-radius:8px;transition:0.2s;display:flex;align-items:center;gap:10px}
        .nav-item:hover{background:#3949ab} .nav-item.active{background:#3949ab;border-left:5px solid #ffeb3b;font-weight:bold}
        .main-content{flex:1;padding:30px;overflow-y:auto}
        .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
        .accordion{background:#fff;border-radius:8px;margin-bottom:15px;border:1px solid #e0e0e0;overflow:hidden}
        .accordion-header{padding:15px 20px;font-weight:600;cursor:pointer;background:#fafafa;border-bottom:1px solid #eee}
        .accordion-body{padding:20px;display:none} .accordion-body.open{display:block}
        input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .bank-options{display:flex;gap:10px;margin-top:5px}
        .bank-opt{padding:8px 16px;border:1px solid #ddd;border-radius:20px;cursor:pointer;background:#fff;font-size:13px}
        .bank-opt:hover{background:#f5f5f5} .bank-opt.selected{background:#1a237e;color:#fff;border-color:#1a237e}
        .btn{width:100%;padding:15px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:15px;color:#fff}
        .btn-green{background:#2e7d32} .btn-blue{background:#0288d1;display:none}
        .hidden-field{display:none;background:#f8f9fa;padding:15px;border:1px dashed #ccc;margin-top:10px}
        .auto-filled{background:#e8f5e9;color:#2e7d32;font-weight:bold}
        /* PDF STYLES */
        #pdfModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;overflow-y:auto}
        .paper{background:#fff;width:800px;margin:30px auto;padding:40px;min-height:90vh;position:relative;font-family:Arial,sans-serif}
        .p-head{text-align:center;border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:20px}
        .p-title{font-size:22px;font-weight:bold;color:#1a237e}
        .p-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;font-size:13px;border:1px solid #eee;padding:15px}
        .p-row{display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:3px 0}
        .p-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
        .p-table th{background:#f0f0f0;padding:8px;border:1px solid #333;text-align:center}
        .p-table td{padding:8px;border:1px solid #333;text-align:center}
        .sect{margin-top:20px;font-weight:bold;font-size:14px;border-left:4px solid #1a237e;padding-left:10px;background:#f9f9f9;padding:5px}
        @media print{.no-print{display:none} #pdfModal{position:absolute;background:#fff} .paper{width:100%;margin:0;box-shadow:none}}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="margin-bottom:30px">ðŸš€ DSA Portal</h2>
        <div class="nav-item active" id="nav-app" onclick="view('app')">ðŸ“„ New Application</div>
        <div class="nav-item" id="nav-dash" onclick="view('dash')">ðŸ“Š Dashboard</div>
        <div class="nav-item" style="margin-top:auto;background:#c62828" onclick="logout()">ðŸšª Logout</div>
    </div>

    <div class="main-content">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px">
            <h2 id="welcome">Welcome</h2><div style="color:#1a237e;font-weight:bold">Policies: <span id="pCount">0</span></div>
        </div>

        <div id="appView">
            <div class="accordion"><div class="accordion-header" onclick="toggle(this)">1. Business Details</div><div class="accordion-body open"><div class="form-grid">
                <div><label>Name</label><input type="text" class="d" data-l="Business Name"></div>
                <div><label>Contact</label><input type="number" class="d" data-l="Contact"></div>
                <div><label>Vintage (Yrs)</label><input type="number" class="d" data-l="Vintage"></div>
                <div><label>Turnover (Lakhs)</label><input type="number" class="d" data-l="Turnover" placeholder="e.g. 120"></div>
                <div><label>Entity</label><select class="d" data-l="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option></select></div>
                <div><label>Sector</label><select class="d" data-l="Sector" id="sec"><option value="Trading">Trading</option><option value="Manufacturing">Manufacturing</option><option value="Service">Service</option></select></div>
                <div><label>Premises</label><select class="d" data-l="Premises"><option>Owned</option><option>Rented</option></select></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="toggle(this)">2. Banking</div><div class="accordion-body"><div class="form-grid">
                <div><label>ABB (Balance)</label><input type="number" class="d" data-l="ABB"></div>
                <div style="grid-column:span 2"><label>Bank Stmts</label><div class="bank-options"><span class="bank-opt" onclick="this.classList.toggle('selected')">SA</span><span class="bank-opt" onclick="this.classList.toggle('selected')">CA</span><span class="bank-opt" onclick="this.classList.toggle('selected')">OD</span><span class="bank-opt" onclick="this.classList.toggle('selected')">CC</span></div></div>
                <div><label>GST?</label><select class="d" data-l="GST Reg" onchange="showIf(this.value=='Yes','gstB')"><option>No</option><option>Yes</option></select></div><div id="gstB" class="hidden-field"><input type="number" class="d" data-l="GST Turnover" placeholder="GST Turnover"></div>
                <div><label>ITR?</label><select class="d" data-l="ITR Filed" onchange="showIf(this.value=='Yes','itrB')"><option>No</option><option>Yes</option></select></div><div id="itrB" class="hidden-field"><input type="number" class="d" data-l="ITR Income" placeholder="Income"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="toggle(this)">3. Credit</div><div class="accordion-body"><div class="form-grid">
                <div><label>CIBIL</label><input type="number" class="d" data-l="CIBIL"></div>
                <div><label>Active Loans</label><input type="number" class="d" data-l="Active Loans"></div>
                <div><label>Monthly EMI</label><input type="number" class="d" data-l="Monthly EMI"></div>
                <div><label>Unsec Loans</label><input type="number" class="d" data-l="Unsec Loans"></div>
                <div><label>Loans (6m)</label><input type="number" class="d" data-l="Loans (6m)"></div>
                <div><label>Enquiries (3m)</label><input type="number" class="d" data-l="Enquiries"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="toggle(this)">4. Applicant</div><div class="accordion-body"><div class="form-grid">
                <div><label>Age</label><input type="number" class="d" data-l="Age"></div>
                <div><label>Co-App?</label><select class="d" data-l="Co-App" onchange="showIf(this.value=='Yes','coB')"><option>No</option><option>Yes</option></select></div><div id="coB" class="hidden-field"><input type="number" class="d" data-l="Co-App Age" placeholder="Co-App Age"></div>
                <div><label>House?</label><select class="d" data-l="Own House" onchange="showIf(this.value=='Yes','hB')"><option>No</option><option>Yes</option></select></div>
                <div id="hB" class="hidden-field" style="display:none;grid-column:span 3;gap:10px;grid-template-columns:1fr 1fr 1fr">
                    <input type="number" class="d" data-l="Pincode" id="pin" placeholder="Pincode" oninput="getPin()">
                    <input class="d auto-filled" data-l="City" id="city" readonly><input class="d auto-filled" data-l="State" id="state" readonly>
                </div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="toggle(this)">5. Requirements</div><div class="accordion-body"><div class="form-grid">
                <div><label>Amount (Lakhs)</label><input type="number" class="d" data-l="Req Amount"></div>
                <div><label>Purpose</label><input type="text" class="d" data-l="Purpose"></div>
            </div></div></div>

            <button class="btn btn-green" onclick="check()">âš¡ Check Eligibility</button>
            <button class="btn btn-blue" id="dlBtn" onclick="printPDF()">ðŸ“„ Download Offer Letter</button>
            <div id="resBox" style="margin-top:15px;font-weight:bold"></div>
        </div>

        <div id="dashView" style="display:none">
            <h2>Dashboard</h2>
            <div style="background:#fff;padding:20px;border-radius:8px">
                <table style="width:100%;border-collapse:collapse" id="hist"><thead><tr style="background:#eee;text-align:left"><th>Date</th><th>Customer</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="pdfModal"><div class="paper">
        <div class="no-print" style="text-align:right"><button onclick="document.getElementById('pdfModal').style.display='none'">Close</button><button onclick="window.print()" style="margin-left:10px;background:#1a237e;color:white;border:none;padding:5px 10px;cursor:pointer">Print</button></div>
        <div class="p-head"><div class="p-title">PROVISIONAL OFFER LETTER</div><div id="pDate" style="font-size:12px;margin-top:5px"></div></div>
        <div class="sect">APPLICATION DETAILS</div><div id="pGrid" class="p-grid"></div>
        <div class="sect">ELIGIBILITY SUMMARY</div><table class="p-table"><thead><tr><th>Bank</th><th>Program</th><th>Amount</th><th>Tenure</th><th>ROI</th></tr></thead><tbody id="pElig"></tbody></table>
        <div class="sect">DECLINED BANKS</div><table class="p-table"><thead><tr><th>Bank</th><th>Reason</th></tr></thead><tbody id="pDecl"></tbody></table>
    </div></div>

    <script>
        const cfg={apiKey:"AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",authDomain:"credir-engine-new.firebaseapp.com",projectId:"credir-engine-new",storageBucket:"credir-engine-new.firebasestorage.app",messagingSenderId:"249073295308",appId:"1:249073295308:web:e3db899190a4d2506d0769",measurementId:"G-YBXMM1J129"};
        try{firebase.initializeApp(cfg);var db=firebase.firestore()}catch(e){}
        
        let user=JSON.parse(sessionStorage.getItem('active_dsa_user'));
        if(!user)window.location.href="index.html";
        document.getElementById('welcome').innerText=`Welcome, ${user.name}`;
        if(db)db.collection('policies').get().then(s=>document.getElementById('pCount').innerText=s.size);

        let gData={}, gRes={};

        function view(v){
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(v=='app'?'nav-app':'nav-dash').classList.add('active');
            document.getElementById('appView').style.display=v=='app'?'block':'none';
            document.getElementById('dashView').style.display=v=='dash'?'block':'none';
            if(v=='dash') loadHist();
        }
        function toggle(e){e.nextElementSibling.classList.toggle('open')}
        function showIf(cond,id){ document.getElementById(id).style.display=cond?'grid':'none'; }
        function logout(){ sessionStorage.clear(); window.location.reload(); }
        
        async function getPin(){
            let p=document.getElementById('pin').value;
            if(p.length==6){
                try{
                    let r=await fetch(`https://api.postalpincode.in/pincode/${p}`);
                    let d=await r.json();
                    if(d[0].Status=="Success"){
                        document.getElementById('city').value=d[0].PostOffice[0].District;
                        document.getElementById('state').value=d[0].PostOffice[0].State;
                    }
                }catch(e){}
            }
        }

        async function check(){
            gData={};
            document.querySelectorAll('.d').forEach(e=>gData[e.getAttribute('data-l')]=e.value);
            let stmts=[]; document.querySelectorAll('.bank-opt.selected').forEach(e=>stmts.push(e.innerText));
            gData['Bank Statements']=stmts.join(', ');
            
            // Math
            let turn=(parseFloat(gData['Turnover']||0))*100000;
            let mar=document.getElementById('sec').value.startsWith('Trading')?0.07:0.10;
            let emi=parseFloat(gData['Monthly EMI']||0);
            let net=(turn/12*mar)-emi;
            
            let pols=[];
            if(db){let s=await db.collection('policies').get(); pols=s.docs.map(d=>d.data());}
            
            let elig=[],decl=[];
            pols.forEach(p=>{
                let pass=true, r=[];
                if(parseFloat(gData['Vintage'])<p.minVin){pass=false;r.push(`Vintage<${p.minVin}`);}
                if((turn/100000)<p.minTurn){pass=false;r.push(`Turnover<${p.minTurn}L`);}
                if(parseFloat(gData['CIBIL'])<p.minCibil){pass=false;r.push(`CIBIL<${p.minCibil}`);}
                
                if(pass){
                    let amt=Math.min((p.loanMax||50)*100000, net*(p.tenMax||36));
                    amt=Math.max(amt, (p.loanMin||1)*100000);
                    elig.push({b:p.bankName,p:p.prodType,a:(amt/100000).toFixed(2),t:p.tenMax,r:p.roiMin});
                }else{decl.push({b:p.bankName,r:r.join(', ')})}
            });

            gRes={elig,decl};
            document.getElementById('resBox').innerHTML=`<span style="color:${elig.length?'green':'red'}">${elig.length?elig.length+' Banks Eligible':'No Banks Eligible'}</span>`;
            document.getElementById('dlBtn').style.display='block';
            
            if(db)db.collection('applications').add({date:new Date().toLocaleDateString(),customer:gData['Business Name'],dsaUsername:user.user,status:elig.length?'Eligible':'Declined',data:gData,results:gRes});
        }

        function fmt(n, type){
            if(!n) return '-';
            if(type=='curr') return 'â‚¹ '+parseFloat(n).toLocaleString('en-IN');
            if(type=='lakh') return 'â‚¹ '+n+' Lakhs';
            return n;
        }

        function printPDF(){
            if(!gData['Business Name']){alert("No data!");return;}
            document.getElementById('pDate').innerText = "Date: "+new Date().toLocaleDateString();
            
            // Grid
            let h="";
            for(let k in gData) h+=`<div class="p-row"><span>${k}</span><b>${['Turnover','Req Amount'].includes(k)?fmt(gData[k],'lakh'):(k=='Monthly EMI'?fmt(gData[k],'curr'):gData[k])}</b></div>`;
            document.getElementById('pGrid').innerHTML=h;

            // Eligible
            let eh="";
            if(gRes.elig.length) gRes.elig.forEach(x=>eh+=`<tr><td>${x.b}</td><td>${x.p}</td><td>${fmt(x.a,'lakh')}</td><td>${x.t} m</td><td>${x.r}%</td></tr>`);
            else eh="<tr><td colspan='5'>No Eligible Banks</td></tr>";
            document.getElementById('pElig').innerHTML=eh;

            // Declined
            let rh="";
            if(gRes.decl.length) gRes.decl.forEach(x=>rh+=`<tr><td>${x.b}</td><td>${x.r}</td></tr>`);
            else rh="<tr><td colspan='2'>No Rejections</td></tr>";
            document.getElementById('pDecl').innerHTML=rh;

            document.getElementById('pdfModal').style.display='block';
        }

        async function loadHist(){
            let t=document.querySelector('#hist tbody'); t.innerHTML="<tr><td colspan='4'>Loading...</td></tr>";
            if(db){
                let s=await db.collection('applications').where('dsaUsername','==',user.user).orderBy('date','desc').get();
                t.innerHTML="";
                s.docs.forEach((d,i)=>{
                    let v=d.data();
                    let r=t.insertRow();
                    r.innerHTML=`<td>${v.date}</td><td>${v.customer}</td><td>${v.status}</td><td><button onclick='loadSaved(${JSON.stringify(v)})'>View</button></td>`;
                });
            }
        }
        function loadSaved(v){ gData=v.data; gRes=v.results; printPDF(); }
    </script>
</body>
</html>
