<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Engine Pro - User</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CLEAN MINIMAL STYLES */
        body{margin:0;font-family:'Roboto',sans-serif;background:#f0f2f5;display:flex;height:100vh}
        .side{width:260px;background:#1a237e;color:#fff;padding:25px;display:flex;flex-direction:column}
        .nav{padding:12px;margin-bottom:10px;cursor:pointer;border-radius:6px;transition:0.2s}
        .nav:hover{background:#3949ab} .nav.active{background:#3949ab;border-left:4px solid #ffeb3b;font-weight:bold}
        .main{flex:1;padding:30px;overflow-y:auto}
        
        /* CARDS & FORMS */
        .card{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #ddd;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
        .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
        input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        .b-opts{display:flex;gap:10px} .b-opt{padding:8px 16px;border:1px solid #ccc;border-radius:20px;cursor:pointer;background:#fff}
        .b-opt.selected{background:#1a237e;color:#fff;border-color:#1a237e}
        
        .btn{width:100%;padding:15px;border:none;border-radius:6px;font-size:16px;font-weight:bold;cursor:pointer;color:#fff;margin-top:15px}
        .btn-g{background:#2e7d32} .btn-b{background:#0288d1;display:none}
        .hide{display:none} .auto{background:#e8f5e9;color:#2e7d32;font-weight:bold}

        /* PDF MODAL - FIXED FOR MULTI-PAGE */
        #pdf{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9000;overflow-y:auto}
        .paper{background:#fff;width:210mm;min-height:297mm;margin:30px auto;padding:40px;position:relative;font-family:'Times New Roman',serif}
        .p-head{text-align:center;border-bottom:2px solid #000;padding-bottom:15px;margin-bottom:20px}
        .p-title{font-size:24px;font-weight:bold;color:#1a237e}
        .p-tbl{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
        .p-tbl th,.p-tbl td{border:1px solid #000;padding:8px;text-align:center}
        .p-tbl th{background:#eee}
        .p-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;margin-bottom:20px;border:1px solid #ccc;padding:15px}
        .p-row{display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:4px 0}

        /* CRITICAL PRINT FIX */
        @media print{
            body>*{display:none} #pdf{display:block!important;position:absolute;top:0;left:0;width:100%;height:auto;overflow:visible;background:#fff;z-index:9999}
            .paper{width:100%;max-width:100%;margin:0;padding:20px;box-shadow:none;min-height:auto}
            .no-print{display:none} table{page-break-inside:auto} tr{page-break-inside:avoid;page-break-after:auto}
        }
    </style>
</head>
<body>
    <div class="side">
        <h2 style="margin-bottom:30px">ðŸš€ DSA Portal</h2>
        <div class="nav active" id="n-app" onclick="view('app')">ðŸ“„ New Application</div>
        <div class="nav" id="n-dash" onclick="view('dash')">ðŸ“Š Dashboard</div>
        <div class="nav" style="margin-top:auto;background:#c62828" onclick="logout()">ðŸšª Logout</div>
    </div>

    <div class="main">
        <div id="v-app">
            <div class="card"><h3>1. Business</h3><div class="grid">
                <input class="d" data-l="Business Name" placeholder="Business Name">
                <input type="number" class="d" data-l="Contact" placeholder="Contact">
                <input type="number" class="d" data-l="Vintage" placeholder="Vintage (Yrs)">
                <input type="number" class="d" data-l="Turnover" placeholder="Turnover (Lakhs)">
                <select class="d" data-l="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option></select>
                <select class="d" data-l="Sector" id="sec"><option>Trading</option><option>Manufacturing</option><option>Service</option></select>
                <select class="d" data-l="Premises"><option>Owned</option><option>Rented</option></select>
            </div></div>

            <div class="card"><h3>2. Financials</h3><div class="grid">
                <input type="number" class="d" data-l="ABB" placeholder="Avg Bank Bal">
                <input type="number" class="d" data-l="Monthly EMI" placeholder="Monthly EMI">
                <div style="grid-column:span 2"><div class="b-opts"><span class="b-opt" onclick="this.classList.toggle('selected')">SA</span><span class="b-opt" onclick="this.classList.toggle('selected')">CA</span><span class="b-opt" onclick="this.classList.toggle('selected')">OD</span><span class="b-opt" onclick="this.classList.toggle('selected')">CC</span></div></div>
                <select class="d" data-l="GST Reg"><option value="No">GST: No</option><option value="Yes">GST: Yes</option></select>
                <select class="d" data-l="ITR Filed"><option value="No">ITR: No</option><option value="Yes">ITR: Yes</option></select>
            </div></div>

            <div class="card"><h3>3. Credit & App</h3><div class="grid">
                <input type="number" class="d" data-l="CIBIL" placeholder="CIBIL">
                <input type="number" class="d" data-l="Age" placeholder="Age">
                <select class="d" data-l="Co-App"><option value="No">Co-App: No</option><option value="Yes">Co-App: Yes</option></select>
                <select class="d" data-l="Own House"><option value="No">House: No</option><option value="Yes">House: Yes</option></select>
                <input type="number" class="d" data-l="Req Amount" placeholder="Req Amount (Lakhs)">
                <input class="d" data-l="Purpose" placeholder="Purpose">
                <input type="number" class="d" data-l="Pincode" placeholder="Pincode" oninput="pin(this.value)">
                <input class="d auto" data-l="City" id="city" readonly><input class="d auto" data-l="State" id="state" readonly>
            </div></div>

            <button class="btn btn-g" onclick="check()">âš¡ Check Eligibility</button>
            <button class="btn btn-b" id="pdfBtn" onclick="printPDF()">ðŸ“„ Download Offer Letter</button>
            <div id="res" style="margin-top:15px;font-weight:bold;font-size:18px"></div>
        </div>

        <div id="v-dash" class="hide">
            <div class="card"><h3>History</h3><table style="width:100%;border-collapse:collapse" id="hist"></table></div>
        </div>
    </div>

    <div id="pdf"><div class="paper">
        <div class="no-print" style="text-align:right">
            <button onclick="document.getElementById('pdf').style.display='none'">Close</button>
            <button onclick="window.print()" style="background:#1a237e;color:white;border:none;padding:5px 10px;margin-left:10px">Print</button>
        </div>
        <div class="p-head"><div class="p-title">PROVISIONAL OFFER LETTER</div><div id="pDate"></div></div>
        <div style="font-weight:bold;background:#eee;padding:5px;margin-bottom:10px">APPLICATION DETAILS</div>
        <div id="pDet" class="p-grid"></div>
        <div style="font-weight:bold;background:#eee;padding:5px;margin-bottom:10px">ELIGIBILITY</div>
        <table class="p-tbl"><thead><tr><th>Bank</th><th>Program</th><th>Amount</th><th>Tenure</th><th>ROI</th></tr></thead><tbody id="pElig"></tbody></table>
        <br><div style="font-weight:bold;background:#eee;padding:5px;margin-bottom:10px">DECLINED</div>
        <table class="p-tbl"><thead><tr><th>Bank</th><th>Reason</th></tr></thead><tbody id="pRej"></tbody></table>
    </div></div>

<script>
    const cfg={apiKey:"AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",projectId:"credir-engine-new",appId:"1:249073295308:web:e3db899190a4d2506d0769"};
    try{firebase.initializeApp(cfg);var db=firebase.firestore()}catch(e){}
    
    let user=JSON.parse(sessionStorage.getItem('active_dsa_user'));
    if(!user) window.location.href="index.html";

    let gData={}, gRes={};

    function view(v){
        document.querySelectorAll('.nav').forEach(e=>e.classList.remove('active'));
        document.getElementById('n-'+v).classList.add('active');
        document.getElementById('v-app').style.display=v=='app'?'block':'none';
        document.getElementById('v-dash').style.display=v=='dash'?'block':'none';
        if(v=='dash') loadH();
    }
    function logout(){sessionStorage.clear();location.reload()}
    async function pin(p){if(p.length==6){try{let r=await fetch(`https://api.postalpincode.in/pincode/${p}`);let d=await r.json();if(d[0].Status=='Success'){document.getElementById('city').value=d[0].PostOffice[0].District;document.getElementById('state').value=d[0].PostOffice[0].State;}}catch(e){}}}

    async function check(){
        gData={}; document.querySelectorAll('.d').forEach(e=>gData[e.getAttribute('data-l')]=e.value);
        let stmts=[]; document.querySelectorAll('.b-opt.selected').forEach(e=>stmts.push(e.innerText));
        gData['Bank Statements']=stmts.join(', ');

        let turn=parseFloat(gData['Turnover']||0)*100000;
        let emi=parseFloat(gData['Monthly EMI']||0);
        let mar=document.getElementById('sec').value=='Trading'?0.07:0.10;
        let net=(turn/12*mar)-emi;

        let pols=[]; if(db){let s=await db.collection('policies').get(); pols=s.docs.map(d=>d.data());}
        let elig=[], decl=[];

        pols.forEach(p=>{
            let pass=true, r=[];
            if(parseFloat(gData['Vintage'])<p.minVin) { pass=false; r.push(`Vintage<${p.minVin}`); }
            if((turn/100000)<p.minTurn) { pass=false; r.push(`Turnover<${p.minTurn}L`); }
            
            if(pass){
                let amt=Math.min((p.loanMax||50)*100000, net*(p.tenMax||36));
                amt=Math.max(amt, (p.loanMin||1)*100000);
                elig.push({b:p.bankName, p:p.prodType, a:(amt/100000).toFixed(2), t:p.tenMax, r:p.roiMin});
            } else decl.push({b:p.bankName, r:r.join(', ')});
        });

        gRes={elig, decl};
        let txt = elig.length ? `<span style="color:green">Eligible (${elig.length} Banks)</span>` : `<span style="color:red">Declined</span>`;
        document.getElementById('res').innerHTML=txt;
        document.getElementById('pdfBtn').style.display='block';
        
        if(db) db.collection('applications').add({date:new Date().toLocaleDateString(), customer:gData['Business Name'], status:elig.length?'Eligible':'Declined', dsaUsername:user.user, data:gData, results:gRes});
    }

    function printPDF(){
        if(!gData['Business Name']) return alert("No Data");
        document.getElementById('pDate').innerText="Date: "+new Date().toLocaleDateString();
        
        // FORMAT DATA FOR PDF
        let h=""; 
        for(let k in gData){
            let v = gData[k];
            if(k.includes('Turnover')||k.includes('Amount')) v = `â‚¹ ${v} Lakhs`; // Fixed: Added â‚¹ and Lakhs
            if(k.includes('EMI')||k.includes('ABB')) v = `â‚¹ ${parseFloat(v).toLocaleString('en-IN')}`; // Fixed: Added Commas
            if(v && k!=='DSA Username') h+=`<div class="p-row"><span>${k}</span><b>${v}</b></div>`;
        }
        document.getElementById('pDet').innerHTML=h;

        // TABLES
        let et=""; 
        if(gRes.elig.length) gRes.elig.forEach(x=>et+=`<tr><td>${x.b}</td><td>${x.p}</td><td>â‚¹ ${x.a} Lakhs</td><td>${x.t} m</td><td>${x.r}%</td></tr>`);
        else et="<tr><td colspan='5'>No Eligible Banks</td></tr>";
        document.getElementById('pElig').innerHTML=et;

        let rt="";
        if(gRes.decl.length) gRes.decl.forEach(x=>rt+=`<tr><td>${x.b}</td><td>${x.r}</td></tr>`);
        else rt="<tr><td colspan='2'>No Rejections</td></tr>";
        document.getElementById('pRej').innerHTML=rt;

        document.getElementById('pdf').style.display='block';
    }

    async function loadH(){
        let t=document.getElementById('hist'); t.innerHTML="Loading...";
        if(db){
            let s=await db.collection('applications').where('dsaUsername','==',user.user).orderBy('date','desc').get();
            t.innerHTML=`<tr style="background:#eee;text-align:left"><th>Date</th><th>Customer</th><th>Status</th><th>Action</th></tr>`;
            s.forEach(d=>{
                let v=d.data();
                t.insertAdjacentHTML('beforeend', `<tr><td>${v.date}</td><td>${v.customer}</td><td>${v.status}</td><td><button onclick='loadS(${JSON.stringify(v)})'>View</button></td></tr>`);
            });
        }
    }
    function loadS(v){ gData=v.data; gRes=v.results; printPDF(); }
</script>
</body>
</html>
