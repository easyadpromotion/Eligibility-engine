<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DSA Credit Engine - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 5px; }
        .nav-item.active { background: #3949ab; border-left: 4px solid #ffeb3b; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }

        .accordion { background: white; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .acc-head { padding: 15px; cursor: pointer; font-weight: bold; color: #1a237e; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .acc-body { padding: 20px; display: none; }
        .acc-body.open { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .bank-opts { display: flex; gap: 5px; }
        .bank-btn { padding: 5px 10px; border: 1px solid #ccc; border-radius: 15px; cursor: pointer; font-size: 11px; }
        .bank-btn.sel { background: #1a237e; color: white; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; margin-top: 10px; }
        .btn-go { background: #2e7d32; }
        .btn-pdf { background: #0288d1; display: none; }
        .btn-add { background: none; color: #1a237e; border: 1px dashed #1a237e; margin-top: 10px; }

        #pdfModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; }
        .paper { background: white; width: 800px; margin: 30px auto; padding: 40px; min-height: 800px; }
        
        .tbl { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .tbl th, .tbl td { border: 1px solid #333; padding: 8px; text-align: left; }
        .tbl th { background: #eee; }

        @media print { body > * { display: none; } #pdfModal { display: block; } .no-print { display: none; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>DSA Portal</h3>
    <div class="nav-item active" onclick="show('app')">ðŸ“„ New Application</div>
    <div class="nav-item" onclick="show('dash')">ðŸ“Š Dashboard</div>
    <div style="margin-top:auto; padding:10px; background:#d32f2f; text-align:center; border-radius:5px; cursor:pointer;">Logout</div>
</div>

<div class="main">
    <div id="app">
        <h2>New Loan Application</h2>
        
        <div class="accordion">
            <div class="acc-head" onclick="toggle('s1')">1. Business Details <span>â–¼</span></div>
            <div id="s1" class="acc-body open">
                <div class="grid" id="grid1">
                    <div><label>Business Name</label><input type="text" id="bizName" class="pdf-in" data-l="Name"></div>
                    <div><label>Vintage (Yrs)</label><input type="number" id="vintage" class="pdf-in" data-l="Vintage"></div>
                    <div><label>Turnover (â‚¹ Lakhs)</label><input type="number" id="turnover" class="pdf-in" data-l="Turnover"></div>
                    <div><label>Entity</label><select id="entity" class="pdf-in" data-l="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option></select></div>
                    <div><label>Sector</label><select id="sector" class="pdf-in" data-l="Sector">
                        <option value="Trading">Trading (7% Margin)</option>
                        <option value="Manufacturing">Manufacturing (9% Margin)</option>
                        <option value="Service">Service (11% Margin)</option>
                    </select></div>
                    <div><label>Premises</label><select id="premises" class="pdf-in" data-l="Premises"><option>Owned</option><option>Rented</option></select></div>
                </div>
                <button class="btn btn-add" onclick="addField('grid1')">+ Add Field</button>
            </div>
        </div>

        <div class="accordion">
            <div class="acc-head" onclick="toggle('s2')">2. Banking & Docs <span>â–¼</span></div>
            <div id="s2" class="acc-body">
                <div class="grid" id="grid2">
                    <div><label>ABB (Avg Balance) â‚¹</label><input type="number" id="abb" class="pdf-in" data-l="ABB"></div>
                    <div>
                        <label>Statements</label>
                        <div class="bank-opts">
                            <span class="bank-btn" onclick="this.classList.toggle('sel')">SA</span>
                            <span class="bank-btn" onclick="this.classList.toggle('sel')">CA</span>
                            <span class="bank-btn" onclick="this.classList.toggle('sel')">OD</span>
                        </div>
                    </div>
                    <div><label>GST Registered?</label><select id="gst" onchange="checkGst()" class="pdf-in" data-l="GST"><option>No</option><option>Yes</option></select></div>
                    <div id="gstBox" style="display:none;"><label>GST Number</label><input type="text" class="pdf-in" data-l="GST No"></div>
                    <div><label>ITR Filed?</label><select id="itr" onchange="checkItr()" class="pdf-in" data-l="ITR"><option>No</option><option>Yes</option></select></div>
                    <div id="itrBox" style="display:none;"><label>ITR Amount</label><input type="number" class="pdf-in" data-l="ITR Amt"></div>
                </div>
                <button class="btn btn-add" onclick="addField('grid2')">+ Add Field</button>
            </div>
        </div>

        <div class="accordion">
            <div class="acc-head" onclick="toggle('s3')">3. Credit Profile <span>â–¼</span></div>
            <div id="s3" class="acc-body">
                <div class="grid" id="grid3">
                    <div><label>CIBIL Score</label><input type="number" id="cibil" class="pdf-in" data-l="CIBIL"></div>
                    <div><label>Current EMI (â‚¹)</label><input type="number" id="emi" class="pdf-in" data-l="EMI"></div>
                    <div><label>Unsecured Loans</label><input type="number" id="unsec" class="pdf-in" data-l="Unsec Loans"></div>
                    <div><label>Enquiries (3m)</label><input type="number" id="enq" class="pdf-in" data-l="Enquiries"></div>
                </div>
                <button class="btn btn-add" onclick="addField('grid3')">+ Add Field</button>
            </div>
        </div>

        <div class="accordion">
            <div class="acc-head" onclick="toggle('s4')">4. Applicant Details <span>â–¼</span></div>
            <div id="s4" class="acc-body">
                <div class="grid" id="grid4">
                    <div><label>Age</label><input type="number" id="age" class="pdf-in" data-l="Age"></div>
                    <div><label>Co-Applicant?</label><select id="coapp" onchange="checkCo()" class="pdf-in" data-l="Co-App"><option>No</option><option>Yes</option></select></div>
                    <div id="coBox" style="display:none;"><label>Co-App Age</label><input type="number" class="pdf-in" data-l="Co-App Age"></div>
                    <div><label>Own House?</label><select id="house" onchange="checkHouse()" class="pdf-in" data-l="House"><option>No</option><option>Yes</option></select></div>
                    <div id="houseBox" style="display:none;"><label>Pincode</label><input type="number" class="pdf-in" data-l="Pincode"></div>
                </div>
                <button class="btn btn-add" onclick="addField('grid4')">+ Add Field</button>
            </div>
        </div>

        <div class="accordion">
            <div class="acc-head" onclick="toggle('s5')">5. Loan Requirement <span>â–¼</span></div>
            <div id="s5" class="acc-body">
                <div class="grid" id="grid5">
                    <div><label>Required Amount (Lakhs)</label><input type="number" id="reqAmt" class="pdf-in" data-l="Req Amt"></div>
                    <div><label>Purpose</label><select class="pdf-in" data-l="Purpose"><option>Working Capital</option><option>Expansion</option></select></div>
                </div>
                <button class="btn btn-add" onclick="addField('grid5')">+ Add Field</button>
            </div>
        </div>

        <button class="btn btn-go" onclick="runEngine()">âš¡ Check Eligibility (All Policies)</button>
        <button class="btn btn-pdf" id="dlBtn" onclick="genPDF()">ðŸ“„ Download Offer Letter</button>
        <div id="resultMsg" style="margin-top:15px; font-weight:bold;"></div>
    </div>

    <div id="dash" style="display:none;">
        <h2>Dashboard</h2>
        <div style="background:white; padding:20px; border-radius:8px;">
            <h3>Application History</h3>
            <table class="tbl" id="histTable">
                <thead><tr><th>Date</th><th>Customer</th><th>Status</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="pdfModal">
    <div class="paper">
        <div class="no-print" style="text-align:right;">
            <button onclick="document.getElementById('pdfModal').style.display='none'">Close</button>
            <button onclick="window.print()">Print PDF</button>
        </div>
        <h2 style="text-align:center; text-decoration:underline;">PROVISIONAL OFFER LETTER</h2>
        <p><strong>Customer:</strong> <span id="pdfName"></span></p>
        
        <h4>LOAN APPLICATION DETAILS</h4>
        <div id="pdfDetails" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; font-size:12px;"></div>

        <h4>ELIGIBLE BANKS (ABB & DSCR PROGRAMS)</h4>
        <table class="tbl">
            <thead><tr><th>Bank Name</th><th>Program</th><th>Amount</th><th>Tenure</th><th>ROI</th></tr></thead>
            <tbody id="pdfEligible"></tbody>
        </table>

        <h4>NOT ELIGIBLE</h4>
        <table class="tbl">
            <thead><tr><th>Bank Name</th><th>Reject Reason</th><th>Remarks</th><th>Status</th></tr></thead>
            <tbody id="pdfReject"></tbody>
        </table>
    </div>
</div>

<script>
    // --- 1. POLICIES (Syncs with Admin theoretically) ---
    const policies = [
        { name: "TATA CAPITAL STBL", type:"STBL", turn: 20, vin: 2, cibil: 700, roi: 18, ten: 36 },
        { name: "ADITYA BIRLA STBL", type:"STBL", turn: 25, vin: 2, cibil: 710, roi: 17.5, ten: 36 },
        { name: "BAJAJ FINANCE TERM", type:"TERM", turn: 40, vin: 3, cibil: 720, roi: 16.5, ten: 48 },
        { name: "TATA CAPITAL HTBL", type:"HTBL", turn: 200, vin: 4, cibil: 725, roi: 14, ten: 60 },
        { name: "ADITYA BIRLA BIG TICKET", type:"HTBL", turn: 250, vin: 4, cibil: 725, roi: 13.5, ten: 60 },
        { name: "PIRAMAL CAPITAL UBL", type:"UBL", turn: 30, vin: 3, cibil: 700, roi: 19, ten: 36 },
        { name: "PIRAMAL CAPITAL UBL+", type:"UBL", turn: 100, vin: 4, cibil: 730, roi: 15, ten: 48 },
        { name: "ADITYA BIRLA DROP OD", type:"OD", turn: 100, vin: 3, cibil: 740, roi: 12, ten: 12 },
        { name: "TATA CAPITAL DROP OD", type:"OD", turn: 100, vin: 3, cibil: 740, roi: 12.5, ten: 12 },
        { name: "BAJAJ FINANCE FLEXI OD", type:"OD", turn: 50, vin: 2, cibil: 725, roi: 14.5, ten: 24 },
        { name: "CLIX CAPITAL", type:"NBFC", turn: 15, vin: 2, cibil: 680, roi: 21, ten: 30 }
    ];

    let results = { eligible:[], declined:[] };
    let history = JSON.parse(localStorage.getItem('dsa_hist')) || [];

    // --- 2. UI HELPERS ---
    function toggle(id) { document.getElementById(id).classList.toggle('open'); }
    function show(id) { document.getElementById('app').style.display = id==='app'?'block':'none'; document.getElementById('dash').style.display = id==='dash'?'block':'none'; if(id==='dash') renderHist(); }
    
    // Dynamic Fields
    function checkGst() { document.getElementById('gstBox').style.display = document.getElementById('gst').value==='Yes' ? 'block' : 'none'; }
    function checkItr() { document.getElementById('itrBox').style.display = document.getElementById('itr').value==='Yes' ? 'block' : 'none'; }
    function checkCo() { document.getElementById('coBox').style.display = document.getElementById('coapp').value==='Yes' ? 'block' : 'none'; }
    function checkHouse() { document.getElementById('houseBox').style.display = document.getElementById('house').value==='Yes' ? 'block' : 'none'; }

    function addField(gridId) {
        let div = document.createElement('div');
        div.innerHTML = `<label>Custom Field</label><input type="text" class="pdf-in" data-l="Custom">`;
        document.getElementById(gridId).appendChild(div);
    }

    // --- 3. LOGIC (PV Calc) ---
    function calcPV(rate, nper, pmt) {
        if(rate===0) return pmt*nper;
        return pmt * (1 - Math.pow(1+rate, -nper)) / rate;
    }

    function runEngine() {
        // Gather Inputs
        let turn = (parseFloat(document.getElementById('turnover').value)||0) * 100000;
        let turnLakh = turn/100000;
        let vin = parseFloat(document.getElementById('vintage').value)||0;
        let cibil = parseFloat(document.getElementById('cibil').value)||0;
        let abb = parseFloat(document.getElementById('abb').value)||0;
        let emi = parseFloat(document.getElementById('emi').value)||0;
        let sector = document.getElementById('sector').value;
        
        // Margin Logic
        let margin = 0.07; // Default Trading
        if(sector.includes('Manufacturing')) margin = 0.09;
        if(sector.includes('Service')) margin = 0.11;
        
        let netIncome = Math.max(0, (turn/12 * margin) - emi);
        
        results = { eligible:[], declined:[] };

        policies.forEach(p => {
            let reasons = [];
            if(vin < p.vin) reasons.push(`Vintage < ${p.vin}`);
            if(cibil < p.cibil) reasons.push(`CIBIL < ${p.cibil}`);
            if(turnLakh < p.turn) reasons.push(`Turnover < ${p.turn}L`);
            
            if(reasons.length === 0) {
                // Programs (PV)
                let r = (p.roi/100)/12;
                let loanABB = calcPV(r, p.ten, abb);
                let loanInc = calcPV(r, p.ten, netIncome);
                let amt = Math.max(loanABB, loanInc);
                
                results.eligible.push({ 
                    bank: p.name, 
                    prog: p.type + " (ABB/Income)", 
                    amt: (amt/100000).toFixed(2), 
                    ten: p.ten, 
                    roi: p.roi 
                });
            } else {
                results.declined.push({
                    bank: p.name,
                    reason: p.type,
                    remark: reasons.join(', '),
                    status: "DECLINED"
                });
            }
        });

        // Save & UI
        let name = document.getElementById('bizName').value || "Customer";
        history.push({ date: new Date().toLocaleDateString(), name: name, status: results.eligible.length>0?"Eligible":"Declined" });
        localStorage.setItem('dsa_hist', JSON.stringify(history));
        
        document.getElementById('resultMsg').innerText = `Found ${results.eligible.length} Eligible Banks`;
        document.getElementById('dlBtn').style.display = 'block';
    }

    // --- 4. PDF GEN ---
    function genPDF() {
        document.getElementById('pdfName').innerText = document.getElementById('bizName').value || "Customer";
        
        // Fill Details
        let d = "";
        document.querySelectorAll('.pdf-in').forEach(el => {
            if(el.offsetParent !== null && el.value) { // Visible & Has Value
                d += `<div><strong>${el.dataset.l}:</strong> ${el.value}</div>`;
            }
        });
        document.getElementById('pdfDetails').innerHTML = d;
        
        // Fill Eligible
        let e = "";
        results.eligible.forEach(x => {
            e += `<tr><td>${x.bank}</td><td>${x.prog}</td><td>â‚¹${x.amt} Lakhs</td><td>${x.ten}m</td><td>${x.roi}%</td></tr>`;
        });
        document.getElementById('pdfEligible').innerHTML = e || "<tr><td colspan='5'>No Eligible Offers</td></tr>";
        
        // Fill Rejected
        let r = "";
        results.declined.forEach(x => {
            r += `<tr><td>${x.bank}</td><td>${x.reason}</td><td>${x.remark}</td><td style="color:red; font-weight:bold;">${x.status}</td></tr>`;
        });
        document.getElementById('pdfReject').innerHTML = r || "<tr><td colspan='4'>No Rejections</td></tr>";

        document.getElementById('pdfModal').style.display = 'block';
    }

    function renderHist() {
        let h = "";
        history.forEach(x => {
            h += `<tr><td>${x.date}</td><td>${x.name}</td><td>${x.status}</td><td><button onclick="alert('Details Loaded')">View</button></td></tr>`;
        });
        document.querySelector('#histTable tbody').innerHTML = h;
    }
</script>
</body>
</html>
