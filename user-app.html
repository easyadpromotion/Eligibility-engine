<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Portal - Ultimate Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        .accordion { background: white; margin-bottom: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .acc-head { padding: 15px; font-weight: bold; color: #1a237e; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .acc-body { padding: 20px; display: none; }
        .acc-body.open { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .hidden-field { display: none; background: #fafafa; padding: 10px; border: 1px dashed #ccc; margin-top: 5px; }
        .btn-go { width: 100%; background: #2e7d32; color: white; padding: 15px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        .result-box { background: white; padding: 20px; margin-top: 20px; border-radius: 5px; display: none; }
        .status-pass { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>DSA Portal</h3>
    <p>New Application</p>
</div>

<div class="main">
    <h2>New Loan Application</h2>

    <div class="accordion">
        <div class="acc-head" onclick="toggle('s1')">SECTION A - PRODUCT DETAILS <span>▼</span></div>
        <div id="s1" class="acc-body open">
            <div class="grid">
                <div><label>Requested Loan Amount (Lakhs)</label><input type="number" id="reqLoan"></div>
                <div><label>Requested Tenure (Months)</label><input type="number" id="reqTenure"></div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="acc-head" onclick="toggle('s2')">SECTION B - APPLICANT <span>▼</span></div>
        <div id="s2" class="acc-body">
            <div class="grid">
                <div><label>Applicant Age</label><input type="number" id="age"></div>
                <div><label>Co-Applicant?</label>
                    <select id="coApp" onchange="toggleField('coBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                </div>
            </div>
            <div id="coBox" class="hidden-field">
                <label>Co-Applicant Age</label><input type="number" id="coAge">
            </div>
            <div class="grid" style="margin-top:15px;">
                <div><label>Own House?</label>
                    <select id="house" onchange="toggleField('houseBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                </div>
            </div>
            <div id="houseBox" class="hidden-field">
                <div class="grid">
                    <div><label>Location Type</label><select id="houseGeo"><option>Local</option><option>Other</option></select></div>
                    <div><label>Pincode</label><input type="text" id="housePin"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="acc-head" onclick="toggle('s3')">SECTION C - BUSINESS & BANKING <span>▼</span></div>
        <div id="s3" class="acc-body">
            <div class="grid">
                <div><label>Business Vintage (Years)</label><input type="number" id="vintage"></div>
                <div><label>Turnover (Lakhs)</label><input type="number" id="turnover"></div>
                <div><label>ABB (Rupees)</label><input type="number" id="abb"></div>
                <div><label>Banking Type</label>
                    <select id="bankType"><option>SA</option><option>CA</option><option>OD</option><option>CC</option></select>
                </div>
            </div>
            <div class="grid" style="margin-top:15px;">
                <div><label>ITR Available?</label>
                    <select id="itr" onchange="toggleField('itrBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                </div>
                <div><label>GST Available?</label>
                    <select id="gst" onchange="toggleField('gstBox', this.value==='Yes')"><option>No</option><option>Yes</option></select>
                </div>
            </div>
            <div id="itrBox" class="hidden-field"><label>ITR Turnover Amount</label><input type="number" id="itrAmt"></div>
            <div id="gstBox" class="hidden-field"><label>GST Turnover Amount</label><input type="number" id="gstAmt"></div>
        </div>
    </div>

    <div class="accordion">
        <div class="acc-head" onclick="toggle('s4')">SECTION D - CREDIT & OBLIGATIONS <span>▼</span></div>
        <div id="s4" class="acc-body">
            <div class="grid">
                <div><label>CIBIL Score</label><input type="number" id="cibil"></div>
                <div><label>Active Loans (Count)</label><input type="number" id="activeLoans"></div>
                <div><label>Enquiries (Last 3m)</label><input type="number" id="enquiries"></div>
            </div>
        </div>
    </div>

    <button class="btn-go" onclick="checkEligibility()">⚡ CHECK ELIGIBILITY</button>

    <div id="results" class="result-box">
        <h3>Eligibility Report</h3>
        <table>
            <thead><tr><th>Bank</th><th>Status</th><th>Reason/Offer</th></tr></thead>
            <tbody id="resTable"></tbody>
        </table>
    </div>
</div>

<script>
    function toggle(id) { document.getElementById(id).classList.toggle('open'); }
    function toggleField(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }

    function checkEligibility() {
        // 1. Get User Data
        const user = {
            reqLoan: parseFloat(document.getElementById('reqLoan').value) || 0,
            age: parseFloat(document.getElementById('age').value) || 0,
            vintage: parseFloat(document.getElementById('vintage').value) || 0,
            turnover: parseFloat(document.getElementById('turnover').value) || 0,
            cibil: parseFloat(document.getElementById('cibil').value) || 0,
            abb: parseFloat(document.getElementById('abb').value) || 0
        };

        // 2. Get Policies from Admin Storage
        const policies = JSON.parse(localStorage.getItem('admin_policies_v2')) || [];
        
        let html = '';
        
        // 3. Engine Logic
        policies.forEach(p => {
            let eligible = true;
            let reasons = [];

            // A. Check Basic Rules
            if(user.reqLoan < p.loanMin) { eligible = false; reasons.push(`Loan < Min (${p.loanMin})`); }
            if(user.age < p.ageMin) { eligible = false; reasons.push(`Age < Min (${p.ageMin})`); }
            if(user.vintage < p.vintageMin) { eligible = false; reasons.push(`Vintage < Min (${p.vintageMin})`); }
            if(user.cibil < p.cibilMin) { eligible = false; reasons.push(`CIBIL < Min (${p.cibilMin})`); }
            if(user.turnover < p.turnMin) { eligible = false; reasons.push(`Turnover < Min (${p.turnMin})`); }

            // B. Calculate Amount (Simplified Logic for Demo)
            // Real logic would use the Section E multipliers (ABB/GST/ITR)
            let offer = 0;
            if(eligible) {
                // Example: 20% of turnover or 5x ABB
                let offerTurn = user.turnover * 0.2;
                let offerAbb = user.abb * 5; // simplified multiplier
                offer = Math.max(offerTurn, offerAbb);
                // Cap at Max Loan
                if(p.loanMax && offer > p.loanMax) offer = p.loanMax;
            }

            // C. Render Row
            if(eligible) {
                html += `<tr><td>${p.bankName}</td><td class="status-pass">ELIGIBLE</td><td>Approved up to ₹${offer.toFixed(2)} Lakhs (ROI: ${p.roiMin}%)</td></tr>`;
            } else {
                html += `<tr><td>${p.bankName}</td><td class="status-fail">DECLINED</td><td>${reasons.join(', ')}</td></tr>`;
            }
        });

        if(policies.length === 0) html = "<tr><td colspan='3'>No Active Policies Found. Please configure in Admin.</td></tr>";

        document.getElementById('resTable').innerHTML = html;
        document.getElementById('results').style.display = 'block';
    }
</script>
</body>
</html>
