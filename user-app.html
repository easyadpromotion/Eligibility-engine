<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Loan Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; height: 100vh; color: #333; }
        .sidebar { width: 250px; background: #004a99; color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .status-badge { background: #e3f2fd; color: #004a99; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; border: 1px solid #004a99; }
        
        /* SECTIONS */
        .section-card { background: white; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .section-header { padding: 15px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #004a99; border-bottom: 1px solid #f0f0f0; }
        .section-header:hover { background: #f9fbfd; }
        .section-body { padding: 20px; display: none; }
        .section-body.open { display: block; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555; }
        .hidden { display: none; }
        .dynamic-field { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; background: #fafafa; border-radius: 4px; }
        
        /* BUTTONS */
        .add-btn { background: #28a745; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; float: right; font-size: 12px; }
        .check-btn { background: #004a99; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .pdf-btn { background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight:bold; }
        
        /* RESULTS CARD */
        .bank-result-card { background: white; margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 6px solid #ccc; }
        .bank-result-header { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items:center; }
        .bank-result-body { padding: 15px; border-top: 1px solid #eee; }
        .status-eligible { border-left-color: #28a745; } .status-eligible .bank-result-header { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { border-left-color: #dc3545; } .status-rejected .bank-result-header { background: #ffebee; color: #c62828; }
        .offer-row { background: #f8f9fa; padding: 10px; margin-bottom: 5px; border-radius: 4px; font-size: 14px; }

        /* PDF TEMPLATE */
        #letterTemplate { display: none; padding: 40px; font-family: 'Times New Roman', serif; background: white; width: 700px; color: #000; }
        .letter-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 30px; }
        .letter-box { border: 1px solid #333; padding: 15px; margin: 20px 0; background: #f9f9f9; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Credit Engine</h2>
        <div style="padding:10px; color:white; font-weight:bold; cursor:pointer">üìù New Application</div>
        <div style="padding:10px; color:#ffcccb; cursor:pointer; margin-top:auto" onclick="logout()">üö™ Logout</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Eligibility Check</h1>
            <div id="statusBadge" class="status-badge">Loading...</div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggleSection('sec1')"><span>1. Business Details</span> <span>‚ñº</span></div>
            <div id="sec1" class="section-body open">
                <button class="add-btn" onclick="addField('sec1-fields')">+ Add</button>
                <div class="grid-row"><div><label>Customer Name</label><input type="text" id="custName"></div><div><label>Vintage (Years)</label><input type="number" id="vintage"></div></div>
                <div class="grid-row"><div><label>Annual Turnover (Lakhs)</label><input type="number" id="turnover"></div><div><label>Entity Type</label><select><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option><option>LLP</option></select></div></div>
                <div class="grid-row"><div><label>Nature</label><select><option>Trading</option><option>Manufacturing</option><option>Service</option></select></div><div><label>Place</label><select><option>Rented</option><option>Owned</option></select></div></div>
                <div id="sec1-fields"></div>
            </div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggleSection('sec2')"><span>2. Banking & Documents</span> <span>‚ñº</span></div>
            <div id="sec2" class="section-body">
                <button class="add-btn" onclick="addField('sec2-fields')">+ Add</button>
                <div class="grid-row"><div><label>Banking Type</label><select id="bankType"><option>SA</option><option>CA</option><option>OD/CC</option><option>SA+CA</option><option>SA+OD/CC</option><option>CA+OD/CC</option><option>All (SA+CA+OD/CC)</option></select></div><div><label>ABB (Rupees)</label><input type="number" id="abb" placeholder="e.g. 50000"></div></div>
                <div class="grid-row"><div><label>GST Registered?</label><select id="gstStatus" onchange="toggleVis('gstStatus','gstField')"><option value="No">No</option><option value="Yes">Yes</option></select></div><div id="gstField" class="hidden"><label>GST Turnover (Lakhs)</label><input type="number" id="gstTurnover"></div></div>
                <div class="grid-row"><div><label>ITR Filed?</label><select id="itrStatus" onchange="toggleVis('itrStatus','itrField')"><option value="No">No</option><option value="Yes">Yes</option></select></div><div id="itrField" class="hidden"><label>ITR Turnover (Lakhs)</label><input type="number" id="itrTurnover"></div></div>
                <div id="sec2-fields"></div>
            </div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggleSection('sec3')"><span>3. Loans & Obligations</span> <span>‚ñº</span></div>
            <div id="sec3" class="section-body">
                <button class="add-btn" onclick="addField('sec3-fields')">+ Add</button>
                <div class="grid-row"><div><label>CIBIL Score</label><input type="number" id="cibil"></div><div><label>Active Loans</label><input type="number" id="activeLoans"></div></div>
                <div class="grid-row"><div><label>Current EMI (‚Çπ)</label><input type="number" id="existingEmi"></div><div><label>Closing EMI (‚Çπ)</label><input type="number" id="closingEmi"></div></div>
                <div id="sec3-fields"></div>
            </div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggleSection('sec4')"><span>4. Applicant Details</span> <span>‚ñº</span></div>
            <div id="sec4" class="section-body">
                <button class="add-btn" onclick="addField('sec4-fields')">+ Add</button>
                <div class="grid-row"><div><label>Age</label><input type="number" id="age"></div></div>
                <div class="grid-row"><div><label>Co-Applicant?</label><select id="coAppStatus" onchange="toggleVis('coAppStatus','coAppField')"><option value="No">No</option><option value="Yes">Yes</option></select></div><div id="coAppField" class="hidden"><label>Co-Applicant Age</label><input type="number"></div></div>
                <div class="grid-row"><div><label>Own House?</label><select id="houseStatus" onchange="toggleVis('houseStatus','houseField')"><option value="No">No</option><option value="Yes">Yes</option></select></div><div id="houseField" class="hidden"><label>Pincode</label><input type="number"></div></div>
                <div id="sec4-fields"></div>
            </div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggleSection('sec5')"><span>5. Additional Fields</span> <span>‚ñº</span></div>
            <div id="sec5" class="section-body">
                <button class="add-btn" onclick="addField('sec5-fields')" style="float:none">+ Add Custom Field</button>
                <div id="sec5-fields"></div>
            </div>
        </div>

        <button class="check-btn" onclick="checkAllPolicies()">‚ö° Check All Banks</button>
        <div id="finalResultsArea"></div>
    </div>

    <div id="letterTemplate">
        <div class="letter-header">
            <h2>IN-PRINCIPLE SANCTION LETTER</h2>
            <p id="pdfBankName">Bank Name</p>
        </div>
        <p><b>Date:</b> <span id="pdfDate"></span></p>
        <p><b>To,</b> <br> <span id="pdfCustName">Customer</span></p>
        <p>Dear Customer,</p>
        <p>We are pleased to inform you that your loan application is <b>provisionally approved</b>.</p>
        <div class="letter-box">
            <p><b>‚úÖ Approved Amount:</b> ‚Çπ<span id="pdfAmount"></span> Lakhs</p>
            <p><b>üìÇ Program:</b> <span id="pdfProgram"></span></p>
        </div>
        <p>Sincerely,<br>Credit Manager</p>
    </div>

<script>
    if(!sessionStorage.getItem('currentUser')) window.location.href="login.html";
    function logout(){ sessionStorage.clear(); window.location.href="login.html"; }
    function toggleSection(id){ const el=document.getElementById(id); el.style.display=(el.style.display==='block')?'none':'block'; }
    function toggleVis(trig,targ){ document.getElementById(targ).style.display=(document.getElementById(trig).value==='Yes')?'block':'none'; }
    function addField(id){ document.getElementById(id).insertAdjacentHTML('beforeend', `<div class="grid-row dynamic-field" style="margin-bottom:0"><input placeholder="Field Name"><input placeholder="Value"></div>`); }

    // LOAD ACTIVE POLICIES
    const lib = JSON.parse(localStorage.getItem('bankPolicyLibrary')) || [];
    const activePolicies = lib.filter(p => p.isActive);
    document.getElementById('statusBadge').innerText = `${activePolicies.length} Active Policies Connected`;

    function checkAllPolicies() {
        if(activePolicies.length === 0) { alert("No active policies found in Admin!"); return; }

        const data = {
            name: document.getElementById('custName').value || "Customer",
            vintage: parseFloat(document.getElementById('vintage').value) || 0,
            turnover: parseFloat(document.getElementById('turnover').value) || 0,
            gst: parseFloat(document.getElementById('gstTurnover').value) || 0,
            abb: parseFloat(document.getElementById('abb').value) || 0,
            cibil: parseFloat(document.getElementById('cibil').value) || 0,
            age: parseFloat(document.getElementById('age').value) || 0,
            emi: parseFloat(document.getElementById('existingEmi').value) || 0,
            closing: parseFloat(document.getElementById('closingEmi').value) || 0,
            activeLoans: parseFloat(document.getElementById('activeLoans').value) || 0
        };
        const netObs = Math.max(0, data.emi - data.closing);
        const resultsArea = document.getElementById('finalResultsArea');
        resultsArea.innerHTML = "";

        // CHECK EACH POLICY
        activePolicies.forEach(policy => {
            let reasons = [];
            let offers = [];
            
            // 1. HARD CHECKS
            if(data.cibil < policy.cibilMin) reasons.push(`CIBIL ${data.cibil} < ${policy.cibilMin}`);
            if(data.vintage < policy.vintage) reasons.push(`Vintage ${data.vintage} < ${policy.vintage}`);
            if(data.turnover < policy.turnoverMin) reasons.push(`Turnover ${data.turnover} < ${policy.turnoverMin}`);
            if(data.activeLoans > (policy.activeMax || 99)) reasons.push(`Too many active loans`);
            if(data.age < policy.ageMin || data.age > policy.ageMax) reasons.push(`Age not in range`);

            // ABB Check (Convert Lakhs to Rupees)
            let minABB_Rupees = (policy.abbMin || 0) * 100000;
            if(data.abb < minABB_Rupees) reasons.push(`ABB ‚Çπ${data.abb} < ‚Çπ${minABB_Rupees}`);

            // 2. OFFERS
            if(reasons.length === 0) {
                let adminFOIR = 0.60; 
                if(policy.programs) {
                    policy.programs.forEach(prog => {
                        let base = 0;
                        if(prog.type.includes('Turnover')) base = data.turnover;
                        if(prog.type.includes('GST')) base = data.gst;
                        if(prog.type.includes('Banking')) base = (data.abb * 12)/100000; // Annualize & to Lakhs

                        if(base > 0) {
                            let monthlyProfit = (base * 100000 * 0.10) / 12; // 10% Profit
                            let maxEMI = monthlyProfit * adminFOIR;
                            let available = maxEMI - netObs;
                            let cap = available / 2500;
                            let final = Math.min(cap, prog.maxLoan);
                            if(final >= prog.minLoan) {
                                offers.push({ type: prog.type, amt: final.toFixed(2), range: `${prog.minLoan}-${prog.maxLoan}` });
                            }
                        }
                    });
                }
                if(offers.length === 0) reasons.push("High Debt (FOIR Reject)");
            }

            // 3. RENDER RESULT
            let card = document.createElement('div');
            card.className = `bank-result-card ${offers.length > 0 ? 'status-eligible' : 'status-rejected'}`;
            
            let headerText = offers.length > 0 ? `‚úÖ ${policy.bankName}: Eligible` : `‚ùå ${policy.bankName}: Rejected`;
            let pdfBtn = offers.length > 0 ? `<button class="pdf-btn" onclick="printPDF('${policy.bankName}','${offers[0].amt}','${offers[0].type}')">Download PDF</button>` : '';

            let bodyHtml = "";
            if(offers.length > 0) {
                offers.sort((a,b)=>b.amt-a.amt);
                offers.forEach(o => bodyHtml += `<div class="offer-row"><b>${o.type}</b>: Max ‚Çπ${o.amt} Lakhs (Policy: ${o.range})</div>`);
            } else {
                bodyHtml = `<div style="color:red; font-size:13px">${reasons.join('<br>')}</div>`;
            }

            card.innerHTML = `<div class="bank-result-header"><span>${headerText}</span> ${pdfBtn}</div><div class="bank-result-body">${bodyHtml}</div>`;
            resultsArea.appendChild(card);
        });
    }

    function printPDF(bank, amt, prog) {
        document.getElementById('pdfBankName').innerText = bank;
        document.getElementById('pdfCustName').innerText = document.getElementById('custName').value;
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
        document.getElementById('pdfAmount').innerText = amt;
        document.getElementById('pdfProgram').innerText = prog;
        let el = document.getElementById('letterTemplate');
        el.style.display = 'block';
        html2pdf().from(el).save(`${bank}_Sanction.pdf`).then(()=>{ el.style.display='none'; });
    }
</script>
</body>
</html>