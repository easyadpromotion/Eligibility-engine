<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Engine Pro - User</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .accordion { background: white; margin-bottom: 10px; border-radius: 8px; }
        .accordion-header { padding: 15px; cursor: pointer; background: #fff; font-weight: bold; }
        .accordion-body { padding: 20px; display: none; } .accordion-body.open { display: block; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; box-sizing: border-box; }
        .bank-opt { padding:5px 10px; border:1px solid #ccc; cursor:pointer; display:inline-block; margin-right:5px; border-radius:15px; }
        .bank-opt.selected { background:#1a237e; color:white; }
        .btn { padding: 10px; background: #2e7d32; color: white; border: none; cursor: pointer; width: 100%; margin-top: 20px; font-size: 16px; }
        .hidden-field { display:none; background:#fafafa; padding:10px; border:1px dashed #ccc; }
        .mobile-btn { display: none; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .sidebar { display:none; } }
        /* Report Modal */
        #fullReportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .report-paper { background: white; width: 900px; margin: 0 auto; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .report-table th, .report-table td { border: 1px solid #333; padding: 8px; text-align: center; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ðŸš€ DSA Portal</h2>
        <div onclick="switchView('appView')">ðŸ“„ New App</div>
        <div onclick="switchView('dashView')">ðŸ“Š Dashboard</div>
        <div onclick="logoutUser()" style="margin-top:auto;color:#ff8a80;cursor:pointer;">Logout</div>
    </div>

    <div class="main-content">
        <h2 id="welcomeMsg">Welcome</h2>

        <div id="appView">
            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">1. Business</div>
            <div class="accordion-body open"><div class="form-grid">
                <div><label>Name</label><input type="text" id="bizName" class="pdf-data" data-label="Business Name"></div>
                <div><label>Contact</label><input type="number" class="pdf-data" data-label="Contact"></div>
                <div><label>Vintage</label><input type="number" class="pdf-data" data-label="Vintage"></div>
                <div><label>Turnover</label><input type="number" id="turnover" class="pdf-data" data-label="Turnover"></div>
                <div><label>Entity</label><select class="pdf-data" data-label="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option></select></div>
                <div><label>Sector</label><select class="pdf-data" data-label="Sector"><option>Trading</option><option>Manufacturing</option><option>Service</option></select></div>
                <div><label>Premises</label><select class="pdf-data" data-label="Premises"><option>Owned</option><option>Rented</option></select></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">2. Banking</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>ABB</label><input type="number" id="abb" class="pdf-data" data-label="ABB"></div>
                <div><label>Bank Stmt</label><div id="bankOpts"><span class="bank-opt" onclick="this.classList.toggle('selected')">SA</span><span class="bank-opt" onclick="this.classList.toggle('selected')">CA</span></div></div>
                <div><label>GST?</label><select class="pdf-data" data-label="GST Reg" onchange="document.getElementById('gstBox').style.display=this.value==='Yes'?'block':'none'"><option>No</option><option>Yes</option></select></div>
                <div id="gstBox" class="hidden-field"><label>GST Turn</label><input type="number" class="pdf-data" data-label="GST Turnover"></div>
                <div><label>ITR?</label><select class="pdf-data" data-label="ITR Filed" onchange="document.getElementById('itrBox').style.display=this.value==='Yes'?'block':'none'"><option>No</option><option>Yes</option></select></div>
                <div id="itrBox" class="hidden-field"><label>ITR Inc</label><input type="number" class="pdf-data" data-label="ITR Income"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">3. Credit (All Fields)</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>CIBIL</label><input type="number" id="cibil" class="pdf-data" data-label="CIBIL"></div>
                <div><label>Active Loans</label><input type="number" class="pdf-data" data-label="Active Loans"></div>
                <div><label>Monthly EMI</label><input type="number" class="pdf-data" data-label="Monthly EMI" id="monthlyEmi"></div>
                <div><label>Unsec Loans</label><input type="number" id="unsecLoans" class="pdf-data" data-label="Unsec Loans"></div>
                <div><label>Loans (6m)</label><input type="number" class="pdf-data" data-label="Loans (6m)"></div>
                <div><label>Closed (6m)</label><input type="number" class="pdf-data" data-label="Closing (6m)"></div>
                <div><label>Reduced EMI</label><input type="number" class="pdf-data" data-label="Reduced EMI" id="reducedEmi"></div>
                <div><label>Enquiries (3m)</label><input type="number" class="pdf-data" data-label="Enquiries"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">4. Applicant</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>Age</label><input type="number" class="pdf-data" data-label="Age"></div>
                <div><label>Gender</label><select class="pdf-data" data-label="Gender"><option>Male</option><option>Female</option></select></div>
                <div><label>Co-App?</label><select class="pdf-data" data-label="Co-App" onchange="document.getElementById('coBox').style.display=this.value==='Yes'?'block':'none'"><option>No</option><option>Yes</option></select></div>
                <div id="coBox" class="hidden-field"><label>Co-App Age</label><input type="number" class="pdf-data" data-label="Co-App Age"></div>
                <div><label>House?</label><select class="pdf-data" data-label="Own House" onchange="document.getElementById('houseBox').style.display=this.value==='Yes'?'block':'none'"><option>No</option><option>Yes</option></select></div>
                <div id="houseBox" class="hidden-field"><label>Pincode</label><input type="number" class="pdf-data" data-label="Pincode"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">5. Requirement</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>Req Amount</label><input type="number" class="pdf-data" data-label="Req Amount"></div>
                <div><label>Purpose</label><input type="text" class="pdf-data" data-label="Purpose"></div>
            </div></div></div>

            <button class="btn" id="btnRun" onclick="runEngine()">âš¡ Check & Submit</button>
            <div id="resultArea"></div>
            <button class="report-btn" id="dlReportBtn" onclick="generateFullPDF()" style="display:none;background:#0288d1;color:white;width:100%;margin-top:10px;padding:10px;">ðŸ“„ Download Offer</button>
        </div>

        <div id="dashView" style="display:none;">
            <h3>My History (Cloud)</h3>
            <table style="width:100%; background:white;" id="historyTable"><thead><tr><th>Date</th><th>Customer</th><th>Status</th><th>View</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="fullReportModal"><div class="report-paper"><button onclick="document.getElementById('fullReportModal').style.display='none'">Close</button><button onclick="window.print()">Print</button><div class="report-header"><h3>PROVISIONAL OFFER LETTER</h3></div><div id="pdfAppDetails" class="details-grid"></div><br><table class="report-table"><thead><tr><th>Bank</th><th>Prog</th><th>Amt</th><th>Tenure</th><th>ROI</th></tr></thead><tbody id="pdfEligibleTable"></tbody></table><br><table class="report-table"><thead><tr><th>Bank</th><th>Reason</th></tr></thead><tbody id="pdfRejectTable"></tbody></table></div></div>

    <script>
        // ---------------------------------------------------------
        // ðŸš¨ PASTE FIREBASE KEYS BELOW ðŸš¨
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
            authDomain: "credir-engine-new.firebaseapp.com",
            projectId: "credir-engine-new",
            storageBucket: "credir-engine-new.firebasestorage.app",
            messagingSenderId: "249073295308",
            appId: "1:249073295308:web:e3db899190a4d2506d0769",
            measurementId: "G-YBXMM1J129"
        };
        // ---------------------------------------------------------

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) { console.error(e); }

        const user = JSON.parse(sessionStorage.getItem('active_dsa_user'));
        if(!user) window.location.href = "index.html";
        document.getElementById('welcomeMsg').innerText = `Welcome, ${user.name}`;

        window.logoutUser = () => { sessionStorage.removeItem('active_dsa_user'); window.location.href="index.html"; };
        window.switchView = (v) => {
            document.getElementById('appView').style.display = v==='appView'?'block':'none';
            document.getElementById('dashView').style.display = v==='dashView'?'block':'none';
            if(v==='dashView') loadHistory();
        };

        // ENGINE
        window.runEngine = async () => {
            let data = {};
            document.querySelectorAll('.pdf-data').forEach(e => data[e.getAttribute('data-label')] = e.value);
            
            let stmts = []; document.querySelectorAll('.bank-opt.selected').forEach(e=>stmts.push(e.innerText));
            data['Bank Statements'] = stmts.join(', ');
            data['DSA Name'] = user.name; data['DSA Username'] = user.user;

            // Load Policies from Cloud
            let policies = [];
            if(db) {
                const snap = await db.collection("policies").get();
                policies = snap.docs.map(d => d.data());
            }
            if(policies.length===0) policies = [{bankName:"Demo Bank", minTurn:20, roiMin:18, roiMax:24, loanMax:50}];

            // Logic
            let eligible=[], declined=[];
            const turn = +data['Turnover']||0; const cibil = +data['CIBIL']||0;
            const netInc = (turn*100000)/12 * 0.07; // Dummy 7% margin

            policies.forEach(p => {
                let pass=true, reason="";
                if(turn < p.minTurn) { pass=false; reason=`Turn < ${p.minTurn}`; }
                else if(cibil < p.minCibil) { pass=false; reason=`Cibil < ${p.minCibil}`; }
                
                if(pass) {
                    eligible.push({bank:p.bankName, prog:p.prodType, amt:((netInc*36)/100000).toFixed(2), ten:"36", roi:p.roiMin+"-"+p.roiMax});
                } else declined.push({bank:p.bankName, reason:reason});
            });

            const results = {eligible, declined};
            const status = eligible.length > 0 ? "Eligible" : "Declined";
            document.getElementById('resultsArea').innerHTML = `<h3>Found ${eligible.length} Eligible</h3>`;
            
            if(db) {
                db.collection("applications").add({
                    date: new Date().toLocaleDateString(),
                    customer: data['Business Name'],
                    dsaName: user.name,
                    dsaUsername: user.user,
                    status: status,
                    data: data,
                    results: results
                });
                alert("Saved to Cloud!");
            }
            
            document.getElementById('dlReportBtn').style.display='block';
            window.latestResults = results; window.latestData = data;
        };

        window.generateFullPDF = () => {
            const res = window.latestResults, data = window.latestData;
            document.getElementById('pdfAppDetails').innerHTML = Object.entries(data).map(([k,v])=>`<div class="detail-item"><strong>${k}:</strong> ${v}</div>`).join('');
            document.getElementById('pdfEligibleTable').innerHTML = res.eligible.map(i=>`<tr><td>${i.bank}</td><td>${i.prog}</td><td>${i.amt} L</td><td>${i.ten}</td><td>${i.roi}</td></tr>`).join('');
            document.getElementById('pdfRejectTable').innerHTML = res.declined.map(i=>`<tr><td>${i.bank}</td><td>${i.reason}</td></tr>`).join('');
            document.getElementById('fullReportModal').style.display='block';
        };

        window.loadHistory = async () => {
            const t = document.querySelector('#historyTable tbody'); t.innerHTML="Loading...";
            if(db) {
                const snap = await db.collection("applications").where("dsaUsername", "==", user.user).get();
                t.innerHTML = "";
                snap.forEach(doc => {
                    const v = doc.data();
                    t.innerHTML += `<tr><td>${v.date}</td><td>${v.customer}</td><td>${v.status}</td><td><button onclick='window.latestResults=${JSON.stringify(v.results)};window.latestData=${JSON.stringify(v.data)};generateFullPDF()'>View</button></td></tr>`;
                });
            }
        };
        
        window.toggleField = (id,s) => document.getElementById(id).style.display=s?'block':'none';
    </script>
</body>
</html>
