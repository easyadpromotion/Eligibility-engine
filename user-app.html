<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; height: 100vh; color: #333; }
        .sidebar { width: 250px; background: #004a99; color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .status-badge { background: #e3f2fd; color: #004a99; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; border: 1px solid #004a99; }
        .section-card { background: white; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .section-header { padding: 15px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #004a99; border-bottom: 1px solid #f0f0f0; }
        .section-body { padding: 20px; display: none; } .section-body.open { display: block; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555; }
        .hidden { display: none; }
        .check-btn { background: #004a99; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .bank-result-card { background: white; margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 6px solid #ccc; }
        .bank-result-header { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items:center; }
        .bank-result-body { padding: 15px; border-top: 1px solid #eee; }
        .status-eligible { border-left-color: #28a745; } .status-eligible .bank-result-header { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { border-left-color: #dc3545; } .status-rejected .bank-result-header { background: #ffebee; color: #c62828; }
        .pdf-btn { background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight:bold; }
        #letterTemplate { display: none; padding: 40px; font-family: 'Times New Roman', serif; background: white; width: 700px; color: #000; }
        .letter-box { border: 1px solid #333; padding: 15px; margin: 20px 0; background: #f9f9f9; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Credit Engine</h2>
        <div style="padding:10px; color:white; font-weight:bold; cursor:pointer">üìù New Application</div>
        <div style="padding:10px; color:#ffcccb; cursor:pointer; margin-top:auto" id="btnLogout">üö™ Logout</div>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px">
            <h1>Eligibility Check</h1>
            <div id="statusBadge" class="status-badge">Connecting to Cloud...</div>
        </div>

        <div class="section-card"><div class="section-header" onclick="toggle('sec1')">1. Business Details ‚ñº</div><div id="sec1" class="section-body open">
            <div class="grid-row"><div><label>Customer Name</label><input type="text" id="custName"></div><div><label>Vintage (Years)</label><input type="number" id="vintage"></div></div>
            <div class="grid-row"><div><label>Turnover (Lakhs)</label><input type="number" id="turnover"></div><div><label>Entity</label><select><option>Proprietorship</option><option>Pvt Ltd</option></select></div></div>
        </div></div>

        <div class="section-card"><div class="section-header" onclick="toggle('sec2')">2. Banking ‚ñº</div><div id="sec2" class="section-body">
            <div class="grid-row"><div><label>ABB (Rupees)</label><input type="number" id="abb"></div><div><label>Banking Type</label><select><option>All</option><option>SA</option><option>CA</option></select></div></div>
            <div class="grid-row"><div><label>GST Registered?</label><select id="gstStatus"><option value="No">No</option><option value="Yes">Yes</option></select></div><div><label>GST Turnover</label><input type="number" id="gstTurnover"></div></div>
        </div></div>

        <div class="section-card"><div class="section-header" onclick="toggle('sec3')">3. Credit ‚ñº</div><div id="sec3" class="section-body">
            <div class="grid-row"><div><label>CIBIL</label><input type="number" id="cibil"></div><div><label>Active Loans</label><input type="number" id="activeLoans"></div></div>
            <div class="grid-row"><div><label>EMI Current</label><input type="number" id="existingEmi"></div><div><label>EMI Closing</label><input type="number" id="closingEmi"></div></div>
        </div></div>

        <div class="section-card"><div class="section-header" onclick="toggle('sec4')">4. Applicant ‚ñº</div><div id="sec4" class="section-body">
            <div class="grid-row"><div><label>Age</label><input type="number" id="age"></div></div>
        </div></div>

        <button class="check-btn" id="btnCheck">‚ö° Check All Banks</button>
        <div id="resultsArea"></div>
    </div>

    <div id="letterTemplate">
        <center><h2>IN-PRINCIPLE SANCTION</h2></center><hr>
        <p><b>Bank:</b> <span id="pdfBank"></span></p>
        <p><b>Customer:</b> <span id="pdfCust"></span></p>
        <div class="letter-box"><h3>Approved: ‚Çπ<span id="pdfAmt"></span> Lakhs</h3><p>Program: <span id="pdfProg"></span></p></div>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // YOUR SPECIFIC KEYS
  const firebaseConfig = {
    apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
    authDomain: "credir-engine-new.firebaseapp.com",
    projectId: "credir-engine-new",
    storageBucket: "credir-engine-new.firebasestorage.app",
    messagingSenderId: "249073295308",
    appId: "1:249073295308:web:e3db899190a4d2506d0769",
    measurementId: "G-YBXMM1J129"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  if(!sessionStorage.getItem('currentUser')) window.location.href="index.html";
  document.getElementById('btnLogout').onclick = () => { sessionStorage.clear(); window.location.href="index.html"; };
  
  window.toggle = (id) => { const el=document.getElementById(id); el.style.display=(el.style.display==='block')?'none':'block'; };

  // FETCH ACTIVE POLICIES
  let activePolicies = [];
  (async function() {
      try {
        const q = query(collection(db, "policies"), where("isActive", "==", true));
        const snap = await getDocs(q);
        snap.forEach(d => activePolicies.push(d.data()));
        document.getElementById('statusBadge').innerText = `${activePolicies.length} Banks Connected (Cloud)`;
      } catch(e) { console.error(e); }
  })();

  document.getElementById('btnCheck').onclick = () => {
    if(activePolicies.length === 0) { alert("No active policies in cloud!"); return; }
    
    const d = {
        name: document.getElementById('custName').value,
        vintage: parseFloat(document.getElementById('vintage').value)||0,
        turnover: parseFloat(document.getElementById('turnover').value)||0,
        gst: parseFloat(document.getElementById('gstTurnover').value)||0,
        abb: parseFloat(document.getElementById('abb').value)||0,
        cibil: parseFloat(document.getElementById('cibil').value)||0,
        age: parseFloat(document.getElementById('age').value)||0,
        emi: parseFloat(document.getElementById('existingEmi').value)||0,
        closing: parseFloat(document.getElementById('closingEmi').value)||0,
        activeLoans: parseFloat(document.getElementById('activeLoans').value)||0
    };
    const netObs = Math.max(0, d.emi - d.closing);
    const resArea = document.getElementById('resultsArea'); resArea.innerHTML = "";

    activePolicies.forEach(p => {
        let reasons = [], offers = [];
        if(d.cibil < p.cibilMin) reasons.push(`CIBIL Low`);
        if(d.vintage < p.vintage) reasons.push(`Vintage Low`);
        if(d.turnover < p.turnoverMin) reasons.push(`Turnover Low`);
        
        // Logic
        if(reasons.length === 0) {
            let adminFOIR = 0.60; 
            if(p.programs) {
                p.programs.forEach(prog => {
                    let base = 0;
                    if(prog.type.includes('Turnover')) base = d.turnover;
                    if(prog.type.includes('GST')) base = d.gst;
                    if(prog.type.includes('Banking')) base = (d.abb * 12)/100000;

                    if(base > 0) {
                        let profit = (base * 100000 * 0.10) / 12;
                        let maxEMI = profit * adminFOIR;
                        let loan = (maxEMI - netObs) / 2500;
                        let final = Math.min(loan, prog.maxLoan);
                        if(final >= prog.minLoan) offers.push({type: prog.type, amt: final.toFixed(2)});
                    }
                });
            }
            if(offers.length===0) reasons.push("High Debt / No Offer");
        }

        let html = `<div class="bank-result-card ${offers.length>0?'status-eligible':'status-rejected'}">
        <div class="bank-result-header"><span>${offers.length>0?'‚úÖ':'‚ùå'} ${p.bankName}</span> 
        ${offers.length>0 ? `<button class="pdf-btn" onclick="window.printPDF('${p.bankName}','${offers[0].amt}','${offers[0].type}')">PDF</button>`:''}</div>
        <div class="bank-result-body">${offers.length>0 ? offers[0].type+': ‚Çπ'+offers[0].amt+'L' : reasons.join(', ')}</div></div>`;
        resArea.insertAdjacentHTML('beforeend', html);
    });
  };

  window.printPDF = (bank, amt, prog) => {
    document.getElementById('pdfBank').innerText = bank;
    document.getElementById('pdfCust').innerText = document.getElementById('custName').value;
    document.getElementById('pdfAmt').innerText = amt;
    document.getElementById('pdfProg').innerText = prog;
    let el = document.getElementById('letterTemplate'); el.style.display='block';
    html2pdf().from(el).save('Sanction.pdf').then(()=>el.style.display='none');
  };
</script>
</body>
</html>
