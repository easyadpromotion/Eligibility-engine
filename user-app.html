<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Engine Pro - User</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* (Same CSS as previous versions) */
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .accordion { background: white; margin-bottom: 10px; border-radius: 8px; }
        .accordion-header { padding: 15px; cursor: pointer; background: #fff; font-weight: bold; }
        .accordion-body { padding: 20px; display: none; } .accordion-body.open { display: block; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; box-sizing: border-box; }
        .bank-opt { padding:5px 10px; border:1px solid #ccc; cursor:pointer; display:inline-block; margin-right:5px; border-radius:15px; }
        .bank-opt.selected { background:#1a237e; color:white; }
        .btn { padding: 10px; background: #2e7d32; color: white; border: none; cursor: pointer; width: 100%; margin-top: 20px; font-size: 16px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ðŸš€ DSA Portal</h2>
        <div onclick="document.getElementById('appView').style.display='block';document.getElementById('dashView').style.display='none'">ðŸ“„ New App</div>
        <div onclick="loadHistory()">ðŸ“Š Dashboard</div>
        <div onclick="logoutUser()" style="margin-top:auto;color:#ff8a80;cursor:pointer;">Logout</div>
    </div>

    <div class="main-content">
        <h2 id="welcomeMsg">Welcome</h2>

        <div id="appView">
            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">1. Business</div>
            <div class="accordion-body open"><div class="form-grid">
                <div><label>Name</label><input type="text" id="bizName" class="pdf-data" data-label="Business Name"></div>
                <div><label>Contact</label><input type="number" class="pdf-data" data-label="Contact"></div>
                <div><label>Vintage</label><input type="number" class="pdf-data" data-label="Vintage"></div>
                <div><label>Turnover</label><input type="number" id="turnover" class="pdf-data" data-label="Turnover"></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">2. Banking</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>ABB</label><input type="number" id="abb" class="pdf-data" data-label="ABB"></div>
                <div><label>Bank Stmt</label><div id="bankOpts"><span class="bank-opt" onclick="this.classList.toggle('selected')">SA</span><span class="bank-opt" onclick="this.classList.toggle('selected')">CA</span></div></div>
                <div><label>GST?</label><select class="pdf-data" data-label="GST Reg"><option>No</option><option>Yes</option></select></div>
            </div></div></div>

            <div class="accordion"><div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">3. Credit</div>
            <div class="accordion-body"><div class="form-grid">
                <div><label>CIBIL</label><input type="number" id="cibil" class="pdf-data" data-label="CIBIL"></div>
                <div><label>Enquiries (3m)</label><input type="number" class="pdf-data" data-label="Enquiries"></div>
                <div><label>Unsecured Loans</label><input type="number" id="unsecLoans" class="pdf-data" data-label="Unsec Loans"></div>
            </div></div></div>

            <button class="btn" id="btnRun">âš¡ Check & Submit</button>
            <div id="resultArea"></div>
        </div>

        <div id="dashView" style="display:none;">
            <h3>My History</h3>
            <table style="width:100%; background:white;" id="historyTable"><thead><tr><th>Date</th><th>Customer</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <script type="module">
        // 1. PASTE CONFIG
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            // apiKey: "...",
            // ...
        };

        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e){}

        const user = JSON.parse(sessionStorage.getItem('active_dsa_user'));
        if(!user) window.location.href="index.html";
        document.getElementById('welcomeMsg').innerText = `Welcome, ${user.name}`;

        window.logoutUser = () => { sessionStorage.removeItem('active_dsa_user'); window.location.href="index.html"; };

        document.getElementById('btnRun').onclick = async () => {
            let data = {};
            document.querySelectorAll('.pdf-data').forEach(e => data[e.getAttribute('data-label')] = e.value);
            
            // Capture Bank Stmts
            let stmts = []; document.querySelectorAll('.bank-opt.selected').forEach(e=>stmts.push(e.innerText));
            data['Bank Statements'] = stmts.join(', ');

            // Run Logic (Simplified for brevity - assumes logic works)
            let eligible = [];
            if(+data['Turnover'] > 20) eligible.push("Tata Capital"); // Dummy logic

            let status = eligible.length > 0 ? "Eligible" : "Declined";
            document.getElementById('resultArea').innerHTML = `<h3>${status}</h3>`;

            // SAVE TO CLOUD
            await addDoc(collection(db, "applications"), {
                date: new Date().toLocaleDateString(),
                customer: data['Business Name'],
                dsaName: user.name,
                dsaUsername: user.user,
                status: status,
                data: data // Saves all 29 fields
            });
            alert("Application Saved!");
        };

        window.loadHistory = async () => {
            document.getElementById('appView').style.display='none';
            document.getElementById('dashView').style.display='block';
            
            const q = query(collection(db, "applications"), where("dsaUsername", "==", user.user));
            const snap = await getDocs(q);
            
            const t = document.querySelector('#historyTable tbody'); t.innerHTML='';
            snap.forEach(d => {
                const v = d.data();
                t.innerHTML += `<tr><td>${v.date}</td><td>${v.customer}</td><td>${v.status}</td></tr>`;
            });
        };
    </script>
</body>
</html>
