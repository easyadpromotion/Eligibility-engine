<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Engine Pro - Final Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1a237e; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .accordion { background: white; border-radius: 8px; margin-bottom: 15px; }
        .accordion-header { padding: 15px; font-weight: 600; cursor: pointer; border-bottom: 1px solid #eee; }
        .accordion-body { padding: 20px; display: none; }
        .accordion-body.open { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background: #2e7d32; color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; }
        .report-btn { width: 100%; padding: 15px; background: #0288d1; color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 10px; display: none; }
        
        .bank-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .bank-opt { padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 13px; background: #fff; }
        .bank-opt.selected { background-color: #1a237e; color: white; border-color: #1a237e; }
        .hidden-field { display: none; background-color: #fafafa; padding: 10px; border: 1px dashed #ccc; margin-top: 5px; }

        /* REPORT MODAL */
        #fullReportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .report-paper { background: white; width: 900px; height: 90vh; overflow-y: auto; padding: 40px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px; margin-bottom: 20px; }
        
        @media print { 
            #fullReportModal { display: block; background: white; } 
            .no-print { display: none; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>Credit Engine</h3>
    <p>New Application</p>
</div>

<div class="main-content">
    <h2>New Loan Application</h2>
    <div style="text-align:right; font-size:12px; font-weight:bold; color:green;">Active Policies: <span id="pCount">0</span></div>

    <div class="accordion">
        <div class="accordion-header" onclick="toggle('s1')">1. Business Details</div>
        <div id="s1" class="accordion-body open">
            <div class="form-grid">
                <div><label>Customer Name</label><input type="text" id="bizName" class="pdf-data" data-label="Business Name"></div>
                <div><label>Contact Number</label><input type="number" id="contact" class="pdf-data" data-label="Contact"></div>
                <div><label>Vintage (Years)</label><input type="number" id="vintage" class="pdf-data" data-label="Vintage"></div>
                <div><label>Turnover (Lakhs)</label><input type="number" id="turnover" class="pdf-data" data-label="Turnover"></div>
                <div><label>Entity Type</label><select id="entity" class="pdf-data" data-label="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option><option>LLP</option></select></div>
                <div><label>Sector</label><select id="sector" class="pdf-data" data-label="Sector"><option value="Trading">Trading</option><option value="Manufacturing">Manufacturing</option><option value="Service">Service</option></select></div>
                <div><label>Premises</label><select id="premises" class="pdf-data" data-label="Premises"><option>Rented</option><option>Leased</option><option>Owned</option></select></div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header" onclick="toggle('s2')">2. Banking & Docs</div>
        <div id="s2" class="accordion-body">
            <div class="form-grid">
                <div><label>ABB (Rupees)</label><input type="number" id="abb" class="pdf-data" data-label="ABB"></div>
                <div>
                    <label>Bank Statements</label>
                    <div class="bank-options">
                        <div class="bank-opt" onclick="this.classList.toggle('selected')">SA</div>
                        <div class="bank-opt" onclick="this.classList.toggle('selected')">CA</div>
                        <div class="bank-opt" onclick="this.classList.toggle('selected')">OD</div>
                        <div class="bank-opt" onclick="this.classList.toggle('selected')">CC</div>
                    </div>
                </div>
                <div><label>GST Registered?</label><select id="gst" class="pdf-data" data-label="GST Reg" onchange="toggleField('gstBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                <div id="gstBox" class="hidden-field"><label>GST Turnover</label><input type="number" id="gstTurn" class="pdf-data" data-label="GST Turnover"></div>
                <div><label>ITR Filed?</label><select id="itr" class="pdf-data" data-label="ITR Filed" onchange="toggleField('itrBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                <div id="itrBox" class="hidden-field"><label>ITR Income</label><input type="number" id="itrInc" class="pdf-data" data-label="ITR Income"></div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header" onclick="toggle('s3')">3. Credit Profile</div>
        <div id="s3" class="accordion-body">
            <div class="form-grid">
                <div><label>CIBIL Score</label><input type="number" id="cibil" class="pdf-data" data-label="CIBIL"></div>
                <div><label>Active Loans</label><input type="number" id="actLoans" class="pdf-data" data-label="Active Loans"></div>
                <div><label>Monthly EMI</label><input type="number" id="emi" class="pdf-data" data-label="Monthly EMI"></div>
                <div><label>Reduced EMI</label><input type="number" id="redEmi" class="pdf-data" data-label="Reduced EMI"></div>
                <div><label>Unsecured Loans</label><input type="number" id="unsec" class="pdf-data" data-label="Unsecured Loans"></div>
                <div><label>Loans (Last 6m)</label><input type="number" id="l6m" class="pdf-data" data-label="Loans 6m"></div>
                <div><label>Loans Closing (6m)</label><input type="number" id="c6m" class="pdf-data" data-label="Closing 6m"></div>
                <div><label>Enquiries (3m)</label><input type="number" id="enq" class="pdf-data" data-label="Enquiries"></div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header" onclick="toggle('s4')">4. Applicant Details</div>
        <div id="s4" class="accordion-body">
            <div class="form-grid">
                <div><label>Age</label><input type="number" id="age" class="pdf-data" data-label="Age"></div>
                <div><label>Gender</label><select class="pdf-data" data-label="Gender"><option>Male</option><option>Female</option></select></div>
                <div><label>Co-Applicant?</label><select id="coApp" class="pdf-data" data-label="Co-App" onchange="toggleField('coBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                <div id="coBox" class="hidden-field"><label>Co-App Age</label><input type="number" id="coAge" class="pdf-data" data-label="Co-App Age"></div>
                <div><label>Own House?</label><select id="house" class="pdf-data" data-label="Own House" onchange="toggleField('houseBox', this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
                <div id="houseBox" class="hidden-field"><label>Pincode</label><input type="number" class="pdf-data" data-label="Pincode"></div>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header" onclick="toggle('s5')">5. Loan Requirement</div>
        <div id="s5" class="accordion-body">
            <div class="form-grid">
                <div><label>Req Amount (Lakhs)</label><input type="number" id="reqAmt" class="pdf-data" data-label="Req Amount"></div>
                <div><label>Purpose</label><select class="pdf-data" data-label="Purpose"><option>Working Capital</option><option>Expansion</option><option>Asset Purchase</option></select></div>
            </div>
        </div>
    </div>

    <button class="submit-btn" onclick="runEngine()">Check Eligibility</button>
    <button class="report-btn" id="dlBtn" onclick="openPDF()">Download Report</button>
    <div id="resArea"></div>
</div>

<div id="fullReportModal">
    <div class="report-paper">
        <div class="no-print" style="text-align:right;">
            <button onclick="document.getElementById('fullReportModal').style.display='none'">Close</button>
            <button onclick="window.print()">Print</button>
        </div>
        <h2 style="text-align:center;">PROVISIONAL OFFER</h2>
        <p><strong>Customer:</strong> <span id="pdfName"></span></p>
        <div class="details-grid" id="pdfDetails"></div>
        
        <h3 style="background:#eee; padding:5px;">ELIGIBILITY (ALL BANKS)</h3>
        <table class="report-table">
            <thead><tr><th>BANK NAME</th><th>PROGRAM</th><th>ELIGIBILITY LOAN AMOUNT</th><th>TENURE</th><th>ROI</th></tr></thead>
            <tbody id="pdfElig"></tbody>
        </table>
        
        <h3 style="background:#eee; padding:5px;">NOT ELIGIBLE</h3>
        <table class="report-table">
            <thead><tr><th>BANK NAME</th><th>REJECT PROGRAM</th><th>REMARKS</th><th>FINAL STATUS</th></tr></thead>
            <tbody id="pdfDecl"></tbody>
        </table>
    </div>
</div>

<script>
    function toggle(id) { document.getElementById(id).style.display = document.getElementById(id).style.display=='block'?'none':'block'; }
    function toggleField(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
    
    // --- 1. POLICIES UPDATED PER YOUR ADMIN SCREENSHOTS ---
    const defaultPolicies = [
        // Screenshot values for Standard Loans
        { bank: "TATA CAPITAL STBL", type:"STBL", minTurn:20, minCibil:700, maxUnsec:5, loanMax:20, tenMax:36, roiMin:20, roiMax:25 }, // 3L-20L
        { bank: "ADITYA BIRLA STBL", type:"STBL", minTurn:25, minCibil:700, maxUnsec:5, loanMax:20, tenMax:36, roiMin:17.5, roiMax:22 }, // 1L-20L
        { bank: "BAJAJ FINANCE TERM", type:"TERM", minTurn:40, minCibil:700, maxUnsec:5, loanMax:30, tenMax:48, roiMin:16.5, roiMax:21 }, // 5L-30L
        
        // Screenshot values for PIRAMAL UBL (Your specific request)
        { bank: "PIRAMAL CAPITAL UBL", type:"UBL", minTurn:30, minCibil:700, maxUnsec:"", loanMax:15, tenMax:36, roiMin:16, roiMax:24 }, // 1L-15L
        
        // Other Screenshot values
        { bank: "PIRAMAL CAPITAL UBL+", type:"UBL+", minTurn:100, minCibil:700, maxUnsec:5, loanMax:30, tenMax:48, roiMin:16.99, roiMax:21 }, // 15L-30L
        { bank: "TATA CAPITAL HTBL", type:"HTBL", minTurn:200, minCibil:700, maxUnsec:5, loanMax:50, tenMax:60, roiMin:18, roiMax:22 }, // 10L-50L
        { bank: "ADITYA BIRLA BIG TICKET", type:"HTBL", minTurn:250, minCibil:700, maxUnsec:5, loanMax:50, tenMax:60, roiMin:18.5, roiMax:23 }, // 5L-50L
        { bank: "ADITYA BIRLA DROP OD", type:"OD", minTurn:100, minCibil:700, maxUnsec:5, loanMax:50, tenMax:12, roiMin:12, roiMax:16 }, // 10L-50L
        { bank: "TATA CAPITAL DROP OD", type:"OD", minTurn:100, minCibil:700, maxUnsec:5, loanMax:50, tenMax:12, roiMin:12.5, roiMax:16 }, // 10L-50L
        { bank: "BAJAJ FINANCE FLEXI OD", type:"OD", minTurn:50, minCibil:700, maxUnsec:5, loanMax:25, tenMax:24, roiMin:14.5, roiMax:22 }, // 5L-25L
        { bank: "CLIX CAPITAL", type:"NBFC", minTurn:15, minCibil:700, maxUnsec:5, loanMax:20, tenMax:30, roiMin:21, roiMax:28 } // 1L-20L
    ];

    // Priority: Try to load from Admin (if saved), else use Defaults
    let policies = JSON.parse(localStorage.getItem('credit_engine_db'));
    if (!policies || policies.length === 0) { policies = defaultPolicies; }
    document.getElementById('pCount').innerText = policies.length;

    let eligible = [], declined = [];

    function calcPV(rate, nper, pmt) {
        if(rate===0) return pmt*nper;
        return pmt * (1 - Math.pow(1+rate, -nper)) / rate;
    }

    function runEngine() {
        eligible = []; declined = [];
        // Inputs
        let turn = parseFloat(document.getElementById('turnover').value)||0;
        let vin = parseFloat(document.getElementById('vintage').value)||0;
        let cibil = parseFloat(document.getElementById('cibil').value)||0;
        let abb = parseFloat(document.getElementById('abb').value)||0;
        let unsec = parseFloat(document.getElementById('unsec').value)||0;
        let emi = parseFloat(document.getElementById('emi').value)||0;
        let redEmi = parseFloat(document.getElementById('redEmi').value)||0;
        
        let margin = document.getElementById('sector').value == 'Trading' ? 0.07 : 0.09;
        let netInc = ((turn*100000)/12 * margin) - Math.max(0, emi-redEmi);

        policies.forEach(p => {
            let pass = true;
            let reason = "";

            // Check Rules (Turnover, CIBIL, Vintage)
            if(turn < p.minTurn) { pass=false; reason=`Turnover < ${p.minTurn}L`; }
            else if(cibil < p.minCibil) { pass=false; reason=`CIBIL < ${p.minCibil}`; }
            else if(p.maxUnsec !== "" && unsec > p.maxUnsec) { pass=false; reason=`Unsec > ${p.maxUnsec}`; }

            if(pass) {
                let r = (p.roiMin/100)/12;
                // Calculate Raw Eligibility (ABB vs Income)
                let loanABB = calcPV(r, p.tenMax, abb*2.5); 
                let loanInc = calcPV(r, p.tenMax, netInc);
                let rawAmount = Math.max(loanABB, loanInc);
                
                // --- CRITICAL CAPPING LOGIC (Use p.loanMax from the Policy) ---
                let finalAmount = Math.min(rawAmount, p.loanMax * 100000); 

                // Minimum Check (e.g. if bank min is 1L)
                if(finalAmount < 100000) { 
                    pass=false; reason="Eligible Amount < 1L"; 
                }

                if(pass) {
                    eligible.push({ 
                        bank: p.bank || p.bankName, 
                        prog: p.type || p.prodType, 
                        amt: (finalAmount/100000).toFixed(2), 
                        ten: p.tenMax, 
                        roi: `${p.roiMin}-${p.roiMax}` 
                    });
                } else {
                    declined.push({ bank: p.bank || p.bankName, reason: reason });
                }
            } else {
                declined.push({ bank: p.bank || p.bankName, reason: reason });
            }
        });

        document.getElementById('resArea').innerHTML = `<h3>Found ${eligible.length} Eligible Banks</h3>`;
        document.getElementById('dlBtn').style.display = 'block';
    }

    function openPDF() {
        document.getElementById('pdfName').innerText = document.getElementById('bizName').value;
        
        let det = "";
        document.querySelectorAll('.pdf-data').forEach(el => {
            if(el.offsetParent !== null && el.value) {
                det += `<div class="detail-item"><strong>${el.getAttribute('data-label')}:</strong> ${el.value}</div>`;
            }
        });
        document.getElementById('pdfDetails').innerHTML = det;

        let h = "";
        eligible.forEach(e => h+=`<tr><td>${e.bank}</td><td>${e.prog}</td><td>â‚¹${e.amt} L</td><td>${e.ten}m</td><td>${e.roi}%</td></tr>`);
        document.getElementById('pdfElig').innerHTML = h || "<tr><td colspan='5'>No Eligible Offers</td></tr>";
        
        let d = "";
        declined.forEach(x => d+=`<tr><td>${x.bank}</td><td>${x.reason}</td><td>Failed Policy</td><td style='color:red'>DECLINED</td></tr>`);
        document.getElementById('pdfDecl').innerHTML = d || "<tr><td colspan='4'>No Rejections</td></tr>";
        
        document.getElementById('fullReportModal').style.display='flex';
    }
</script>
</body>
</html>
