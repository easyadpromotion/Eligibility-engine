<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Portal - Functional</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1a237e; color: white; display: flex; flex-direction: column; padding: 20px; }
        .nav-item { padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; }
        .nav-item.active { background-color: #3949ab; border-left: 4px solid #ffeb3b; }
        .main-wrapper { flex: 1; padding: 30px; overflow-y: auto; }
        
        .view-section { display: none; }
        .view-section.active-view { display: block; }
        
        .accordion { background: white; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .accordion-header { padding: 15px; background: #fff; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; color: #1a237e; }
        .accordion-body { padding: 20px; display: none; }
        .accordion-body.open { display: block; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        
        .btn { padding: 15px; width: 100%; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-check { background: #2e7d32; }
        .btn-dl { background: #0288d1; display: none; }
        
        /* DASHBOARD TABLES */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: left; }
        
        /* PDF MODAL */
        #pdfModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; }
        .pdf-paper { background: white; width: 800px; margin: 30px auto; padding: 40px; }
        @media print { body > * { display: none; } #pdfModal { display: block; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>DSA Portal</h3>
    <div class="nav-item active" onclick="switchView('appView', this)">ðŸ“„ New Application</div>
    <div class="nav-item" onclick="switchView('dashView', this)">ðŸ“Š Dashboard</div>
</div>

<div class="main-wrapper">
    
    <div id="appView" class="view-section active-view">
        <h2>New Loan Application</h2>
        
        <div class="accordion">
            <div class="accordion-header" onclick="toggleSection('s1')">1. Business Details</div>
            <div id="s1" class="accordion-body open">
                <div class="form-grid">
                    <div><label>Business Name</label><input type="text" id="bizName"></div>
                    <div><label>Vintage (Yrs)</label><input type="number" id="vintage"></div>
                    <div><label>Turnover (â‚¹ Lakhs)</label><input type="number" id="turnover"></div>
                    <div><label>Entity</label><select><option>Proprietorship</option><option>Pvt Ltd</option></select></div>
                    <div><label>Sector</label><select id="sector"><option value="Trading">Trading</option><option value="Manufacturing">Manufacturing</option></select></div>
                    <div><label>Premises</label><select><option>Owned</option><option>Rented</option></select></div>
                </div>
            </div>
        </div>

        <div class="accordion">
            <div class="accordion-header" onclick="toggleSection('s2')">2. Banking & Docs</div>
            <div id="s2" class="accordion-body">
                <div class="form-grid">
                    <div><label>ABB (Avg Balance)</label><input type="number" id="abb"></div>
                    <div><label>Bank Statements</label><select><option>Savings</option><option>Current</option><option>OD/CC</option></select></div>
                    <div><label>GST Registered?</label><select><option>Yes</option><option>No</option></select></div>
                    <div><label>ITR Filed?</label><select><option>Yes</option><option>No</option></select></div>
                </div>
            </div>
        </div>

        <div class="accordion">
            <div class="accordion-header" onclick="toggleSection('s3')">3. Credit Profile</div>
            <div id="s3" class="accordion-body">
                <div class="form-grid">
                    <div><label>CIBIL Score</label><input type="number" id="cibil"></div>
                    <div><label>Total EMI</label><input type="number" id="emi"></div>
                    <div><label>Unsecured Loans</label><input type="number" id="unsec"></div>
                    <div><label>Enquiries (3m)</label><input type="number" id="enq"></div>
                </div>
            </div>
        </div>
        
        <div class="accordion">
            <div class="accordion-header" onclick="toggleSection('s4')">4. Applicant Details</div>
            <div id="s4" class="accordion-body">
                <div class="form-grid">
                    <div><label>Age</label><input type="number" id="age"></div>
                    <div><label>Co-Applicant?</label><select><option>Yes</option><option>No</option></select></div>
                    <div><label>Own House Pincode</label><input type="number" id="pincode"></div>
                </div>
            </div>
        </div>

        <div class="accordion">
            <div class="accordion-header" onclick="toggleSection('s5')">5. Loan Requirement</div>
            <div id="s5" class="accordion-body">
                <div class="form-grid">
                    <div><label>Required Amount</label><input type="number" id="reqAmt"></div>
                    <div><label>Tenure Preference</label><input type="number" id="reqTenure"></div>
                </div>
            </div>
        </div>

        <button class="btn btn-check" onclick="runEngine()">âš¡ Check Eligibility</button>
        <button class="btn btn-dl" id="dlBtn" onclick="generatePDF()">ðŸ“„ Download Offer Letter</button>
        <div id="resArea" style="margin-top:20px;"></div>
    </div>

    <div id="dashView" class="view-section">
        <h2>Dashboard</h2>
        
        <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>Application History</h3>
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Customer</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="background:white; padding:20px; border-radius:8px;">
            <h3>Update Credentials</h3>
            <div class="form-grid">
                <div><label>New Password</label><input type="password" id="newPass"></div>
                <div><label>Confirm Password</label><input type="password" id="confPass"></div>
            </div>
            <button class="btn btn-check" style="width:auto; margin-top:15px;" onclick="updateCreds()">Update Password</button>
        </div>
    </div>

</div>

<div id="pdfModal">
    <div class="pdf-paper">
        <div class="no-print" style="text-align:right;">
            <button onclick="document.getElementById('pdfModal').style.display='none'">Close</button>
            <button onclick="window.print()">Print</button>
        </div>
        <h2 style="text-align:center;">PROVISIONAL OFFER LETTER</h2>
        <p><strong>Customer:</strong> <span id="pdfName"></span></p>
        <p><strong>Date:</strong> <span id="pdfDate"></span></p>
        <hr>
        <div id="pdfContent"></div>
    </div>
</div>

<script>
    // --- 1. DATA & STATE ---
    let appHistory = JSON.parse(localStorage.getItem('dsa_history')) || [];
    
    // THE 11 POLICIES
    const policies = [
        { name: "TATA CAPITAL STBL", turn: 20 }, { name: "ADITYA BIRLA STBL", turn: 25 },
        { name: "BAJAJ FINANCE TERM", turn: 40 }, { name: "TATA CAPITAL HTBL", turn: 200 },
        { name: "ADITYA BIRLA BIG TICKET", turn: 250 }, { name: "PIRAMAL CAPITAL UBL", turn: 30 },
        { name: "PIRAMAL CAPITAL UBL+", turn: 100 }, { name: "ADITYA BIRLA DROP OD", turn: 100 },
        { name: "TATA CAPITAL DROP OD", turn: 100 }, { name: "BAJAJ FINANCE FLEXI OD", turn: 50 },
        { name: "CLIX CAPITAL", turn: 15 }
    ];

    let currentOffers = [];

    // --- 2. ENGINE LOGIC ---
    function runEngine() {
        const turnover = parseFloat(document.getElementById('turnover').value) || 0;
        const name = document.getElementById('bizName').value || "Customer";
        
        currentOffers = []; // Reset
        
        policies.forEach(p => {
            if(turnover >= p.minTurn) {
                currentOffers.push({ bank: p.name, amt: (turnover * 0.2).toFixed(2), status: "Eligible" });
            } else {
                currentOffers.push({ bank: p.name, amt: 0, status: "Declined (Low Turnover)" });
            }
        });

        // Save to History
        const app = { 
            date: new Date().toLocaleDateString(), 
            name: name, 
            amt: turnover, 
            status: currentOffers.some(o => o.status === "Eligible") ? "Eligible" : "Declined",
            details: currentOffers // Save the specific offers for re-download
        };
        
        appHistory.push(app);
        localStorage.setItem('dsa_history', JSON.stringify(appHistory));
        renderHistory();

        // UI Update
        document.getElementById('resArea').innerHTML = `<h3>Found ${currentOffers.filter(o=>o.status==='Eligible').length} Offers</h3>`;
        document.getElementById('dlBtn').style.display = 'block';
    }

    // --- 3. DASHBOARD FUNCTIONS ---
    function renderHistory() {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        appHistory.forEach((app, idx) => {
            tbody.innerHTML += `
            <tr>
                <td>${app.date}</td><td>${app.name}</td><td>â‚¹${app.amt} L</td>
                <td style="color:${app.status==='Eligible'?'green':'red'}">${app.status}</td>
                <td>
                    <button style="cursor:pointer;" onclick="reDownload(${idx})">View/PDF</button>
                </td>
            </tr>`;
        });
    }

    function reDownload(index) {
        // Load data from history into the PDF generator
        const app = appHistory[index];
        currentOffers = app.details;
        document.getElementById('bizName').value = app.name; // simple hack to set name for PDF
        generatePDF();
    }

    function updateCreds() {
        const p1 = document.getElementById('newPass').value;
        const p2 = document.getElementById('confPass').value;
        if(p1 && p1 === p2) {
            alert("Credentials Updated Successfully!");
            document.getElementById('newPass').value = "";
            document.getElementById('confPass').value = "";
        } else {
            alert("Passwords do not match or are empty.");
        }
    }

    // --- 4. PDF GENERATOR ---
    function generatePDF() {
        document.getElementById('pdfName').innerText = document.getElementById('bizName').value;
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
        
        let html = `<table style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <tr style="background:#eee;"><th>Bank</th><th>Amount</th><th>Status</th></tr>`;
        
        currentOffers.forEach(o => {
            html += `<tr>
                        <td style="border:1px solid #ddd; padding:8px;">${o.bank}</td>
                        <td style="border:1px solid #ddd; padding:8px;">â‚¹${o.amt} Lakhs</td>
                        <td style="border:1px solid #ddd; padding:8px; color:${o.status==='Eligible'?'green':'red'}">${o.status}</td>
                     </tr>`;
        });
        html += `</table>`;
        
        document.getElementById('pdfContent').innerHTML = html;
        document.getElementById('pdfModal').style.display = 'block';
    }

    // --- 5. UI HELPERS ---
    function switchView(id, btn) {
        document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'dashView') renderHistory();
    }
    
    function toggleSection(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display==='block') ? 'none' : 'block';
    }

    // Initial Load
    renderHistory();

</script>
</body>
</html>
