<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Credit Engine Pro - User</title>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  /* MAIN LAYOUT */
Â  Â  Â  Â  body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; height: 100vh; }
Â  Â  Â  Â  .sidebar { width: 260px; background-color: #1a237e; color: white; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; }
Â  Â  Â  Â  .main-content { flex: 1; padding: 30px; overflow-y: auto; }

Â  Â  Â  Â  /* NAVIGATION */
Â  Â  Â  Â  .nav-item { padding: 14px 15px; margin-bottom: 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; font-size: 15px; display: flex; align-items: center; gap: 10px; }
Â  Â  Â  Â  .nav-item:hover { background-color: #3949ab; }
Â  Â  Â  Â  .nav-item.active { background-color: #3949ab; border-left: 5px solid #ffeb3b; font-weight: 600; }

Â  Â  Â  Â  /* FORMS */
Â  Â  Â  Â  .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; }
Â  Â  Â  Â  .accordion { background: white; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
Â  Â  Â  Â  .accordion-header { padding: 18px 25px; font-weight: 600; cursor: pointer; border-bottom: 1px solid #f0f0f0; background: #fff; border-radius: 10px 10px 0 0; }
Â  Â  Â  Â  .accordion-body { padding: 25px; display: none; } .accordion-body.open { display: block; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
Â  Â  Â  Â  .auto-filled { background-color: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; font-weight: bold; }

Â  Â  Â  Â  /* BANK OPTIONS */
Â  Â  Â  Â  .bank-options { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; padding-bottom: 5px; }
Â  Â  Â  Â  .bank-opt { padding: 12px 24px; border: 1px solid #ddd; border-radius: 30px; cursor: pointer; font-weight: 600; background: #fff; transition: 0.2s; min-width: 50px; text-align: center; }
Â  Â  Â  Â  .bank-opt:hover { background: #f5f5f5; }
Â  Â  Â  Â  .bank-opt.selected { background-color: #1a237e; color: white; border-color: #1a237e; }

Â  Â  Â  Â  /* BUTTONS */
Â  Â  Â  Â  .submit-btn { width: 100%; padding: 16px; background-color: #2e7d32; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .report-btn { width: 100%; padding: 16px; background-color: #0288d1; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; display: none; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
Â  Â  Â  Â  .btn-view { background: #1a237e; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; border: none; }

Â  Â  Â  Â  /* DASHBOARD TABLE */
Â  Â  Â  Â  .dash-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
Â  Â  Â  Â  .dash-table th, .dash-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  .dash-table th { background-color: #f8f9fa; color: #333; font-weight: bold; }
Â  Â  Â  Â  .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
Â  Â  Â  Â  .status-eligible { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
Â  Â  Â  Â  .status-declined { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

Â  Â  Â  Â  /* PDF MODAL */
Â  Â  Â  Â  #fullReportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
Â  Â  Â  Â  .report-paper { background: white; width: 850px; margin: 0 auto; padding: 40px; border-radius: 8px; font-family: Arial, sans-serif; min-height: 80vh; position: relative; }
Â  Â  Â  Â  .report-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
Â  Â  Â  Â  .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #333; font-size: 12px; }
Â  Â  Â  Â  .report-table th, .report-table td { border: 1px solid #333; padding: 8px; text-align: center; }
Â  Â  Â  Â  .report-table th { background: #f0f0f0; }
Â  Â  Â  Â  .details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; background: #fafafa; }
Â  Â  Â  Â  .detail-item { font-size: 13px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; }
Â  Â  Â  Â  .hidden-field { display:none; background:#f8f9fa; padding:15px; border:1px dashed #ccc; margin-top:10px; }

Â  Â  Â  Â  @media print {Â 
Â  Â  Â  Â  Â  Â  .no-print { display: none !important; }Â 
Â  Â  Â  Â  Â  Â  #fullReportModal { position: absolute; background: white; width: 100%; height: 100%; top:0; left:0; margin:0; padding:0; z-index: 9999; }Â 
Â  Â  Â  Â  Â  Â  .report-paper { width: 100%; max-width: 100%; box-shadow: none; margin: 0; }
Â  Â  Â  Â  Â  Â  body > *:not(#fullReportModal) { display: none; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <div class="sidebar">
Â  Â  Â  Â  <h2 style="margin-bottom: 40px;">ğŸš€ DSA Portal</h2>
Â  Â  Â  Â  <div class="nav-item active" id="nav-app" onclick="switchView('appView')">ğŸ“„ New Application</div>
Â  Â  Â  Â  <div class="nav-item" id="nav-dash" onclick="switchView('dashView')">ğŸ“Š Dashboard</div>
Â  Â  Â  Â  <div class="nav-item" style="margin-top:auto; background:#d32f2f;" onclick="logoutUser()">ğŸšª Logout</div>
Â  Â  </div>

Â  Â  <div class="main-content">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <h2 id="welcomeMsg">Welcome</h2>
Â  Â  Â  Â  Â  Â  <div style="color:#1a237e; font-weight:bold;">Shield: <span id="policyCount">Loading...</span> Active</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="appView">
Â  Â  Â  Â  Â  Â  <div class="accordion"><div class="accordion-header" onclick="toggle(this)">1. Business Details</div><div class="accordion-body open"><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Name</label><input type="text" class="pdf-data" data-label="Business Name" id="bizName"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Contact</label><input type="number" class="pdf-data" data-label="Contact"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Vintage (Yrs)</label><input type="number" class="pdf-data" data-label="Vintage"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Turnover (Lakhs)</label><input type="number" class="pdf-data" data-label="Turnover" placeholder="e.g. 120"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Entity</label><select class="pdf-data" data-label="Entity"><option>Proprietorship</option><option>Partnership</option><option>Pvt Ltd</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Sector</label><select class="pdf-data" data-label="Sector" id="sector"><option value="Trading">Trading (7%)</option><option value="Manufacturing">Manufacturing (9%)</option><option value="Service">Service (11%)</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Premises</label><select class="pdf-data" data-label="Premises"><option>Owned</option><option>Rented</option></select></div>
Â  Â  Â  Â  Â  Â  </div></div></div>

Â  Â  Â  Â  Â  Â  <div class="accordion"><div class="accordion-header" onclick="toggle(this)">2. Banking & Docs</div><div class="accordion-body"><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>ABB (Avg Balance)</label><input type="number" class="pdf-data" data-label="ABB"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="grid-column: span 2;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Bank Statements Available</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bank-options">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bank-opt" onclick="this.classList.toggle('selected')">SA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bank-opt" onclick="this.classList.toggle('selected')">CA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bank-opt" onclick="this.classList.toggle('selected')">OD</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="bank-opt" onclick="this.classList.toggle('selected')">CC</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>GST Registered?</label><select class="pdf-data" data-label="GST Reg" onchange="toggleField('gstBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div><div id="gstBox" class="hidden-field"><label>GST Turnover</label><input type="number" class="pdf-data" data-label="GST Turnover"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>ITR Filed?</label><select class="pdf-data" data-label="ITR Filed" onchange="toggleField('itrBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div><div id="itrBox" class="hidden-field"><label>ITR Income</label><input type="number" class="pdf-data" data-label="ITR Income"></div>
Â  Â  Â  Â  Â  Â  </div></div></div>

Â  Â  Â  Â  Â  Â  <div class="accordion"><div class="accordion-header" onclick="toggle(this)">3. Credit Profile</div><div class="accordion-body"><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>CIBIL Score</label><input type="number" class="pdf-data" data-label="CIBIL"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Active Loans</label><input type="number" class="pdf-data" data-label="Active Loans"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Monthly EMI</label><input type="number" class="pdf-data" data-label="Monthly EMI" id="monthlyEmi"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Unsec Loans</label><input type="number" class="pdf-data" data-label="Unsec Loans"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Loans (6m)</label><input type="number" class="pdf-data" data-label="Loans (6m)"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Enquiries (3m)</label><input type="number" class="pdf-data" data-label="Enquiries"></div>
Â  Â  Â  Â  Â  Â  </div></div></div>

Â  Â  Â  Â  Â  Â  <div class="accordion"><div class="accordion-header" onclick="toggle(this)">4. Applicant Details</div><div class="accordion-body"><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Age</label><input type="number" class="pdf-data" data-label="Age"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Gender</label><select class="pdf-data" data-label="Gender"><option>Male</option><option>Female</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Co-Applicant?</label><select class="pdf-data" data-label="Co-App" onchange="toggleField('coBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div><div id="coBox" class="hidden-field"><label>Co-App Age</label><input type="number" class="pdf-data" data-label="Co-App Age"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>House?</label><select class="pdf-data" data-label="Own House" onchange="toggleField('houseBox',this.value==='Yes')"><option>No</option><option>Yes</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="houseBox" class="hidden-field" style="display:none; grid-column: span 3; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Pincode (Type 6 Digits)</label><input type="number" class="pdf-data" data-label="Pincode" id="pincodeInput" oninput="checkPincode()"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>City</label><input type="text" class="pdf-data auto-filled" data-label="City" id="cityField"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label>State</label><input type="text" class="pdf-data auto-filled" data-label="State" id="stateField"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div></div></div>

Â  Â  Â  Â  Â  Â  <div class="accordion"><div class="accordion-header" onclick="toggle(this)">5. Requirement</div><div class="accordion-body"><div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Req Amount (Lakhs)</label><input type="number" class="pdf-data" data-label="Req Amount"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label>Purpose</label><input type="text" class="pdf-data" data-label="Purpose"></div>
Â  Â  Â  Â  Â  Â  </div></div></div>

Â  Â  Â  Â  Â  Â  <button class="submit-btn" onclick="runEligibilityEngine()">âš¡ Check Eligibility</button>
Â  Â  Â  Â  Â  Â  <button class="report-btn" id="dlReportBtn" onclick="generateFullPDF()">ğŸ“„ Download Offer Letter</button>
Â  Â  Â  Â  Â  Â  <div id="resultsArea" style="margin-top:20px;"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="dashView" style="display:none;">
Â  Â  Â  Â  Â  Â  <h2>DSA Dashboard</h2>
Â  Â  Â  Â  Â  Â  <div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‚ Application History</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <table class="dash-table" id="historyTable"><thead><tr><th>Date</th><th>Customer</th><th>Status</th><th>View</th></tr></thead><tbody></tbody></table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="background:white;padding:20px;border-radius:10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ” Change Password</h3><input type="password" id="new_pass" placeholder="New Password" style="width:100%;margin-bottom:10px;padding:10px;"><button class="submit-btn" style="margin-top:0;width:auto;" onclick="updateCredentials()">Update</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="fullReportModal"><div class="report-paper">
Â  Â  Â  Â  <div class="no-print" style="text-align:right; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('fullReportModal').style.display='none'" style="padding:8px 16px; cursor:pointer;">Close</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="padding:8px 16px; background:#0288d1; color:white; border:none; cursor:pointer; margin-left:10px;">Print / Save PDF</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-header">
Â  Â  Â  Â  Â  Â  <h2>PROVISIONAL OFFER LETTER</h2>
Â  Â  Â  Â  Â  Â  <h3>Customer: <span id="pdfCustomerName"></span></h3>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-section-title" style="font-weight:bold; margin-bottom:10px;">APPLICATION DETAILS</div>
Â  Â  Â  Â  <div id="pdfAppDetails" class="details-grid"></div>
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <div class="report-section-title" style="font-weight:bold; margin-bottom:10px;">ELIGIBILITY SUMMARY</div>
Â  Â  Â  Â  <table class="report-table">
Â  Â  Â  Â  Â  Â  <thead><tr><th>BANK</th><th>PROGRAM</th><th>LOAN AMOUNT</th><th>TENURE</th><th>ROI</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody id="pdfEligibleTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <div class="report-section-title" style="font-weight:bold; margin-bottom:10px;">DECLINED BANKS</div>
Â  Â  Â  Â  <table class="report-table">
Â  Â  Â  Â  Â  Â  <thead><tr><th>BANK</th><th>REASON</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody id="pdfRejectTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div></div>

Â  Â  <script>
Â  Â  Â  Â  // --- 1. FIREBASE CONFIG ---
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAvzpBo0AXbytsGMBmbpMHqOxRs_iY2EsI",
Â  Â  Â  Â  Â  Â  authDomain: "credir-engine-new.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "credir-engine-new",
Â  Â  Â  Â  Â  Â  storageBucket: "credir-engine-new.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "249073295308",
Â  Â  Â  Â  Â  Â  appId: "1:249073295308:web:e3db899190a4d2506d0769",
Â  Â  Â  Â  Â  Â  measurementId: "G-YBXMM1J129"
Â  Â  Â  Â  };

Â  Â  Â  Â  let db;
Â  Â  Â  Â  try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch(e) { console.error("FB Error:",e); }

Â  Â  Â  Â  // --- 2. AUTH & INIT ---
Â  Â  Â  Â  const user = JSON.parse(sessionStorage.getItem('active_dsa_user'));
Â  Â  Â  Â  if(!user) window.location.href = "index.html";
Â  Â  Â  Â  document.getElementById('welcomeMsg').innerText = `Welcome, ${user.name}`;

Â  Â  Â  Â  if(db) db.collection('policies').get().then(snap => document.getElementById('policyCount').innerText = snap.size);

Â  Â  Â  Â  // --- 3. GLOBAL VARS FOR PDF ---
Â  Â  Â  Â  window.historyData = [];
Â  Â  Â  Â  window.latestResults = { eligible: [], declined: [] };
Â  Â  Â  Â  window.latestData = {};

Â  Â  Â  Â  function switchView(v){
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
Â  Â  Â  Â  Â  Â  if(v==='appView') document.getElementById('nav-app').classList.add('active');
Â  Â  Â  Â  Â  Â  if(v==='dashView') document.getElementById('nav-dash').classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('appView').style.display = v==='appView'?'block':'none';
Â  Â  Â  Â  Â  Â  document.getElementById('dashView').style.display = v==='dashView'?'block':'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(v==='dashView') loadHistory();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function toggle(el){ el.nextElementSibling.classList.toggle('open'); }
Â  Â  Â  Â  function toggleField(id,s){Â 
Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  if(id === 'houseBox' && s) el.style.display = 'grid';Â 
Â  Â  Â  Â  Â  Â  else el.style.display=s?'block':'none';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  function logoutUser(){ if(confirm("Logout?")){sessionStorage.removeItem('active_dsa_user');window.location.href="index.html";} }

Â  Â  Â  Â  // --- 4. PINCODE AUTO-FILL ---
Â  Â  Â  Â  async function checkPincode() {
Â  Â  Â  Â  Â  Â  const pin = document.getElementById('pincodeInput').value;
Â  Â  Â  Â  Â  Â  if(pin.length === 6) {
Â  Â  Â  Â  Â  Â  Â  Â  const cF = document.getElementById('cityField');
Â  Â  Â  Â  Â  Â  Â  Â  const sF = document.getElementById('stateField');
Â  Â  Â  Â  Â  Â  Â  Â  cF.value = "Fetching..."; sF.value = "...";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(data[0].Status === "Success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const info = data[0].PostOffice[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.value = info.District;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sF.value = info.State;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.value = "Not Found"; sF.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Allow manual entry if not found
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.removeAttribute('readonly'); sF.removeAttribute('readonly');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.classList.remove('auto-filled'); sF.classList.remove('auto-filled');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.value = ""; sF.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cF.removeAttribute('readonly'); sF.removeAttribute('readonly');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 5. CALCULATION ENGINE ---
Â  Â  Â  Â  function calculatePV(rate, nper, pmt) {
Â  Â  Â  Â  Â  Â  if (rate === 0) return pmt * nper;
Â  Â  Â  Â  Â  Â  return pmt * (1 - Math.pow(1 + rate, -nper)) / rate;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function runEligibilityEngine() {
Â  Â  Â  Â  Â  Â  let data = {};
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.pdf-data').forEach(el => data[el.getAttribute('data-label')] = el.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clean Turnover Input (remove commas)
Â  Â  Â  Â  Â  Â  let rawTurn = data['Turnover'] || "0";
Â  Â  Â  Â  Â  Â  rawTurn = rawTurn.replace(/,/g, '');
Â  Â  Â  Â  Â  Â  const turn = parseFloat(rawTurn) * 100000; // Convert Lakhs to Absolute

Â  Â  Â  Â  Â  Â  let bankStmts = [];
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.bank-opt.selected').forEach(el => bankStmts.push(el.innerText));
Â  Â  Â  Â  Â  Â  data['Bank Statements'] = bankStmts.join(', ');
Â  Â  Â  Â  Â  Â  data['DSA Name'] = user.name;Â 
Â  Â  Â  Â  Â  Â  data['DSA Username'] = user.user;

Â  Â  Â  Â  Â  Â  const sectorVal = document.getElementById('sector').value.split(' ')[0];
Â  Â  Â  Â  Â  Â  const margins = { "Trading": 0.07, "Manufacturing": 0.09, "Service": 0.11 };
Â  Â  Â  Â  Â  Â  const margin = margins[sectorVal] || 0.07;

Â  Â  Â  Â  Â  Â  const abb = parseFloat(data['ABB']) || 0;
Â  Â  Â  Â  Â  Â  const cibil = parseFloat(data['CIBIL']) || 0;
Â  Â  Â  Â  Â  Â  const emi = parseFloat(data['Monthly EMI']) || 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const monthlyProfit = (turn / 12) * margin;
Â  Â  Â  Â  Â  Â  const obligations = Math.max(0, emi);Â 
Â  Â  Â  Â  Â  Â  const netIncome = Math.max(0, monthlyProfit - obligations);

Â  Â  Â  Â  Â  Â  let policies = [];
Â  Â  Â  Â  Â  Â  if(db) { const snap = await db.collection("policies").get(); policies = snap.docs.map(d => d.data()); }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let eligible = [], declined = [];

Â  Â  Â  Â  Â  Â  if(policies.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No Policies loaded. Please ask Admin to 'Load Defaults'.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  policies.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  let pass = true, reasons = [];
Â  Â  Â  Â  Â  Â  Â  Â  // GATE CHECKS
Â  Â  Â  Â  Â  Â  Â  Â  if (parseFloat(data['Vintage']) < (p.minVin||0)) { pass=false; reasons.push(`Vintage < ${p.minVin}`); }
Â  Â  Â  Â  Â  Â  Â  Â  if ((turn/100000) < (p.minTurn||0)) { pass=false; reasons.push(`Turnover < ${p.minTurn}L`); }
Â  Â  Â  Â  Â  Â  Â  Â  if (abb < (p.abbMin||0)) { pass=false; reasons.push(`ABB < ${p.abbMin}`); }
Â  Â  Â  Â  Â  Â  Â  Â  if (p.gstReq==='Yes' && data['GST Reg']!=='Yes') { pass=false; reasons.push("GST Required"); }
Â  Â  Â  Â  Â  Â  Â  Â  if (p.itrReq==='Yes' && data['ITR Filed']!=='Yes') { pass=false; reasons.push("ITR Required"); }
Â  Â  Â  Â  Â  Â  Â  Â  if (cibil < (p.minCibil||0)) { pass=false; reasons.push(`CIBIL < ${p.minCibil}`); }
Â  Â  Â  Â  Â  Â  Â  Â  if (parseFloat(data['Age']) < (p.ageMin||18)) { pass=false; reasons.push(`Age < ${p.ageMin}`); }

Â  Â  Â  Â  Â  Â  Â  Â  if (pass) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = (p.roiMin / 100) / 12;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const n = p.tenMax || 36;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let dscrAmt = calculatePV(r, n, netIncome);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let abbAmt = calculatePV(r, n, abb);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalAmt = Math.max(dscrAmt, abbAmt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let policyMax = (p.loanMax || 50) * 100000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let policyMin = (p.loanMin || 1) * 100000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalAmt = Math.min(finalAmt, policyMax);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (finalAmt >= policyMin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eligible.push({ bank: p.bankName, prog: p.prodType, amt: (finalAmt / 100000).toFixed(2), ten: n, roi: `${p.roiMin}-${p.roiMax}%` });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  declined.push({ bank: p.bankName, reason: `Eligible Amount (${(finalAmt/100000).toFixed(2)}L) < Bank Min (${p.loanMin}L)` });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  declined.push({ bank: p.bankName, reason: reasons.join(", ") });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const results = {eligible, declined};
Â  Â  Â  Â  Â  Â  const status = eligible.length > 0 ? "Eligible" : "Declined";
Â  Â  Â  Â  Â  Â  document.getElementById('resultsArea').innerHTML = `<h3 style="color:${status==='Eligible'?'green':'red'}">${status} (${eligible.length} Banks)</h3>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // SAVE GLOBALS FOR PDF
Â  Â  Â  Â  Â  Â  window.latestResults = results;Â 
Â  Â  Â  Â  Â  Â  window.latestData = data;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(db) db.collection("applications").add({
Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toLocaleDateString(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  customer: data['Business Name'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  dsaName: user.name,Â 
Â  Â  Â  Â  Â  Â  Â  Â  dsaUsername: user.user,Â 
Â  Â  Â  Â  Â  Â  Â  Â  status: status,Â 
Â  Â  Â  Â  Â  Â  Â  Â  data: data,Â 
Â  Â  Â  Â  Â  Â  Â  Â  results: results
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('dlReportBtn').style.display='block';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 6. PDF GENERATOR (FAIL-SAFE) ---
Â  Â  Â  Â  function generateFullPDF() {
Â  Â  Â  Â  Â  Â  // Retrieve data
Â  Â  Â  Â  Â  Â  const res = window.latestResults;
Â  Â  Â  Â  Â  Â  const data = window.latestData;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Check if data is available
Â  Â  Â  Â  Â  Â  if (!data || Object.keys(data).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // If clicked from empty state, check input fields as fallback
Â  Â  Â  Â  Â  Â  Â  Â  const nameInput = document.getElementById('bizName').value;
Â  Â  Â  Â  Â  Â  Â  Â  if(nameInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Please click 'Check Eligibility' first to calculate results.");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("No data found. Please Run Eligibility or Select from Dashboard.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('pdfCustomerName').innerText = data['Business Name'] || "Valued Customer";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Build Details Grid
Â  Â  Â  Â  Â  Â  let detailsHtml = "";
Â  Â  Â  Â  Â  Â  for(const [key, val] of Object.entries(data)) {
Â  Â  Â  Â  Â  Â  Â  Â  if(val && key !== 'DSA Username') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detailsHtml += `<div class="detail-item"><strong>${key}:</strong> ${val}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('pdfAppDetails').innerHTML = detailsHtml;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Build Eligible Table
Â  Â  Â  Â  Â  Â  const eTable = document.getElementById('pdfEligibleTable');
Â  Â  Â  Â  Â  Â  if (res && res.eligible && res.eligible.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  eTable.innerHTML = res.eligible.map(i =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<tr><td>${i.bank}</td><td>${i.prog}</td><td>â‚¹${i.amt} Lakhs</td><td>${i.ten} m</td><td>${i.roi}</td></tr>`
Â  Â  Â  Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  eTable.innerHTML = `<tr><td colspan='5' style="padding:20px;">No Eligible Banks Found based on current criteria.</td></tr>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Build Reject Table
Â  Â  Â  Â  Â  Â  const rTable = document.getElementById('pdfRejectTable');
Â  Â  Â  Â  Â  Â  if (res && res.declined && res.declined.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  rTable.innerHTML = res.declined.map(i =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<tr><td>${i.bank}</td><td>${i.reason}</td></tr>`
Â  Â  Â  Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  rTable.innerHTML = `<tr><td colspan='2'>No Rejections</td></tr>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('fullReportModal').style.display='block';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 7. DASHBOARD VIEW ---
Â  Â  Â  Â  async function loadHistory() {
Â  Â  Â  Â  Â  Â  const t = document.querySelector('#historyTable tbody');Â 
Â  Â  Â  Â  Â  Â  t.innerHTML="<tr><td colspan='4'>Loading history...</td></tr>";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  window.historyData = []; // Reset local cache
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(db) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snap = await db.collection("applications")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .where("dsaUsername", "==", user.user)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .orderBy("date", "desc") // Optional sorting
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(snap.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.innerHTML = "<tr><td colspan='4'>No applications found.</td></tr>";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.docs.forEach((doc, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const v = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.historyData.push(v); // Push to global array
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.customer}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${v.status==='Eligible'?'status-eligible':'status-declined'}">${v.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><button class="btn-view" onclick="viewHistory(${index})">View</button></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("History Load Error:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback for indexing error if composite index missing
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snap = await db.collection("applications").where("dsaUsername", "==", user.user).get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.docs.forEach((doc, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const v = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.historyData.push(v);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.customer}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${v.status==='Eligible'?'status-eligible':'status-declined'}">${v.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><button class="btn-view" onclick="viewHistory(${index})">View</button></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Function called by View button
Â  Â  Â  Â  window.viewHistory = (index) => {
Â  Â  Â  Â  Â  Â  const item = window.historyData[index];
Â  Â  Â  Â  Â  Â  if(item) {
Â  Â  Â  Â  Â  Â  Â  Â  window.latestData = item.data;
Â  Â  Â  Â  Â  Â  Â  Â  window.latestResults = item.results;
Â  Â  Â  Â  Â  Â  Â  Â  generateFullPDF(); // Trigger PDF modal immediately
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Error loading application data.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  async function updateCredentials() {
Â  Â  Â  Â  Â  Â  const p = document.getElementById('new_pass').value;
Â  Â  Â  Â  Â  Â  if(!p) return alert("Enter password");
Â  Â  Â  Â  Â  Â  if(db) {
Â  Â  Â  Â  Â  Â  Â  Â  const snap = await db.collection("dsa_users").where("user", "==", user.user).get();
Â  Â  Â  Â  Â  Â  Â  Â  if(!snap.empty) { snap.docs[0].ref.update({ pass: p }); alert("Updated!"); logoutUser(); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
